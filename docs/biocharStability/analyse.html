<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.2"/>
    <title>biocharStability.analyse Documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../biocharStability.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;biocharStability</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#singleExp">singleExp</a>
            </li>
            <li>
                    <a class="function" href="#k_singleExp">k_singleExp</a>
            </li>
            <li>
                    <a class="function" href="#singleExp_u">singleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#k_singleExp_u">k_singleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#doubleExp">doubleExp</a>
            </li>
            <li>
                    <a class="function" href="#k_doubleExp">k_doubleExp</a>
            </li>
            <li>
                    <a class="function" href="#doubleExp_u">doubleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#k_doubleExp_u">k_doubleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#tripleExp">tripleExp</a>
            </li>
            <li>
                    <a class="function" href="#k_tripleExp">k_tripleExp</a>
            </li>
            <li>
                    <a class="function" href="#tripleExp_u">tripleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#k_tripleExp_u">k_tripleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#powerModel">powerModel</a>
            </li>
            <li>
                    <a class="function" href="#k_powerModel">k_powerModel</a>
            </li>
            <li>
                    <a class="function" href="#powerModel_lim">powerModel_lim</a>
            </li>
            <li>
                    <a class="function" href="#powerModel_q10">powerModel_q10</a>
            </li>
            <li>
                    <a class="function" href="#singleExp_u_lmfit">singleExp_u_lmfit</a>
            </li>
            <li>
                    <a class="function" href="#doubleExp_u_lmfit">doubleExp_u_lmfit</a>
            </li>
            <li>
                    <a class="function" href="#rsquare">rsquare</a>
            </li>
            <li>
                    <a class="function" href="#lmfit_fitting_stats">lmfit_fitting_stats</a>
            </li>
            <li>
                    <a class="function" href="#pretty_covariance">pretty_covariance</a>
            </li>
            <li>
                    <a class="function" href="#print_fitting_report">print_fitting_report</a>
            </li>
            <li>
                    <a class="function" href="#do_the_fit">do_the_fit</a>
            </li>
            <li>
                    <a class="function" href="#do_the_lmfit">do_the_lmfit</a>
            </li>
            <li>
                    <a class="function" href="#fit_all_observations">fit_all_observations</a>
            </li>
            <li>
                    <a class="function" href="#load_fitted_observations">load_fitted_observations</a>
            </li>
            <li>
                    <a class="function" href="#applyQ10">applyQ10</a>
            </li>
            <li>
                    <a class="function" href="#fit_Q10_data">fit_Q10_data</a>
            </li>
            <li>
                    <a class="function" href="#Q10">Q10</a>
            </li>
            <li>
                    <a class="function" href="#fT_Woolf">fT_Woolf</a>
            </li>
            <li>
                    <a class="function" href="#fT_WoolfStepwise">fT_WoolfStepwise</a>
            </li>
            <li>
                    <a class="function" href="#fT_DataFit">fT_DataFit</a>
            </li>
            <li>
                    <a class="function" href="#applyTempCorr">applyTempCorr</a>
            </li>
            <li>
                    <a class="function" href="#select_best_fit">select_best_fit</a>
            </li>
            <li>
                    <a class="function" href="#std_singleExp">std_singleExp</a>
            </li>
            <li>
                    <a class="function" href="#std_singleExp_u">std_singleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#std_doubleExp">std_doubleExp</a>
            </li>
            <li>
                    <a class="function" href="#std_doubleExp_u">std_doubleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#std_tripleExp">std_tripleExp</a>
            </li>
            <li>
                    <a class="function" href="#std_tripleExp_u">std_tripleExp_u</a>
            </li>
            <li>
                    <a class="function" href="#std_powerModel">std_powerModel</a>
            </li>
            <li>
                    <a class="function" href="#std_fmodel">std_fmodel</a>
            </li>
            <li>
                    <a class="function" href="#rebuild_cov2">rebuild_cov2</a>
            </li>
            <li>
                    <a class="function" href="#apply_Q10_bis">apply_Q10_bis</a>
            </li>
            <li>
                    <a class="function" href="#correlation_linear">correlation_linear</a>
            </li>
            <li>
                    <a class="function" href="#linear">linear</a>
            </li>
            <li>
                    <a class="function" href="#std_linear">std_linear</a>
            </li>
            <li>
                    <a class="function" href="#calc_correlation_timeseries">calc_correlation_timeseries</a>
            </li>
            <li>
                    <a class="function" href="#plot_correlation_timeseries">plot_correlation_timeseries</a>
            </li>
            <li>
                    <a class="function" href="#pick_model">pick_model</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../biocharStability.html">biocharStability</a><wbr>.analyse    </h1>

                        <div class="docstring"><p>-<em>- coding: utf-8 -</em>-</p>

<p>biochar stability / analyse.py</p>

<p>set of utility functions to analyse the data - i.e. performing curve fitting on the data timeseries, apply Q10 temperature correction, calculate uncertainties on curve fits, build correlation models, ...</p>
</div>

                        <input id="analyse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="analyse-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">-*- coding: utf-8 -*-</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">biochar stability / analyse.py</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">set of utility functions to analyse the data - i.e. performing curve fitting on the data timeseries, apply Q10 temperature correction, calculate uncertainties on curve fits, build correlation models, ...</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">zoomed_inset_axes</span><span class="p">,</span> <span class="n">inset_axes</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getfullargspec</span><span class="p">,</span> <span class="n">signature</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="kn">import</span> <span class="n">durbin_watson</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Parameters</span><span class="p">,</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">fit_report</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="kn">import</span> <span class="n">durbin_watson</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">import</span> <span class="nn">ternary</span> <span class="k">as</span> <span class="nn">ter</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">adjustText</span> <span class="kn">import</span> <span class="n">adjust_text</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">make_column_selector</span> <span class="k">as</span> <span class="n">selector</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">RobustScaler</span><span class="p">,</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">explained_variance_score</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="c1"># The model function, f(x, â€¦). It must take the independent variable as the first argument and the parameters to fit as separate remaining arguments.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="n">model_names</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>    <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span><span class="s1">&#39;S0&#39;</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>    <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span><span class="s1">&#39;D0&#39;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span><span class="s1">&#39;T0&#39;</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span><span class="s1">&#39;D&#39;</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span><span class="s1">&#39;T&#39;</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span><span class="s1">&#39;POW&#39;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="p">}</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="c1">## MODEL FUNCTIONS</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="k">def</span> <span class="nf">singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="k">def</span> <span class="nf">k_singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="k">def</span> <span class="nf">singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>    <span class="k">return</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="k">def</span> <span class="nf">k_singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="k">def</span> <span class="nf">doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="k">def</span> <span class="nf">k_doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="k">def</span> <span class="nf">doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="k">def</span> <span class="nf">k_doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="k">def</span> <span class="nf">tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="k">def</span> <span class="nf">k_tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="k">return</span> <span class="p">(</span> <span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="k">def</span> <span class="nf">tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="k">def</span> <span class="nf">k_tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="k">def</span> <span class="nf">powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="c1"># as defined in Zimmerman 2011</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="k">return</span> <span class="n">z</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="k">def</span> <span class="nf">k_powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="c1"># as defined in Zimmerman 2011</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="k">def</span> <span class="nf">powerModel_lim</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mi">365</span><span class="p">):</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">    This function cannot be used in curve fitting step. Instead, curve fitting should be done with bs.powerModel.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    Then, the fitted parameters on bs.PowerModel are used to calculate the extrapolation with the assumption that the decay rates decreases only for L years.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">    </span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">    - L = 10*365 # days</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">    </span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="c1"># yes, t is an array of values</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="n">t_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="n">t_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">L</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t_before</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_before</span><span class="p">))</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t_before</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="n">kL</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">1.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="n">zL</span> <span class="o">=</span> <span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="n">z_after</span> <span class="o">=</span> <span class="n">zL</span> <span class="o">+</span> <span class="n">kL</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_after</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_before</span><span class="p">,</span> <span class="n">z_after</span><span class="p">)</span> <span class="c1"># append, not add </span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="c1"># no, t is a single value</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">L</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>            <span class="c1"># t &gt;= L </span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="n">kL</span> <span class="o">=</span> <span class="p">(</span><span class="n">zL</span><span class="o">-</span><span class="n">zLn</span><span class="p">)</span><span class="o">/</span><span class="mf">1.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">zL</span> <span class="o">+</span> <span class="n">kL</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>    <span class="k">return</span> <span class="n">z</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="k">def</span> <span class="nf">powerModel_q10</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>    <span class="c1"># as defined in Zimmerman 2011, with own recalculation for a different temperature based on k --&gt; k*fT + re-integrate</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>    <span class="c1">#print(m)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="k">elif</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>    <span class="k">return</span> <span class="n">z</span> 
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="n">map_model_function</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="s2">&quot;singleExp&quot;</span><span class="p">:</span><span class="n">singleExp</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>    <span class="s2">&quot;singleExp_u&quot;</span><span class="p">:</span><span class="n">singleExp_u</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>    <span class="s2">&quot;doubleExp&quot;</span><span class="p">:</span><span class="n">doubleExp</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>    <span class="s2">&quot;doubleExp_u&quot;</span><span class="p">:</span><span class="n">doubleExp_u</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>    <span class="s2">&quot;tripleExp&quot;</span><span class="p">:</span><span class="n">tripleExp</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>    <span class="s2">&quot;tripleExp_u&quot;</span><span class="p">:</span><span class="n">tripleExp_u</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>    <span class="s2">&quot;powerModel&quot;</span><span class="p">:</span><span class="n">powerModel</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="p">}</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="c1">## MODEL FUNCTIONS FOR LMFIT -- NOT NEEDED ANYMORE</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="k">def</span> <span class="nf">singleExp_u_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>    <span class="k">return</span> <span class="n">y_fit</span> <span class="o">-</span> <span class="n">y</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="k">def</span> <span class="nf">doubleExp_u_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">]</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="c1">#print(c1.value, c2.value, k1.value, k2.value)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="c1">#print(y_fit-y)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="k">return</span> <span class="n">y_fit</span> <span class="o">-</span> <span class="n">y</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="c1"># some curve fitting metrics &amp; stats</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="k">def</span> <span class="nf">rsquare</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">popt</span><span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>    <span class="sd">&#39;&#39;&#39;Computes R-square value for given fit</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">    Input: \n</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">        - f : model function, callable</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        - xdata: array</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        - ydata: array</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        - popt: returned by curve_fit</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">    Returns: \n</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">        - r2</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">        - residuals</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="c1"># &#39;*&#39; needed to unpack it (kwargs)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>    <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ydata</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>    
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="n">rs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">ss_res</span><span class="o">/</span><span class="n">ss_tot</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="k">return</span> <span class="n">rs</span><span class="p">,</span> <span class="n">residuals</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="k">def</span> <span class="nf">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">popt</span><span class="p">):</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>    <span class="sd">&#39;&#39;&#39;Computes the fitting statistics (chi-square, reduced chi square, AIC, BIC) for a given fit, as implemented in lmfit </span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">    (source: https://github.com/lmfit/lmfit-py/blob/master/lmfit/minimizer.py line 364)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">    Input: \n</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        - f : model function, callable</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">        - xdata: array</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        - ydata: array</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">        - popt: returned by curve_fit</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">    Outputs: \n</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">        - chisqr</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">        - redchisqr</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">        - AIC</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        - BIC</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">        </span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">    Usage: \n</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">        residuals, chisqr, redchisqr, aic, bic = lmfit_fitting_stats(f, xdata, ydata, popt)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">        </span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="c1"># residuals</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="n">chisqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># sum-squared residuals</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span> <span class="c1"># nb of data points</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="n">nvarys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># nb of param in f function</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>    <span class="n">nfree</span> <span class="o">=</span> <span class="n">ndata</span> <span class="o">-</span> <span class="n">nvarys</span> <span class="c1"># degree of freedom: ndata - nparameters in the f function (i.e. nb args - 1 (since 1st arg is time))</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>    <span class="n">redchisqr</span> <span class="o">=</span> <span class="n">chisqr</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfree</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>    <span class="n">chisqr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">chisqr</span><span class="p">,</span> <span class="mf">1.e-250</span><span class="o">*</span><span class="n">ndata</span><span class="p">)</span> <span class="c1"># modify chisqr value, if chisqr is 0, to be safe in the log</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>    <span class="n">_neg2_log_likel</span> <span class="o">=</span> <span class="n">ndata</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">chisqr</span> <span class="o">/</span> <span class="n">ndata</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>    <span class="n">aic</span> <span class="o">=</span> <span class="n">_neg2_log_likel</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nvarys</span> <span class="c1"># AIC</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="n">bic</span> <span class="o">=</span> <span class="n">_neg2_log_likel</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span> <span class="o">*</span> <span class="n">nvarys</span> <span class="c1"># BIC</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>    
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="k">return</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>   
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="k">def</span> <span class="nf">pretty_covariance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">    Save a pretty covariance matrix as a table, with header names, in wide (matrix) and long dataframes</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">    Usage:\n</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">        df_matrix, df_long = pretty_covariance(f, p_cov)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># list of parameters, popping out first element (time)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>    <span class="n">df_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">p_cov</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="n">df_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">])</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>    
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    <span class="k">return</span> <span class="n">df_matrix</span><span class="p">,</span> <span class="n">df_long</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="k">def</span> <span class="nf">print_fitting_report</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">    Similar to LMFIT report \n</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        [[Fit Statistics]]</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">            # fitting method   = Nelder-Mead</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">            # function evals   = 491</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">            # data points      = 44</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">            # variables        = 4</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">            chi-square         = 3.87297297 </span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">            reduced chi-square = 0.09682432 </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">            Akaike info crit   = -98.9273573</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">            Bayesian info crit = -91.7905988</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        [[Variables]]</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">            k1:  1.1683e-05 +/- 5.1274e-07 (4.39%) (init = 0)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">            k2:  4.47275357 +/- 1.84402220 (41.23%) (init = 0)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">            c1:  97.6338853 +/- 0.07100370 (0.07%) (init = 0)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">            c2:  2.36617997 +/- 0.31931764 (13.50%) (init = 0)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">        [[Correlations]] (unreported correlations are &lt; 0.100)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">            C(k1, c1) = 0.729</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">            C(k2, c2) = 0.387</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">            C(c1, c2) = -0.222</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">            C(k1, c2) = -0.162</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">            C(k2, c1) = 0.110</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span> <span class="o">=</span> <span class="n">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>    <span class="n">df_matrix</span><span class="p">,</span> <span class="n">df_long</span> <span class="o">=</span> <span class="n">pretty_covariance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>    
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Fit Statistics]]&quot;</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    # data points: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    # variables: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_opt</span><span class="p">))</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    chi-square: &quot;</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    reduced chi-square: &quot;</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Akaike info crit: &quot;</span><span class="p">,</span> <span class="n">aic</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Bayesian info crit: &quot;</span><span class="p">,</span> <span class="n">bic</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Variables]]&quot;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>    <span class="c1"># for loop - standard deviations, absolute values</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> +/- </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> %)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span><span class="o">/</span><span class="n">p_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> <span class="p">))</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Correlations]] (unreported correlations are &lt; 0.100)&quot;</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    <span class="c1"># for loop - correlations, normalised as in lmfit</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="n">correls</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="n">corr</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span><span class="n">p2</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                <span class="n">correls</span><span class="p">[</span><span class="n">p1</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="n">p2</span><span class="p">]</span><span class="o">=</span> <span class="n">corr</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>    <span class="n">sort_correls</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">correls</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="n">sort_correls</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">sort_correls</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">corr</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    C(</span><span class="si">{}</span><span class="s2">) = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="c1">### SCIPY CURVE FITTING</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="k">def</span> <span class="nf">do_the_fit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">doubleExp</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="sd">&#39;&#39;&#39; Does the fitting for one observation, and returns the parameters of interest, using scipy.curve_fit</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">    Inputs: \n</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        - f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel </span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        - xdata: timesteps array, in days</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">        - ydata: decay array</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        - p0: initial guess for optimal parameters, in curve_vit, otherwise set to 1</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        - method: algorithm for fitting in curve_fit, {lm, trf, dogbox},</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        - bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">                Here, parameters are either: doubleExp: 0&lt;k1,k2&lt;c1&lt;100</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">                                             singleExp: 0&lt;k&lt;c&lt;100</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">                                             linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">                TO DO: pass bounds with the function choice?</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        </span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">        - fitted paramters, </span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        - standard deviation of parameters, aboslute and relative</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        - covariance matrix of fitted parameters</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">        - scaled correlations between parameters</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">        - stability estimates as BC100, apparent MRT, half-life </span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        - r2 of fit (whether relevant or not)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">        - other statisical indicator, chi, ... </span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">        - residuals of fit </span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        - outcome of simple checks (passed failed)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">    Usage:  \n</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        p_opt, p_cov, p_std, r2, stab_dict = do_the_fit(f_model=doubleExp, xdata, ydata, p0=None, method=None, bounds=(-1*np.inf, np.inf))</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">    </span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="c1"># Fitting</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="n">fitting_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span> <span class="c1"># for testing on single observations</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                                 <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="n">full_output</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                                 <span class="c1"># sigma=ydata*0.05 ## to add noise/error on ydata</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="k">return</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span>  <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                                 <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                                 <span class="c1"># sigma=ydata*0.05 ## to add noise/error on ydata</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>        <span class="n">df_matrix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pretty_covariance</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="n">p_names</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># p_names[0] = time, p_names[1:] = all other parameters, in same order as p_opt</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>            <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%/day&#39;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="k">elif</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;na&#39;</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span><span class="o">/</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> 
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span><span class="n">p2</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                    
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="c1"># Other parameters</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">f_opt</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="c1"># fitted curve</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">p_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">p_cov</span><span class="p">))</span> <span class="c1"># Standard deviation of each parameter  </span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">r2</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">rsquare</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span> <span class="o">=</span> <span class="n">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="n">DW</span> <span class="o">=</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r2</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;chisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chisqr</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;redchisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">redchisqr</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;aic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">aic</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bic</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;dw&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DW</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">residuals</span> <span class="c1"># vector, likely not to save in an Excel table</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="c1"># Physical checks</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="k">def</span> <span class="nf">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all decay rates have a positive value&#39;&#39;&#39;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">def</span> <span class="nf">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a positive value&#39;&#39;&#39;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="k">def</span> <span class="nf">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a value below 100%&#39;&#39;&#39;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="k">def</span> <span class="nf">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="sd">&#39;&#39;&#39;Calculates the total C at time = 0. Ideally should be as close as possible to 100%&#39;&#39;&#39;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">def</span> <span class="nf">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">df_matrix</span><span class="p">):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all parameters have a abs stdev smaller than absolute value of param</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">                i.e. np.abs(stdev) &lt; np.aps(param)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>                    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="k">def</span> <span class="nf">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">odm</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="sd">&#39;&#39;&#39;For exponential models only, with multiple pools, verifies that the decay rates have at least n order of magnitude difference when expressed in %/year</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>                    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># conversion to %/year, from %/day</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>                            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes below100&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter constrained&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">df_matrix</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates 1 odm diff&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="c1"># Stability values</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="n">t100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">365</span> <span class="c1"># 100 years in days</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">BC100</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># remaning after 100 years</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">def</span> <span class="nf">f12</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">50.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="n">t12</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">f12</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># half-life time, 50% C remaining</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="n">t12</span> <span class="o">=</span> <span class="n">t12</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="k">def</span> <span class="nf">fMRT</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">fMRT</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># apparent MRT, np.exp(-1) = 36.8% C remaining</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BC100</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;t12&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;MRTa&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="n">stab_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BC100&#39;</span><span class="p">:</span> <span class="n">BC100</span><span class="p">,</span> 
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>                     <span class="s1">&#39;t12&#39;</span><span class="p">:</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="c1"># in years</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                     <span class="s1">&#39;MRTa&#39;</span><span class="p">:</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span> <span class="c1"># in years</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                    <span class="p">}</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="n">print_fitting_report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="o">=</span><span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="o">=</span><span class="n">p_cov</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="k">return</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">p_std</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">stab_dict</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">fitting_output</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="c1"># RuntimeError: Optimal parameters not found: The maximum number of function evaluations is exceeded.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{}</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{}</span>   
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="c1">## LMFIT CURVE FITTING</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="k">def</span> <span class="nf">do_the_lmfit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">doubleExp_u</span><span class="p">,</span> 
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>               <span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trf&#39;</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>               <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>               <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>               <span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">    Does the fitting for one observation, and returns the parameters of interest, using lmfit.minimize</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">    Inputs: \n</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        - f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel </span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        - xdata: timesteps array, in days</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        - ydata: decay array</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        - bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">                Here, parameters are either: doubleExp: 0&lt;k1,k2,c1&lt;100</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">                                             singleExp: 0&lt;k&lt;c&lt;100</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">                                             linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">    </span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">    TODO: implement use of initial guess, via p0 - list of initial guesses, in params.add(ar, value=, vary=True)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="n">fitting_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>    <span class="n">pargs</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># removing the first one, which is always time, list</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>    <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">pargs</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>    <span class="k">def</span> <span class="nf">f_model_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>    <span class="n">fitted_params</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f_model_lmfit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>    <span class="n">p_opt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>    <span class="n">r2</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">rsquare</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    <span class="n">DW</span> <span class="o">=</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%/day&#39;</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="k">elif</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;na&#39;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="o">/</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">,</span> <span class="s1">&#39;covar&#39;</span><span class="p">):</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>    
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>   
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r2</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;chisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">chisqr</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;redchisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">redchi</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;aic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">aic</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">bic</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;dw&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DW</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">residuals</span> <span class="c1"># vector, likely not to save in an Excel table</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>    <span class="c1"># Physical checks</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="k">def</span> <span class="nf">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all decay rates have a positive value&#39;&#39;&#39;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>            <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    <span class="k">def</span> <span class="nf">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a positive value&#39;&#39;&#39;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>    <span class="k">def</span> <span class="nf">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a value below 100%&#39;&#39;&#39;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>    <span class="k">def</span> <span class="nf">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="sd">&#39;&#39;&#39;Calculates the total C at time = 0. Ideally should be as close as possible to 100%&#39;&#39;&#39;</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>    
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="k">def</span> <span class="nf">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">):</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all parameters have a abs stdev smaller than absolute value of param</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">            i.e. np.abs(stdev) &lt; np.aps(param)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="n">stdev</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="k">if</span> <span class="n">stdev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="k">def</span> <span class="nf">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">odm</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>            <span class="sd">&#39;&#39;&#39;For exponential models only, with multiple pools, verifies that the decay rates have at least n order of magnitude difference when expressed in %/year</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># conversion to %/year, from %/day</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_decay_positivity</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_positivity</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes below100&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_below100</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter constrained&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_stdev_constraint</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates 1 odm diff&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_k_odm_difference</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>    <span class="c1"># Stability values</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="n">t100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">365</span> <span class="c1"># 100 years in days</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>    <span class="n">BC100</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># remaning after 100 years</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="k">def</span> <span class="nf">f12</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">50.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="n">t12</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">f12</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># half-life time, 50% C remaining</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>    <span class="n">t12</span> <span class="o">=</span> <span class="n">t12</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>    
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    <span class="k">def</span> <span class="nf">fMRT</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>    <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">fMRT</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># apparent MRT, np.exp(-1) = 36.8% C remaining</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>    <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BC100</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;t12&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;MRTa&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>    <span class="c1"># Pretty printing all the statistical data</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">fit_report</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">))</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>    
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">]</span> 
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>    <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">L</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="k">return</span> <span class="n">fitting_output</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="k">def</span> <span class="nf">fit_all_observations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">observations</span><span class="o">=</span><span class="p">[],</span> <span class="n">fitting_strategies</span><span class="o">=</span><span class="p">[],</span> <span class="n">library</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;C_bc_rem_rel&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">excel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">    Applies the fitting_strategies to all passed observations, using the scipy curve_fit function, and returns an extensive report as a list of dictionnary, optionalled saved as an Excel file</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">    USAGE: \n </span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        df_scipy_fits = bs.fit_all_observations(data, metadata, fitting_strategies=fitting_strategies, library=&#39;scipy&#39;, variable=&#39;C_bc_rem_rel&#39;, factor=100, excel=&#39;scipy_allfits.xlsx&#39;) </span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>    <span class="n">all_fitting_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="n">observations</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">select_timeseries</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="k">continue</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitting_strategies</span><span class="p">):</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">f_model</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="k">if</span> <span class="n">library</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fitting_output</span> <span class="o">=</span> <span class="n">do_the_fit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>            <span class="k">elif</span> <span class="n">library</span> <span class="o">==</span> <span class="s1">&#39;lmfit&#39;</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                <span class="n">fitting_output</span> <span class="o">=</span> <span class="n">do_the_lmfit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Sorry, the fitting library is not know. Use either `scipy` or `lmfit` as keyworkd.&quot;</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="c1"># adding fitting_strategy information to the fitting output</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">library</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">method</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f_model</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bounds</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p0</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="n">all_fitting_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitting_output</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_fitting_outputs</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="n">new_col_order</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;observation&#39;</span><span class="p">])</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;strategy&#39;</span><span class="p">])</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parameter&#39;</span><span class="p">])</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;estimator&#39;</span><span class="p">])</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;goodness&#39;</span><span class="p">])</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;checks&#39;</span><span class="p">])</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stddev_abs&#39;</span><span class="p">])</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stddev_rel&#39;</span><span class="p">])</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">])</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;covariance&#39;</span><span class="p">])</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>    <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">new_col_order</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">])</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>    <span class="k">if</span> <span class="n">excel</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="k">def</span> <span class="nf">load_fitted_observations</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">    Load as a dataframe, a previously saved set of fitting_outputs saved as an excel file</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="c1">## Q10 Soil Temperature Corrections</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="k">def</span> <span class="nf">applyQ10</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">    Applies the Q10 re-calibration of soil temperature to a calculated BC100 value at a given soil temperature to the </span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">    target soil temperature tTs</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">    </span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">    Inputs: \n </span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">        - tTs: target soil temperature</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        - metadata: dataframe with incubation meta-data</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        - fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">    </span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">        - a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.  </span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>    <span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="sd">&#39;&#39;&#39;calculate Q10 factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        TO_DO: alternative: provide Q10 data, and calculate a relationship</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">tTs</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Ts</span><span class="o">-</span><span class="n">tTs</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>    
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="k">def</span> <span class="nf">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tTs</span><span class="o">-</span><span class="n">Ts</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>    
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>    <span class="n">FIT_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">]},</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span> <span class="c1"># k1, k2, k3, c1, c2</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c&#39;</span><span class="p">]},</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]},</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Not supported correction factor (t, c0, b, m)&#39;</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>    <span class="p">}</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>    
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>    <span class="n">list_Q10</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>    <span class="n">list_fT</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>    <span class="n">list_newBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>    <span class="n">list_oldBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>    
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="n">ID_OBS</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="c1">#print(i, ID_OBS)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="c1">#print(FIT_func)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="n">TS</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ID_OBS</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>        <span class="c1">#print(TS)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">oldBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="c1"># find the fitting parameters in fitted_params</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">fitparams</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="c1">#cal Q10 and fT</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="n">q10</span> <span class="o">=</span> <span class="n">Q10</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="n">list_Q10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q10</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>        <span class="n">ft</span> <span class="o">=</span> <span class="n">fT</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="n">list_fT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="c1"># apply correction to decay constants</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>            
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="c1"># not supported</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="c1"># copy previous value</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">ID_OBS</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="n">list_newBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBC100</span><span class="p">)</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="n">list_oldBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oldBC100</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="c1">#print(type(fitparams[&#39;k&#39;]))</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitparams</span><span class="p">),</span> <span class="s1">&#39;Q10: &#39;</span><span class="p">,</span> <span class="n">q10</span><span class="p">,</span> <span class="s1">&#39;fT: &#39;</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">oldBC100</span><span class="p">,</span> <span class="n">newBC100</span><span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>    
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="c1">#if i &gt; 2:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="c1">#    break</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;Q10&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_Q10</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;fT&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_fT</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;BC100c&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_newBC100</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>    <span class="k">return</span> <span class="n">df2</span> <span class="c1">#, list_oldBC100, list_newBC100</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="k">def</span> <span class="nf">fit_Q10_data</span><span class="p">():</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">    Fits a relationship between Q10 and soil temperature, based on experimental data compiled.</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">    </span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">    TODO: load Q10 data from excel, fit exponential model, return model parameters</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="c1">## OTHER TEMPERATURE ADJUSTMENT METHODS (added 2023-07)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="c1"># Woolf2021</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="sd">&#39;&#39;&#39;calculate Q10 average factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">T1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">T2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="k">def</span> <span class="nf">fT_Woolf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>    <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on integration presented in Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">T1</span> <span class="o">==</span> <span class="n">T2</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="c1"># step-wise Woolf2021</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="k">def</span> <span class="nf">fT_WoolfStepwise</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>    <span class="sd">&#39;&#39;&#39;Calculates the fT with Woolf2021 method and a stepwise approach&#39;&#39;&#39;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>    <span class="n">f</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>    <span class="n">sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">T1</span><span class="o">&lt;</span><span class="n">T2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">sign</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">*</span><span class="n">fT_Woolf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">sign</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>    <span class="k">return</span> <span class="n">f</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="c1"># Eye-fit on data</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="k">def</span> <span class="nf">fT_DataFit</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>    <span class="sd">&#39;&#39;&#39;from T1 to T2, using exponential relationship fitted on k_Y2 and Incubation temperature of whole dataset, by eye&#39;&#39;&#39;</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.0200</span><span class="o">*</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.0200</span><span class="o">*</span><span class="n">T1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="k">def</span> <span class="nf">applyTempCorr</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span><span class="p">,</span> <span class="n">TH</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fT_Woolf</span><span class="p">):</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">    Applies the re-calibration of soil temperature to a calculated BC_TH value at a given soil temperature to the </span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">    target soil temperature tTs</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">    </span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">    Inputs: \n </span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        - tTs: target soil temperature, in degree C</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        - TH: time horizon, in years</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        - fT: pass a function used to calculate fT, among the fT availables:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">                - fT_Woolf (or bs.fT_Woolf, if library is imported as bs)</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">                - fT_WoolfStepwise (or bs.)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">                - fT_DataFit (or bs.)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        - metadata: dataframe with incubation meta-data</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        - fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">    </span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        - a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.  </span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        - list_oldBC100: old values as list</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">        - list_newBC100: new values as list</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>    
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>    <span class="n">FIT_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">]},</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span> <span class="c1"># k1, k2, k3, c1, c2</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c&#39;</span><span class="p">]},</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]},</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Correction supported by separate function, powerModel_q10</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="p">}</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="n">list_fT</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>    <span class="n">list_newBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>    <span class="n">list_oldBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>    
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">ID_OBS</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="c1">#print(i, ID_OBS)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="c1">#print(FIT_func)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="n">TS</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ID_OBS</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="c1">#print(TS)</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="n">oldBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># find the fitting parameters in fitted_params</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">fitparams</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="c1">#calc fT</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="n">ft</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="n">list_fT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="c1"># apply correction to decay constants</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>            
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="c1"># not supported</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="c1"># copy previous value</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">ID_OBS</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">newBC100</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="n">list_newBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBC100</span><span class="p">)</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="n">list_oldBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oldBC100</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>    <span class="c1">#df2[(&#39;q10correction&#39;,&#39;Q10&#39;,&#39;1&#39;)] = list_Q10</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;fT&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_fT</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;BC_TH_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TH</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_TS_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tTs</span><span class="p">),</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_newBC100</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>    <span class="k">return</span> <span class="n">df2</span> <span class="p">,</span> <span class="n">list_oldBC100</span><span class="p">,</span> <span class="n">list_newBC100</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="c1">## BEST FIT SELECTION</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="k">def</span> <span class="nf">select_best_fit</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">model_pool</span><span class="o">=</span><span class="p">[],</span> <span class="n">checks</span><span class="o">=</span><span class="p">{},</span> <span class="n">spec_val</span><span class="o">=</span><span class="p">{},</span> <span class="n">rank</span><span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">saveExcel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">    Based on the passed criteria, selects for all observations available fitted_data a single best fit if it exists. </span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">    The criterias are:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">    1. `model_pool`: a list of model functions names (e.g. `singleExp`, `doubleExp`, `tripleExp`,...) that are considered, for the best fit (e.g. we can decide to exclude powerModel or singleExp)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">    2. `checks`: a dict of ohysical checks that must be passed, to be considered a potential best fit, e.g. {&#39;decay rates positive&#39;:TRUE}</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">    3. `spec_val`: any other key present in the fitdata data, e.g. {&#39;library&#39;:&#39;scipy&#39;} to work only with scipy and exclude lmfit </span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">    4. `rank`: a tuple, among remaining fits, select the one with lowest/highest score in given goodness indicator, e.g. (&#39;bic&#39;, True) means lowest BIC is best</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">    </span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">    Inputs:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">    - fitdata: a dataframe loaded from Excel, created by function `applyQ10` or `fit_all_observations` </span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">    - saveExcel: if False, does not save. Alternatively: give filepath to save to.</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">    </span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">    Outputs:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">    - dataframe, selected best fits for each observations, in same format as fitted_data; the dataframe is also saved as an Excel file (option)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">    - a list of ID_obs where no best fit was found</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">    </span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">    USAGE: \n</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        no_best, df_best = select_best_fit(fitdata, model_pool, checks, spec_val)</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">        </span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>    <span class="c1"># fitted df - remove the sub-levels of multi-index, for easier access to properties</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>    <span class="n">all_obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="c1"># apply model_pool filter</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_pool</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">model_pool</span><span class="p">)]</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="c1"># apply checks filter</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="c1"># apply spec_val filter</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_val</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">spec_val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>    
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>    
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>    <span class="c1"># ranking and best fit selection </span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">rank</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="n">df_best</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>    
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>    <span class="n">rem_obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_best</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>    <span class="n">no_best</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_obs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">rem_obs</span><span class="p">))</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="k">if</span> <span class="n">saveExcel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">df_best</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">saveExcel</span><span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>    <span class="k">return</span> <span class="n">no_best</span><span class="p">,</span> <span class="n">df_best</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="c1">## ERROR PROPAGATION for specific models</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="k">def</span> <span class="nf">std_singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        </span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">    See definition of `singleExp` for order of parameters</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="k">def</span> <span class="nf">std_singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">    See definition of `singleExp_u` for order of parameters</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="k">def</span> <span class="nf">std_doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">    calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">    See definition of `doubleExp_u` for order of parameters</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="k">def</span> <span class="nf">std_doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">    calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">    </span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="k">def</span> <span class="nf">std_tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">    calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">    </span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>    <span class="n">k3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>  <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="k">def</span> <span class="nf">std_tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">    calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>    <span class="n">k3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>    <span class="n">c3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c3</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="k">def</span> <span class="nf">std_powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">fT</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">    </span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>    <span class="n">c0</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="n">b</span> <span class="o">=</span>  <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>    <span class="n">m</span> <span class="o">=</span>  <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>  <span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="c1"># taken same as for m &gt; -1, since same equation but just a constant insert for time = 0 </span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>  <span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>    
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="k">def</span> <span class="nf">std_fmodel</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="n">doubleExp_u</span><span class="p">):</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">    Returns caculated propagated error for the given model, over the entire time range given (xdata)</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="n">singleExp</span><span class="p">:</span><span class="n">std_singleExp</span><span class="p">,</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="n">singleExp_u</span><span class="p">:</span><span class="n">std_singleExp_u</span><span class="p">,</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="n">doubleExp</span><span class="p">:</span><span class="n">std_doubleExp</span><span class="p">,</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="n">doubleExp_u</span><span class="p">:</span><span class="n">std_doubleExp_u</span><span class="p">,</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="n">tripleExp</span><span class="p">:</span><span class="n">std_tripleExp</span><span class="p">,</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="n">tripleExp_u</span><span class="p">:</span><span class="n">std_tripleExp_u</span><span class="p">,</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        <span class="n">powerModel</span><span class="p">:</span><span class="n">std_powerModel</span><span class="p">,</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="p">}</span> <span class="c1"># add other functions here, when calculated (by hand)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>    <span class="n">std_func</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">fmodel</span><span class="p">]</span>  
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">])</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="c1">## Linear Correlations - static</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">explained_variance_score</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="k">def</span> <span class="nf">rebuild_cov2</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">covar</span><span class="p">):</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">    Rebuild the covariance matrix, in correct order from data saved as Excel dataframe.</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">    &#39;&#39;&#39;</span>    
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>    <span class="n">f_params</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># excluding time</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>    <span class="n">param_values</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>    <span class="n">param_std_values</span> <span class="o">=</span> <span class="n">stdev</span><span class="o">.</span><span class="n">values</span> <span class="c1"># in same order as above</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>    <span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span> <span class="c1">#.droplevel(level=[0,2])</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>    
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>    <span class="k">def</span> <span class="nf">search_param</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="sd">&#39;&#39;&#39;Returns an integer, position of search of param in params&#39;&#39;&#39;</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>                <span class="k">return</span> <span class="n">s</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>    
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>    <span class="k">def</span> <span class="nf">search_covar</span><span class="p">(</span><span class="n">covar</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="sd">&#39;&#39;&#39;Returns an integer, position of search covariance in matrix&#39;&#39;&#39;</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>                <span class="k">return</span> <span class="n">s</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>    <span class="n">dicVal</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">param_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">}</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>    <span class="n">dicStdev</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">param_std_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">}</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="c1">#print(param_names, param_values, param_std_values)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>    <span class="c1">#print(&quot;dicStdev \n&quot;, dicStdev)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>    
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>    <span class="n">p_opt_values</span> <span class="o">=</span><span class="p">[</span><span class="n">dicVal</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>    
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="n">p_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)))</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)):</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)):</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>                <span class="n">p_cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dicStdev</span><span class="p">[</span><span class="n">f_params</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">f_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">f_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">search_covar</span><span class="p">(</span><span class="n">covar</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="n">p_cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covar</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>    
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>    <span class="k">return</span> <span class="n">f_params</span><span class="p">,</span> <span class="n">p_opt_values</span><span class="p">,</span> <span class="n">p_cov</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="k">def</span> <span class="nf">apply_Q10_bis</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">tTs</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">    Given an observation, its model function, its parameters, a given TH and TS, the function:</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">    - calculates BC_TH_TS remaining at any given TH and TS</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">    - calculates a propagaged error on BC_TH_TS based on fitting uncertainty of fitted params</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">    </span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">    IMPROVEMENT/TODO: at the moment, does not include uncertaity from the Q10 temperature correction (would need uncertainty in fit kT, Q10, as well as new derative calculations)</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">    </span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>    
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>    <span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="sd">&#39;&#39;&#39;calculate Q10 factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">        TO_DO: alternative: provide Q10 data, and calculate a relationship</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">tTs</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Ts</span><span class="o">-</span><span class="n">tTs</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>    
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>    <span class="k">def</span> <span class="nf">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tTs</span><span class="o">-</span><span class="n">Ts</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>    
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>    <span class="n">ft</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">Ts</span> <span class="o">==</span> <span class="n">tTs</span> <span class="k">else</span> <span class="n">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>    
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>    <span class="c1"># apply correction to decay constants</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>    <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k&#39;]], p_cov, singleExp)</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]],</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">singleExp</span><span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k&#39;], params[&#39;c&#39;]] , p_cov, singleExp_u)</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">singleExp_u</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">])</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], params[&#39;c1&#39;]] , p_cov, doubleExp)</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">doubleExp</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">])</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;]] , p_cov, doubleExp_u)</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">doubleExp_u</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">])</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], ft*params[&#39;k3&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;]] , p_cov, tripleExp)</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">tripleExp</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">])</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], ft*params[&#39;k3&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;], params[&#39;c3&#39;]] , p_cov, tripleExp_u)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">tripleExp_u</span><span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">powerModel</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="c1"># not supported</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>    <span class="k">return</span> <span class="n">newBC100</span><span class="p">,</span> <span class="n">sigmaBC100</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="k">def</span> <span class="nf">correlation_linear</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">,</span> <span class="n">Ts</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">Th</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ifig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trendline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trenderror</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wSigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">an</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">6</span><span class="p">)):</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">    Performs a linear correlation between the two variables x and y (which must be one column in either fitdata or metadata),</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">    for a given soil temperature and a time horizon (if relevant, usually the case, when calculating BC_t). </span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">    </span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">    Normal use case:</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">    - y=&#39;BC_Th_Ts&#39; will calculate amount of biochar C remaining at Th and Ts passed as argument; while x is usually taken from the metadata columns</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">    - x must be from a metadata column, e.g. H/C_org, H/C_tot, HHT, Carbon, Carbon, organic, or another accepted value (currently H/C_all only)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        - If `x = H/C_all`, then the metadata considered will be: H/C_org whenever available, and H/C_tot to bridge gaps.</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">    - At time of plotting, the function will return the number of observations dropped due to missing data. </span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">    - Selected `outliers` can be removed by specifying a list of ID_obs </span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">    - Plotting can be done in static manner, or interactive mode (with sliders)</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">    </span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>    <span class="n">obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>    <span class="c1"># exclude identified outliers specified in *outliers*</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>    <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="n">obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">)</span> <span class="c1"># change index to ID_obs, so that series have the same index</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># filter metadata for the observations in the model minus outliers</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span> <span class="c1"># filter metadata for the observations in the model</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;na&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span> <span class="c1"># replaces &#39;na&#39; strings by NaN, for correct handling </span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>    
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>    <span class="c1"># Make sure fitdata and sub_metadata have same index elements &amp; order</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">sub_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="c1"># True if â€œotherâ€ is an Index and it has the same elements and order as the calling index; False otherwise.</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Warning: the indexes of fitdata &amp; sub_metadata do not have same elments or same order&quot;</span><span class="p">)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>    <span class="c1"># Retrieving vX</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>    <span class="n">acc_x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">]</span> <span class="c1"># special values of x that are accepted (e.g. H/C_all &gt; using H/C_org if available, but bridging with H/C_tot if not available)</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acc_x</span><span class="p">:</span> <span class="c1"># verify x is in metadata.columns</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;x = `</span><span class="si">{}</span><span class="s2">` must be a column in `metadata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>        <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>    <span class="k">else</span><span class="p">:</span> <span class="c1"># x is a special value, swith and handle separately</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;H/C_all&#39;</span><span class="p">:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_org&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_tot&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>    <span class="c1"># Counting NaNs in vX</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>    <span class="n">vXnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vX</span><span class="p">[</span><span class="n">vX</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>    <span class="c1"># Retrieving vY</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">:</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>        <span class="c1"># recalculate BC for given Th and Ts, and save it as vY, based on Q10 and fT saved in fitdata</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="n">sigvY</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>            <span class="n">Ts_ini</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]]</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            <span class="c1"># std is in absolute value (other named .1 =&gt; relative value, in %)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>            <span class="n">params_std</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;std_k&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c&#39;</span><span class="p">,</span><span class="s1">&#39;std_k1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c0&#39;</span><span class="p">,</span> <span class="s1">&#39;std_b&#39;</span><span class="p">,</span> <span class="s1">&#39;std_m&#39;</span><span class="p">]]</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>            <span class="n">params_corr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;corr(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k3)&#39;</span><span class="p">,</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                            <span class="s1">&#39;corr(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c2, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;corr(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(b, m)&#39;</span><span class="p">]</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="n">params_cov</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;cov(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c2)&#39;</span><span class="p">,</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                           <span class="s1">&#39;cov(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c1)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(b, m)&#39;</span><span class="p">]]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="n">map_model_function</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;singleExp&quot;</span><span class="p">:</span><span class="n">singleExp</span><span class="p">,</span><span class="s2">&quot;singleExp_u&quot;</span><span class="p">:</span><span class="n">singleExp_u</span><span class="p">,</span><span class="s2">&quot;doubleExp&quot;</span><span class="p">:</span><span class="n">doubleExp</span><span class="p">,</span><span class="s2">&quot;doubleExp_u&quot;</span><span class="p">:</span><span class="n">doubleExp_u</span><span class="p">,</span><span class="s2">&quot;tripleExp&quot;</span><span class="p">:</span><span class="n">tripleExp</span><span class="p">,</span><span class="s2">&quot;tripleExp_u&quot;</span><span class="p">:</span><span class="n">tripleExp_u</span><span class="p">,</span><span class="s2">&quot;powerModel&quot;</span><span class="p">:</span><span class="n">powerModel</span><span class="p">,}</span>            
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>            
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span> <span class="o">=</span> <span class="n">rebuild_cov2</span><span class="p">(</span><span class="n">map_model_function</span><span class="p">[</span><span class="n">FIT_func</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_std</span><span class="p">,</span> <span class="n">params_cov</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="n">BC</span><span class="p">,</span> <span class="n">sBC</span> <span class="o">=</span> <span class="n">apply_Q10_bis</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Ts_ini</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="n">vY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="n">sigvY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sBC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># [0] because functions returns a time series</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>            
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>            <span class="k">if</span> <span class="n">obs</span> <span class="o">==</span> <span class="n">iobs</span><span class="p">:</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BC_TH_TS&quot;</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sigma_BC&quot;</span><span class="p">,</span> <span class="n">sBC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vY</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>        <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;std_BC_Th_Ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigvY</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">]</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="n">sigvY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;std_BC_Th_Ts&#39;</span><span class="p">]</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>    <span class="k">elif</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;y = `</span><span class="si">{}</span><span class="s2">` must be a column in `fitdata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="c1"># Counting NaNs in vY</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>    <span class="n">vYnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vY</span><span class="p">[</span><span class="n">vY</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="c1"># Remove mutual any observation with nan values</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="n">vXYnan</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vXnan</span> <span class="o">+</span> <span class="n">vYnan</span><span class="p">)</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="n">vX</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">vY</span> <span class="o">=</span> <span class="n">vY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># removing irrelevant observations, as in vX, vY</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remainin nan, where uncertainty could not be calculated for some reason, replaced by 0</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="c1"># Names of Obs, for interactive plot; and colors</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Obs &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlGn</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="n">vXa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vX</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="n">vYa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vY</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>    <span class="n">sigvYa</span> <span class="o">=</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sigvY</span><span class="o">.</span><span class="n">values</span> <span class="c1">#np.array([sigvY.values, sigvY.values])</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>    <span class="n">xxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)])</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>    <span class="c1">## WITH SKLEARN</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>    <span class="c1"># Linear Curve fitting - without testing/training sets - full descriptive analysis</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>    <span class="n">reg_hc</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>    <span class="n">reg_hc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">vXa</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vYa</span> <span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>    <span class="n">y_predict_reg_hc</span> <span class="o">=</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">vXa</span> <span class="p">)</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>    <span class="n">r2_regHC</span> <span class="o">=</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">vXa</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">vYa</span><span class="p">)</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    <span class="n">rmse_regHC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">vYa</span><span class="p">,</span> <span class="n">y_predict_reg_hc</span><span class="p">))</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="n">exvar_regHC</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">vYa</span><span class="p">,</span> <span class="n">y_predict_reg_hc</span><span class="p">)</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="n">sl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg_hc</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>    <span class="n">it</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg_hc</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="c1">## WITH SCIPY</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>    <span class="k">def</span> <span class="nf">std_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">vX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">vY</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>    <span class="n">r2_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span>  <span class="n">rsquare</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>    <span class="k">if</span> <span class="n">wSigma</span><span class="p">:</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">vX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">vY</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="n">p_opt1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sigvY</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="n">r2_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span>  <span class="n">rsquare</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="c1">## why 1/sigvY suggested by some (as weighing factor) and why not just sigvY (which does not find a solution?)</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">vY</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>    <span class="c1"># plotting</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vXnan</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The parameter x=`</span><span class="si">{}</span><span class="s2">` contains </span><span class="si">{}</span><span class="s2"> NaN values, from observations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vXnan</span><span class="p">),</span> <span class="n">vXnan</span><span class="p">))</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vYnan</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The parameter y=`</span><span class="si">{}</span><span class="s2">` contains </span><span class="si">{}</span><span class="s2"> NaN values, from observations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vYnan</span><span class="p">),</span> <span class="n">vYnan</span><span class="p">))</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specified outliers (</span><span class="si">{}</span><span class="s2">) were removed from regression: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">),</span> <span class="n">outliers</span><span class="p">))</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remaining number of observations in the graph:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vXa</span><span class="p">)))</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="c1"># print(&quot;R2 of H:C ratio regression: &quot;, r2_regHC)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>        <span class="c1"># print(&quot;RMSE of H:C ratio regression: &quot;, rmse_regHC)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>        <span class="c1"># print(&quot;Explained variance: &quot;, exvar_regHC)</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Linear regression between: </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="c1">#fig, ax = plt.subplots(nrows=1, ncols=2, sharey=False, figsize=[12,6])</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1"># decay fits</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="c1">#ax2 = plt.subplot(r,c,(3, 3)) # 100 year extrapo</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="n">ax2</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>        <span class="c1">#ax[i].scatter(vXa, vYa, s=20, marker=&quot;o&quot;)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>    
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>                        <span class="n">style</span><span class="o">=</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> 
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>        <span class="c1">#ax[i].errorbar(vXa.flatten(), vYa.flatten(), yerr=sigvYa, fmt=&quot;none&quot;,</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="c1">#               barsabove=True, elinewidth=0.5, ecolor=&#39;k&#39;, solid_capstyle=&#39;butt&#39;, capthick=0.5, capsize=2)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="k">if</span> <span class="n">an</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>            <span class="n">xss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vXa</span><span class="p">)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="n">yss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vYa</span><span class="p">)</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>                <span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">yss</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>        <span class="c1">#ax[i].plot(xxx, reg_hc.predict(X = xxx.reshape(-1, 1) ), color=&#39;red&#39;)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">if</span> <span class="n">trendline</span><span class="p">:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="n">lbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2"> | R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="p">,</span> <span class="n">p_opt1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2_1</span><span class="p">)</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="k">if</span> <span class="n">trenderror</span><span class="p">:</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear regression: &quot;</span><span class="o">+</span><span class="n">lbl</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="k">if</span> <span class="n">wSigma</span><span class="p">:</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                <span class="n">lbl</span> <span class="o">=</span> <span class="s2">&quot;WithSigma: </span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2"> | R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="p">,</span> <span class="n">p_opt2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2_2</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lbl</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>                <span class="k">if</span> <span class="n">trenderror</span><span class="p">:</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>                
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="c1">#ax[i].annotate(text=&quot;{} = {:.2f} x {} + {:.2f}\nR2 = {:.2f}&quot;.format(y, sl, x ,it, r2_regHC), xy= (0.5, 0.9), xycoords=&#39;axes fraction&#39;, fontsize=10)</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="c1">#tsp = str(datetime.now().strftime(&quot;%Y-%m-%d_%H-%M&quot;))    </span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        <span class="c1">#plt.savefig(&#39;data_analysed/img-fid/&#39;+name+&#39;_&#39;+tsp+&#39;.png&#39;,dpi=300)</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="c1">#plt.show()</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> 
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>    
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="c1">#plt.clf()</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>        <span class="c1"># we assume an ax was provided</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>        <span class="c1">#[l.remove() for l in ax[i].lines]</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">vXa</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">vYa</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigvYa</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>                          <span class="n">barsabove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;butt&#39;</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)]),</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)]),</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="c1">#sc = ax[i].scatter(vXa, vYa, s=20, marker=&quot;o&quot;)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="n">sc</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>                        <span class="n">style</span><span class="o">=</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">x</span> <span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="n">r2_regHC</span><span class="p">),</span> 
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                       <span class="n">xy</span><span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="c1"># https://towardsdatascience.com/tooltips-with-pythons-matplotlib-dcd8db758846</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>        <span class="n">annot</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>                            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">),</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">))</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>        <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="k">def</span> <span class="nf">update_annot</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_offsets</span><span class="p">()[</span><span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">]]))</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]])))</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="k">def</span> <span class="nf">hover</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="n">vis</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>                <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                    <span class="n">update_annot</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                    <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                    <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                    <span class="k">if</span> <span class="n">vis</span><span class="p">:</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                        <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>                        <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">&quot;button_press_event&quot;</span><span class="p">,</span> <span class="n">hover</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="c1">## Linear Correlations - timeseries  </span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="k">def</span> <span class="nf">_align_dataframes</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">outliers</span><span class="p">):</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="sd">    fitdata, sub_metadata, obs = _align_dataframes(fitdata, metadata, outliers)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>    <span class="n">obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>    <span class="c1"># exclude identified outliers specified in *outliers*</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>    <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">)</span> <span class="c1"># change index to ID_obs, so that series have the same index</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>    
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># filter metadata for the observations in the model minus outliers</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span> <span class="c1"># filter metadata for the observations in the model</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;na&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span> <span class="c1"># replaces &#39;na&#39; strings by NaN, for correct handling </span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>    <span class="c1"># Make sure fitdata and sub_metadata have same index elements &amp; order</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">sub_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="c1"># True if â€œotherâ€ is an Index and it has the same elements and order as the calling index; False otherwise.</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Warning: the indexes of fitdata &amp; sub_metadata do not have same elments or same order&quot;</span><span class="p">)</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>    <span class="k">return</span> <span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">obs</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="k">def</span> <span class="nf">_retrieveX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">):</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">    vX, vXnan = _retrieveX(x, sub_metadata)</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>    <span class="n">acc_x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">]</span> <span class="c1"># special values of x that are accepted (e.g. H/C_all &gt; using H/C_org if available, but bridging with H/C_tot if not available)</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>    
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acc_x</span><span class="p">:</span> <span class="c1"># verify x is in metadata.columns</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;x = `</span><span class="si">{}</span><span class="s2">` must be a column in `metadata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>            <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># x is a special value, swith and handle separately</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;H/C_all&#39;</span><span class="p">:</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>                <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_org&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_tot&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="c1"># Counting NaNs in vX</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>        <span class="n">vXnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vX</span><span class="p">[</span><span class="n">vX</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>        
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>       <span class="c1"># if all(item in sub_metadata.columns for item in x):</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>       <span class="c1">#     # yes, all items of x are in sub_metadata.columns</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>       <span class="c1">#     vX = sub_metadata[x]</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>       <span class="c1"># elif any(item in acc_x for item in x):</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="n">vX</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">acc_x</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;H/C_all&#39;</span><span class="p">:</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                    <span class="n">vvX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_org&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_tot&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                    <span class="n">vX</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">vvX</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            <span class="k">elif</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>                    <span class="n">vvX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>                    <span class="n">vX</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">vvX</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;x item `</span><span class="si">{}</span><span class="s2">` not selected, because it is not in `metadata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>        <span class="c1">#counting NaNs in vX</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="n">vXnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vX</span><span class="p">[</span><span class="n">vX</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>    
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>    <span class="k">return</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span>  
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a><span class="k">def</span> <span class="nf">_calculateY</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">):</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a><span class="sd">    vY, sigvY, vYnan = _calculateY(fitdata, sub_metadata, Ts, Th)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>    <span class="c1"># some constants </span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>    <span class="n">map_model_function</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;singleExp&quot;</span><span class="p">:</span><span class="n">singleExp</span><span class="p">,</span><span class="s2">&quot;singleExp_u&quot;</span><span class="p">:</span><span class="n">singleExp_u</span><span class="p">,</span><span class="s2">&quot;doubleExp&quot;</span><span class="p">:</span><span class="n">doubleExp</span><span class="p">,</span><span class="s2">&quot;doubleExp_u&quot;</span><span class="p">:</span><span class="n">doubleExp_u</span><span class="p">,</span><span class="s2">&quot;tripleExp&quot;</span><span class="p">:</span><span class="n">tripleExp</span><span class="p">,</span><span class="s2">&quot;tripleExp_u&quot;</span><span class="p">:</span><span class="n">tripleExp_u</span><span class="p">,</span><span class="s2">&quot;powerModel&quot;</span><span class="p">:</span><span class="n">powerModel</span><span class="p">,}</span>            
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>    
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>    <span class="c1"># initialise lists to save calcs</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>    <span class="n">vY</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>    <span class="n">sigvY</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>    <span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>        <span class="n">Ts_ini</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]]</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="c1"># std is in absolute value (other named .1 =&gt; relative value, in %)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="n">params_std</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;std_k&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c&#39;</span><span class="p">,</span><span class="s1">&#39;std_k1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c0&#39;</span><span class="p">,</span> <span class="s1">&#39;std_b&#39;</span><span class="p">,</span> <span class="s1">&#39;std_m&#39;</span><span class="p">]]</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="n">params_corr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;corr(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k3)&#39;</span><span class="p">,</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>                        <span class="s1">&#39;corr(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c2, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;corr(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(b, m)&#39;</span><span class="p">]</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">params_cov</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;cov(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c2)&#39;</span><span class="p">,</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>                       <span class="s1">&#39;cov(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c1)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(b, m)&#39;</span><span class="p">]]</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="n">p_opt_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span> <span class="o">=</span> <span class="n">rebuild_cov2</span><span class="p">(</span><span class="n">map_model_function</span><span class="p">[</span><span class="n">FIT_func</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_std</span><span class="p">,</span> <span class="n">params_cov</span><span class="p">)</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        <span class="n">BC</span><span class="p">,</span> <span class="n">sBC</span> <span class="o">=</span> <span class="n">apply_Q10_bis</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Ts_ini</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="n">vY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="n">sigvY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sBC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># [0] because functions returns a time series</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>    <span class="n">vY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">vY</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>    <span class="n">sigvY</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sigvY</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>    <span class="n">vYnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vY</span><span class="p">[</span><span class="n">vY</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>    <span class="k">return</span> <span class="n">vY</span><span class="p">,</span> <span class="n">sigvY</span><span class="p">,</span> <span class="n">vYnan</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a><span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a><span class="k">def</span> <span class="nf">std_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="k">def</span> <span class="nf">calc_correlation_timeseries</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">],</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                                <span class="n">outliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>                                <span class="n">Ts</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                                <span class="n">Th</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>                               <span class="p">):</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">    Function can be used to calculate timesesries of BC_TH_TS, based on a linear fit between BC_TH_TS and H/C_all, for any TH and TS. </span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">    Inputs:</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">    - Ts: a list of values, or a single value provided as a list- soil temperatures to consider</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a><span class="sd">    - Th: a list of values, or a single value provided as a list- time points to calculate</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="sd">    - x : a list of values, or a single value provided as a list - variable in metadata to use for correlation (single variable or multiple variable)</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">    - outliers: a list of ID_obs to exclude from analysis</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">    Outputs:</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="sd">    - vX: vector of X variable, for selected observations where data available</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a><span class="sd">    - vXnan: list of ID_obs where X variable is NaN</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">    - megaY: dictionnary of calculated Y (BC_TH_TS), where keys are (TS, TH) tuples, and values are the corresponding BC_TH_TS for each observations</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a><span class="sd">    - megaYnan: list of ID_obs where Y variable is NaN</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a><span class="sd">    - megaCoeffs: for each (TS, TH), coefficients from the linear regression (slope, intercept)</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a><span class="sd">    - megaSCoeffs: for each (TS, TH), covariance matrix from the linear regression</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a><span class="sd">    Usage: \n</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a><span class="sd">        vX, vXnan, megaY, megaYnan, megaCoeffs, megaSCoeffs = calc_correlation_timeseries(fitdata, metadata,</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a><span class="sd">                                x = [&#39;H/C_all&#39;], outliers=None, Ts=[10, 15, 20],</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a><span class="sd">                                Th=[0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 140, 160, 180, 200],</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a><span class="sd">                               )</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>    
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>    <span class="c1"># data preparation</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>    <span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">_align_dataframes</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">outliers</span><span class="p">)</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>    <span class="c1"># get X columns</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>    <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span> <span class="o">=</span> <span class="n">_retrieveX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>    
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>    <span class="c1"># calculate Y columns: i.e. calculate BC_Th_Ts &amp; sigmaBC_Th_Ts, and save for range of Ts and Th </span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>    <span class="n">megaY</span> <span class="o">=</span> <span class="p">{}</span> 
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>    <span class="n">megaSY</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>    <span class="n">megaYnan</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">Th</span><span class="p">:</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            <span class="n">megaY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)],</span> <span class="n">megaSY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)],</span> <span class="n">megaYnan</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_calculateY</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>            
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>    <span class="c1"># perform correlation, for each Ts and Th; and save coefficients &amp; their sigma</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>    <span class="n">megaCoeffs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>    <span class="n">megaSCoeffs</span> <span class="o">=</span> <span class="p">{}</span>        
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">Th</span><span class="p">:</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>            <span class="c1"># Remove any mutual observation with nan values</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>            <span class="n">vXYnan</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vXnan</span> <span class="o">+</span> <span class="n">megaYnan</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)])</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>            <span class="n">cvX</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>            <span class="n">cvY</span> <span class="o">=</span> <span class="n">megaY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>            <span class="n">sigvY</span> <span class="o">=</span> <span class="n">megaSY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># removing irrelevant observations, as in vX, vY</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>            <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remainin nan, where uncertainty could not be calculated for some reason, replaced by 0</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>            <span class="c1"># Do the fit</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>            <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">cvX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">cvY</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>            <span class="c1"># Save the fit</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>            <span class="n">megaCoeffs</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_opt1</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>            <span class="n">megaSCoeffs</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_cov1</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>            
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>    <span class="c1"># return array of BC_Th_Ts, sigmaBC_Th_Ts, coefficients &amp; sigma, for each Ts &amp; Th</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>    <span class="c1"># second function: plot all the lines. </span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>    <span class="k">return</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span><span class="p">,</span> <span class="n">megaY</span><span class="p">,</span> <span class="n">megaYnan</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">,</span> <span class="n">megaSCoeffs</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="k">def</span> <span class="nf">_rebuild_timeseries</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">):</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>    <span class="n">BC</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>    <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">Th</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>        <span class="c1"># get the coefficients</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>        <span class="n">p_opt</span> <span class="o">=</span> <span class="n">megaCoeffs</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>        <span class="n">BC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)))</span> <span class="p">)</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>    <span class="k">return</span> <span class="n">BC</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>    
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="k">def</span> <span class="nf">plot_correlation_timeseries</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>                                <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span><span class="p">,</span> <span class="n">megaY</span><span class="p">,</span> <span class="n">megaYnan</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">,</span> <span class="n">megaSCoeffs</span><span class="p">,</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>                                <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">TH_lim</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>                               <span class="p">):</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">    Plot the results computed via `calc_correlation_timeseries`.</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">    </span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">    Inputs:</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="sd">    - x = values of X that need to be plotted, as a list // if multiple variables; should be a dictionnary of key:[values]</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">    Outputs:</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="sd">    - fig, ax</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>    <span class="c1"># reconstruct the lines, for each H/C_all values, at given Ts</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span> 
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>            <span class="n">BC</span> <span class="o">=</span> <span class="n">_rebuild_timeseries</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">)</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;H/C: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>    <span class="c1">#ax.plot(Th, Th)</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>    
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>    <span class="c1"># styling    </span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Biochar C remaining (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">TH_lim</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (years)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>    
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Modelled timeseries as a function of H/C ratio and soil temperature&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a><span class="k">def</span> <span class="nf">pick_model</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">sets</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="sd">    Pick the a random forest model `k` from `df` and re-trains it with its optimal parameters, on the data set (X,Y).</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="sd">    - k: row index of the model in the dataframe df, corresponding also to set index in dictionary sets</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="sd">    - df: df containing the model optimal parameters, as well as r2, r2a, features</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="sd">    - sets: dictionnary of sets </span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">    - X, Y: the training data/target</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>    <span class="n">mp</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;randomforestregressor__&quot;</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,:][</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>    <span class="c1"># feature selection, normalisation, one-hot encoding</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>    <span class="n">fX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>    <span class="n">fY</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>    <span class="n">numerical_columns_selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">(</span><span class="n">dtype_exclude</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>    <span class="n">categorical_columns_selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>    <span class="n">numerical_columns</span> <span class="o">=</span> <span class="n">numerical_columns_selector</span><span class="p">(</span><span class="n">fX</span><span class="p">)</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>    <span class="n">categorical_columns</span> <span class="o">=</span> <span class="n">categorical_columns_selector</span><span class="p">(</span><span class="n">fX</span><span class="p">)</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>    <span class="n">categorical_preprocessor</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="c1"># Here, could do a LabelEncoder() as well</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>    <span class="n">numerical_preprocessor</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span> <span class="c1">#StandardScaler() # RobustScaler() can also do robustscaler, dealing with outliers differently</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>        <span class="p">(</span><span class="s1">&#39;one-hot-encoder&#39;</span><span class="p">,</span> <span class="n">categorical_preprocessor</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">),</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="p">(</span><span class="s1">&#39;standard_scaler&#39;</span><span class="p">,</span> <span class="n">numerical_preprocessor</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">)])</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>    <span class="n">pipeRF</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">mp</span><span class="p">))</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>    <span class="n">pipeRF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fX</span><span class="p">,</span> <span class="n">fY</span><span class="p">)</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>    <span class="k">return</span> <span class="n">pipeRF</span>
</span></pre></div>


            </section>
                <section id="singleExp">
                            <input id="singleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">singleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k</span></span>)</span>

                <label class="view-source-button" for="singleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#singleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="singleExp-53"><a href="#singleExp-53"><span class="linenos">53</span></a><span class="k">def</span> <span class="nf">singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="singleExp-54"><a href="#singleExp-54"><span class="linenos">54</span></a>    <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_singleExp">
                            <input id="k_singleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_singleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k</span></span>)</span>

                <label class="view-source-button" for="k_singleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_singleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_singleExp-56"><a href="#k_singleExp-56"><span class="linenos">56</span></a><span class="k">def</span> <span class="nf">k_singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="k_singleExp-57"><a href="#k_singleExp-57"><span class="linenos">57</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="singleExp_u">
                            <input id="singleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">singleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k</span>, </span><span class="param"><span class="n">c</span></span>)</span>

                <label class="view-source-button" for="singleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#singleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="singleExp_u-59"><a href="#singleExp_u-59"><span class="linenos">59</span></a><span class="k">def</span> <span class="nf">singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="singleExp_u-60"><a href="#singleExp_u-60"><span class="linenos">60</span></a>    <span class="k">return</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_singleExp_u">
                            <input id="k_singleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_singleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k</span>, </span><span class="param"><span class="n">c</span></span>)</span>

                <label class="view-source-button" for="k_singleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_singleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_singleExp_u-62"><a href="#k_singleExp_u-62"><span class="linenos">62</span></a><span class="k">def</span> <span class="nf">k_singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
</span><span id="k_singleExp_u-63"><a href="#k_singleExp_u-63"><span class="linenos">63</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="doubleExp">
                            <input id="doubleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">doubleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">c1</span></span>)</span>

                <label class="view-source-button" for="doubleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#doubleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="doubleExp-65"><a href="#doubleExp-65"><span class="linenos">65</span></a><span class="k">def</span> <span class="nf">doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
</span><span id="doubleExp-66"><a href="#doubleExp-66"><span class="linenos">66</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_doubleExp">
                            <input id="k_doubleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_doubleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">c1</span></span>)</span>

                <label class="view-source-button" for="k_doubleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_doubleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_doubleExp-68"><a href="#k_doubleExp-68"><span class="linenos">68</span></a><span class="k">def</span> <span class="nf">k_doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
</span><span id="k_doubleExp-69"><a href="#k_doubleExp-69"><span class="linenos">69</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="doubleExp_u">
                            <input id="doubleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">doubleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span></span>)</span>

                <label class="view-source-button" for="doubleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#doubleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="doubleExp_u-71"><a href="#doubleExp_u-71"><span class="linenos">71</span></a><span class="k">def</span> <span class="nf">doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="doubleExp_u-72"><a href="#doubleExp_u-72"><span class="linenos">72</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_doubleExp_u">
                            <input id="k_doubleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_doubleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span></span>)</span>

                <label class="view-source-button" for="k_doubleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_doubleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_doubleExp_u-74"><a href="#k_doubleExp_u-74"><span class="linenos">74</span></a><span class="k">def</span> <span class="nf">k_doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="k_doubleExp_u-75"><a href="#k_doubleExp_u-75"><span class="linenos">75</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="tripleExp">
                            <input id="tripleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tripleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">k3</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span></span>)</span>

                <label class="view-source-button" for="tripleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#tripleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="tripleExp-77"><a href="#tripleExp-77"><span class="linenos">77</span></a><span class="k">def</span> <span class="nf">tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="tripleExp-78"><a href="#tripleExp-78"><span class="linenos">78</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_tripleExp">
                            <input id="k_tripleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_tripleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">k3</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span></span>)</span>

                <label class="view-source-button" for="k_tripleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_tripleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_tripleExp-80"><a href="#k_tripleExp-80"><span class="linenos">80</span></a><span class="k">def</span> <span class="nf">k_tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span><span id="k_tripleExp-81"><a href="#k_tripleExp-81"><span class="linenos">81</span></a>    <span class="k">return</span> <span class="p">(</span> <span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="tripleExp_u">
                            <input id="tripleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tripleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">k3</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span>, </span><span class="param"><span class="n">c3</span></span>)</span>

                <label class="view-source-button" for="tripleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#tripleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="tripleExp_u-83"><a href="#tripleExp_u-83"><span class="linenos">83</span></a><span class="k">def</span> <span class="nf">tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span><span id="tripleExp_u-84"><a href="#tripleExp_u-84"><span class="linenos">84</span></a>    <span class="k">return</span> <span class="n">c1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="k_tripleExp_u">
                            <input id="k_tripleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_tripleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">k1</span>, </span><span class="param"><span class="n">k2</span>, </span><span class="param"><span class="n">k3</span>, </span><span class="param"><span class="n">c1</span>, </span><span class="param"><span class="n">c2</span>, </span><span class="param"><span class="n">c3</span></span>)</span>

                <label class="view-source-button" for="k_tripleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_tripleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_tripleExp_u-86"><a href="#k_tripleExp_u-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">k_tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span><span id="k_tripleExp_u-87"><a href="#k_tripleExp_u-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="powerModel">
                            <input id="powerModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">powerModel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">c0</span>, </span><span class="param"><span class="n">b</span>, </span><span class="param"><span class="n">m</span></span>)</span>

                <label class="view-source-button" for="powerModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#powerModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="powerModel-89"><a href="#powerModel-89"><span class="linenos">89</span></a><span class="k">def</span> <span class="nf">powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="powerModel-90"><a href="#powerModel-90"><span class="linenos">90</span></a>    <span class="c1"># as defined in Zimmerman 2011</span>
</span><span id="powerModel-91"><a href="#powerModel-91"><span class="linenos">91</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel-92"><a href="#powerModel-92"><span class="linenos">92</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel-93"><a href="#powerModel-93"><span class="linenos">93</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel-94"><a href="#powerModel-94"><span class="linenos">94</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="powerModel-95"><a href="#powerModel-95"><span class="linenos">95</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel-96"><a href="#powerModel-96"><span class="linenos">96</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel-97"><a href="#powerModel-97"><span class="linenos">97</span></a>    <span class="k">return</span> <span class="n">z</span>
</span></pre></div>


    

                </section>
                <section id="k_powerModel">
                            <input id="k_powerModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">k_powerModel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">c0</span>, </span><span class="param"><span class="n">b</span>, </span><span class="param"><span class="n">m</span></span>)</span>

                <label class="view-source-button" for="k_powerModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#k_powerModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="k_powerModel-99"><a href="#k_powerModel-99"><span class="linenos"> 99</span></a><span class="k">def</span> <span class="nf">k_powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="k_powerModel-100"><a href="#k_powerModel-100"><span class="linenos">100</span></a>    <span class="c1"># as defined in Zimmerman 2011</span>
</span><span id="k_powerModel-101"><a href="#k_powerModel-101"><span class="linenos">101</span></a>    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</span></pre></div>


    

                </section>
                <section id="powerModel_lim">
                            <input id="powerModel_lim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">powerModel_lim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">c0</span>, </span><span class="param"><span class="n">b</span>, </span><span class="param"><span class="n">m</span>, </span><span class="param"><span class="n">L</span><span class="o">=</span><span class="mi">3650</span></span>)</span>

                <label class="view-source-button" for="powerModel_lim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#powerModel_lim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="powerModel_lim-103"><a href="#powerModel_lim-103"><span class="linenos">103</span></a><span class="k">def</span> <span class="nf">powerModel_lim</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mi">365</span><span class="p">):</span>
</span><span id="powerModel_lim-104"><a href="#powerModel_lim-104"><span class="linenos">104</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="powerModel_lim-105"><a href="#powerModel_lim-105"><span class="linenos">105</span></a><span class="sd">    This function cannot be used in curve fitting step. Instead, curve fitting should be done with bs.powerModel.</span>
</span><span id="powerModel_lim-106"><a href="#powerModel_lim-106"><span class="linenos">106</span></a><span class="sd">    Then, the fitted parameters on bs.PowerModel are used to calculate the extrapolation with the assumption that the decay rates decreases only for L years.</span>
</span><span id="powerModel_lim-107"><a href="#powerModel_lim-107"><span class="linenos">107</span></a><span class="sd">    </span>
</span><span id="powerModel_lim-108"><a href="#powerModel_lim-108"><span class="linenos">108</span></a><span class="sd">    - L = 10*365 # days</span>
</span><span id="powerModel_lim-109"><a href="#powerModel_lim-109"><span class="linenos">109</span></a><span class="sd">    </span>
</span><span id="powerModel_lim-110"><a href="#powerModel_lim-110"><span class="linenos">110</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="powerModel_lim-111"><a href="#powerModel_lim-111"><span class="linenos">111</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
</span><span id="powerModel_lim-112"><a href="#powerModel_lim-112"><span class="linenos">112</span></a>        <span class="c1"># yes, t is an array of values</span>
</span><span id="powerModel_lim-113"><a href="#powerModel_lim-113"><span class="linenos">113</span></a>        <span class="n">t_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="powerModel_lim-114"><a href="#powerModel_lim-114"><span class="linenos">114</span></a>        <span class="n">t_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">L</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="powerModel_lim-115"><a href="#powerModel_lim-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-116"><a href="#powerModel_lim-116"><span class="linenos">116</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t_before</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_lim-117"><a href="#powerModel_lim-117"><span class="linenos">117</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-118"><a href="#powerModel_lim-118"><span class="linenos">118</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_before</span><span class="p">))</span>
</span><span id="powerModel_lim-119"><a href="#powerModel_lim-119"><span class="linenos">119</span></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-120"><a href="#powerModel_lim-120"><span class="linenos">120</span></a>            <span class="n">z_before</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t_before</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel_lim-121"><a href="#powerModel_lim-121"><span class="linenos">121</span></a>
</span><span id="powerModel_lim-122"><a href="#powerModel_lim-122"><span class="linenos">122</span></a>        <span class="n">kL</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">1.</span>
</span><span id="powerModel_lim-123"><a href="#powerModel_lim-123"><span class="linenos">123</span></a>        <span class="n">zL</span> <span class="o">=</span> <span class="n">z_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="powerModel_lim-124"><a href="#powerModel_lim-124"><span class="linenos">124</span></a>        
</span><span id="powerModel_lim-125"><a href="#powerModel_lim-125"><span class="linenos">125</span></a>        <span class="n">z_after</span> <span class="o">=</span> <span class="n">zL</span> <span class="o">+</span> <span class="n">kL</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_after</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
</span><span id="powerModel_lim-126"><a href="#powerModel_lim-126"><span class="linenos">126</span></a>        
</span><span id="powerModel_lim-127"><a href="#powerModel_lim-127"><span class="linenos">127</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_before</span><span class="p">,</span> <span class="n">z_after</span><span class="p">)</span> <span class="c1"># append, not add </span>
</span><span id="powerModel_lim-128"><a href="#powerModel_lim-128"><span class="linenos">128</span></a>        
</span><span id="powerModel_lim-129"><a href="#powerModel_lim-129"><span class="linenos">129</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="powerModel_lim-130"><a href="#powerModel_lim-130"><span class="linenos">130</span></a>        <span class="c1"># no, t is a single value</span>
</span><span id="powerModel_lim-131"><a href="#powerModel_lim-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">L</span><span class="p">:</span>
</span><span id="powerModel_lim-132"><a href="#powerModel_lim-132"><span class="linenos">132</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-133"><a href="#powerModel_lim-133"><span class="linenos">133</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_lim-134"><a href="#powerModel_lim-134"><span class="linenos">134</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-135"><a href="#powerModel_lim-135"><span class="linenos">135</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="powerModel_lim-136"><a href="#powerModel_lim-136"><span class="linenos">136</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-137"><a href="#powerModel_lim-137"><span class="linenos">137</span></a>                <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel_lim-138"><a href="#powerModel_lim-138"><span class="linenos">138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="powerModel_lim-139"><a href="#powerModel_lim-139"><span class="linenos">139</span></a>            <span class="c1"># t &gt;= L </span>
</span><span id="powerModel_lim-140"><a href="#powerModel_lim-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-141"><a href="#powerModel_lim-141"><span class="linenos">141</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_lim-142"><a href="#powerModel_lim-142"><span class="linenos">142</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_lim-143"><a href="#powerModel_lim-143"><span class="linenos">143</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-144"><a href="#powerModel_lim-144"><span class="linenos">144</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
</span><span id="powerModel_lim-145"><a href="#powerModel_lim-145"><span class="linenos">145</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_lim-146"><a href="#powerModel_lim-146"><span class="linenos">146</span></a>            <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_lim-147"><a href="#powerModel_lim-147"><span class="linenos">147</span></a>                <span class="n">zL</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel_lim-148"><a href="#powerModel_lim-148"><span class="linenos">148</span></a>                <span class="n">zLn</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel_lim-149"><a href="#powerModel_lim-149"><span class="linenos">149</span></a>            
</span><span id="powerModel_lim-150"><a href="#powerModel_lim-150"><span class="linenos">150</span></a>            <span class="n">kL</span> <span class="o">=</span> <span class="p">(</span><span class="n">zL</span><span class="o">-</span><span class="n">zLn</span><span class="p">)</span><span class="o">/</span><span class="mf">1.</span>
</span><span id="powerModel_lim-151"><a href="#powerModel_lim-151"><span class="linenos">151</span></a>            
</span><span id="powerModel_lim-152"><a href="#powerModel_lim-152"><span class="linenos">152</span></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">zL</span> <span class="o">+</span> <span class="n">kL</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
</span><span id="powerModel_lim-153"><a href="#powerModel_lim-153"><span class="linenos">153</span></a>        
</span><span id="powerModel_lim-154"><a href="#powerModel_lim-154"><span class="linenos">154</span></a>    <span class="k">return</span> <span class="n">z</span>
</span></pre></div>


            <div class="docstring"><p>This function cannot be used in curve fitting step. Instead, curve fitting should be done with bs.powerModel.
Then, the fitted parameters on bs.PowerModel are used to calculate the extrapolation with the assumption that the decay rates decreases only for L years.</p>

<ul>
<li>L = 10*365 # days</li>
</ul>
</div>


                </section>
                <section id="powerModel_q10">
                            <input id="powerModel_q10-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">powerModel_q10</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">fT</span>, </span><span class="param"><span class="n">c0</span>, </span><span class="param"><span class="n">b</span>, </span><span class="param"><span class="n">m</span></span>)</span>

                <label class="view-source-button" for="powerModel_q10-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#powerModel_q10"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="powerModel_q10-156"><a href="#powerModel_q10-156"><span class="linenos">156</span></a><span class="k">def</span> <span class="nf">powerModel_q10</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
</span><span id="powerModel_q10-157"><a href="#powerModel_q10-157"><span class="linenos">157</span></a>    <span class="c1"># as defined in Zimmerman 2011, with own recalculation for a different temperature based on k --&gt; k*fT + re-integrate</span>
</span><span id="powerModel_q10-158"><a href="#powerModel_q10-158"><span class="linenos">158</span></a>    <span class="c1">#print(m)</span>
</span><span id="powerModel_q10-159"><a href="#powerModel_q10-159"><span class="linenos">159</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_q10-160"><a href="#powerModel_q10-160"><span class="linenos">160</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="powerModel_q10-161"><a href="#powerModel_q10-161"><span class="linenos">161</span></a>    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_q10-162"><a href="#powerModel_q10-162"><span class="linenos">162</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</span><span id="powerModel_q10-163"><a href="#powerModel_q10-163"><span class="linenos">163</span></a>    <span class="k">elif</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="powerModel_q10-164"><a href="#powerModel_q10-164"><span class="linenos">164</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">fT</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.001</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">c0</span>
</span><span id="powerModel_q10-165"><a href="#powerModel_q10-165"><span class="linenos">165</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="powerModel_q10-166"><a href="#powerModel_q10-166"><span class="linenos">166</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="powerModel_q10-167"><a href="#powerModel_q10-167"><span class="linenos">167</span></a>    <span class="k">return</span> <span class="n">z</span> 
</span></pre></div>


    

                </section>
                <section id="singleExp_u_lmfit">
                            <input id="singleExp_u_lmfit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">singleExp_u_lmfit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span>)</span>

                <label class="view-source-button" for="singleExp_u_lmfit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#singleExp_u_lmfit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="singleExp_u_lmfit-180"><a href="#singleExp_u_lmfit-180"><span class="linenos">180</span></a><span class="k">def</span> <span class="nf">singleExp_u_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
</span><span id="singleExp_u_lmfit-181"><a href="#singleExp_u_lmfit-181"><span class="linenos">181</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span>
</span><span id="singleExp_u_lmfit-182"><a href="#singleExp_u_lmfit-182"><span class="linenos">182</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="singleExp_u_lmfit-183"><a href="#singleExp_u_lmfit-183"><span class="linenos">183</span></a>    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
</span><span id="singleExp_u_lmfit-184"><a href="#singleExp_u_lmfit-184"><span class="linenos">184</span></a>    <span class="k">return</span> <span class="n">y_fit</span> <span class="o">-</span> <span class="n">y</span>
</span></pre></div>


    

                </section>
                <section id="doubleExp_u_lmfit">
                            <input id="doubleExp_u_lmfit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">doubleExp_u_lmfit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span>)</span>

                <label class="view-source-button" for="doubleExp_u_lmfit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#doubleExp_u_lmfit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="doubleExp_u_lmfit-186"><a href="#doubleExp_u_lmfit-186"><span class="linenos">186</span></a><span class="k">def</span> <span class="nf">doubleExp_u_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
</span><span id="doubleExp_u_lmfit-187"><a href="#doubleExp_u_lmfit-187"><span class="linenos">187</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span>
</span><span id="doubleExp_u_lmfit-188"><a href="#doubleExp_u_lmfit-188"><span class="linenos">188</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">]</span>
</span><span id="doubleExp_u_lmfit-189"><a href="#doubleExp_u_lmfit-189"><span class="linenos">189</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="doubleExp_u_lmfit-190"><a href="#doubleExp_u_lmfit-190"><span class="linenos">190</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span>
</span><span id="doubleExp_u_lmfit-191"><a href="#doubleExp_u_lmfit-191"><span class="linenos">191</span></a>    <span class="c1">#print(c1.value, c2.value, k1.value, k2.value)</span>
</span><span id="doubleExp_u_lmfit-192"><a href="#doubleExp_u_lmfit-192"><span class="linenos">192</span></a>    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
</span><span id="doubleExp_u_lmfit-193"><a href="#doubleExp_u_lmfit-193"><span class="linenos">193</span></a>    <span class="c1">#print(y_fit-y)</span>
</span><span id="doubleExp_u_lmfit-194"><a href="#doubleExp_u_lmfit-194"><span class="linenos">194</span></a>    <span class="k">return</span> <span class="n">y_fit</span> <span class="o">-</span> <span class="n">y</span>
</span></pre></div>


    

                </section>
                <section id="rsquare">
                            <input id="rsquare-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rsquare</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span>, </span><span class="param"><span class="n">xdata</span>, </span><span class="param"><span class="n">ydata</span>, </span><span class="param"><span class="n">popt</span></span>)</span>

                <label class="view-source-button" for="rsquare-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rsquare"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rsquare-197"><a href="#rsquare-197"><span class="linenos">197</span></a><span class="k">def</span> <span class="nf">rsquare</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">popt</span><span class="p">):</span>
</span><span id="rsquare-198"><a href="#rsquare-198"><span class="linenos">198</span></a>    <span class="sd">&#39;&#39;&#39;Computes R-square value for given fit</span>
</span><span id="rsquare-199"><a href="#rsquare-199"><span class="linenos">199</span></a>
</span><span id="rsquare-200"><a href="#rsquare-200"><span class="linenos">200</span></a><span class="sd">    Input: \n</span>
</span><span id="rsquare-201"><a href="#rsquare-201"><span class="linenos">201</span></a><span class="sd">        - f : model function, callable</span>
</span><span id="rsquare-202"><a href="#rsquare-202"><span class="linenos">202</span></a>
</span><span id="rsquare-203"><a href="#rsquare-203"><span class="linenos">203</span></a><span class="sd">        - xdata: array</span>
</span><span id="rsquare-204"><a href="#rsquare-204"><span class="linenos">204</span></a>
</span><span id="rsquare-205"><a href="#rsquare-205"><span class="linenos">205</span></a><span class="sd">        - ydata: array</span>
</span><span id="rsquare-206"><a href="#rsquare-206"><span class="linenos">206</span></a>
</span><span id="rsquare-207"><a href="#rsquare-207"><span class="linenos">207</span></a><span class="sd">        - popt: returned by curve_fit</span>
</span><span id="rsquare-208"><a href="#rsquare-208"><span class="linenos">208</span></a>
</span><span id="rsquare-209"><a href="#rsquare-209"><span class="linenos">209</span></a><span class="sd">    Returns: \n</span>
</span><span id="rsquare-210"><a href="#rsquare-210"><span class="linenos">210</span></a><span class="sd">        - r2</span>
</span><span id="rsquare-211"><a href="#rsquare-211"><span class="linenos">211</span></a>
</span><span id="rsquare-212"><a href="#rsquare-212"><span class="linenos">212</span></a><span class="sd">        - residuals</span>
</span><span id="rsquare-213"><a href="#rsquare-213"><span class="linenos">213</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="rsquare-214"><a href="#rsquare-214"><span class="linenos">214</span></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="c1"># &#39;*&#39; needed to unpack it (kwargs)</span>
</span><span id="rsquare-215"><a href="#rsquare-215"><span class="linenos">215</span></a>    <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="rsquare-216"><a href="#rsquare-216"><span class="linenos">216</span></a>    <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ydata</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ydata</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="rsquare-217"><a href="#rsquare-217"><span class="linenos">217</span></a>    
</span><span id="rsquare-218"><a href="#rsquare-218"><span class="linenos">218</span></a>    <span class="n">rs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">ss_res</span><span class="o">/</span><span class="n">ss_tot</span>
</span><span id="rsquare-219"><a href="#rsquare-219"><span class="linenos">219</span></a>    <span class="k">return</span> <span class="n">rs</span><span class="p">,</span> <span class="n">residuals</span>
</span></pre></div>


            <div class="docstring"><p>Computes R-square value for given fit</p>

<p>Input: </p>

<pre><code>- f : model function, callable

- xdata: array

- ydata: array

- popt: returned by curve_fit
</code></pre>

<p>Returns: </p>

<pre><code>- r2

- residuals
</code></pre>
</div>


                </section>
                <section id="lmfit_fitting_stats">
                            <input id="lmfit_fitting_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">lmfit_fitting_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span>, </span><span class="param"><span class="n">xdata</span>, </span><span class="param"><span class="n">ydata</span>, </span><span class="param"><span class="n">popt</span></span>)</span>

                <label class="view-source-button" for="lmfit_fitting_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#lmfit_fitting_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="lmfit_fitting_stats-221"><a href="#lmfit_fitting_stats-221"><span class="linenos">221</span></a><span class="k">def</span> <span class="nf">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">popt</span><span class="p">):</span>
</span><span id="lmfit_fitting_stats-222"><a href="#lmfit_fitting_stats-222"><span class="linenos">222</span></a>    <span class="sd">&#39;&#39;&#39;Computes the fitting statistics (chi-square, reduced chi square, AIC, BIC) for a given fit, as implemented in lmfit </span>
</span><span id="lmfit_fitting_stats-223"><a href="#lmfit_fitting_stats-223"><span class="linenos">223</span></a><span class="sd">    (source: https://github.com/lmfit/lmfit-py/blob/master/lmfit/minimizer.py line 364)</span>
</span><span id="lmfit_fitting_stats-224"><a href="#lmfit_fitting_stats-224"><span class="linenos">224</span></a><span class="sd">    Input: \n</span>
</span><span id="lmfit_fitting_stats-225"><a href="#lmfit_fitting_stats-225"><span class="linenos">225</span></a><span class="sd">        - f : model function, callable</span>
</span><span id="lmfit_fitting_stats-226"><a href="#lmfit_fitting_stats-226"><span class="linenos">226</span></a>
</span><span id="lmfit_fitting_stats-227"><a href="#lmfit_fitting_stats-227"><span class="linenos">227</span></a><span class="sd">        - xdata: array</span>
</span><span id="lmfit_fitting_stats-228"><a href="#lmfit_fitting_stats-228"><span class="linenos">228</span></a>
</span><span id="lmfit_fitting_stats-229"><a href="#lmfit_fitting_stats-229"><span class="linenos">229</span></a><span class="sd">        - ydata: array</span>
</span><span id="lmfit_fitting_stats-230"><a href="#lmfit_fitting_stats-230"><span class="linenos">230</span></a>
</span><span id="lmfit_fitting_stats-231"><a href="#lmfit_fitting_stats-231"><span class="linenos">231</span></a><span class="sd">        - popt: returned by curve_fit</span>
</span><span id="lmfit_fitting_stats-232"><a href="#lmfit_fitting_stats-232"><span class="linenos">232</span></a>
</span><span id="lmfit_fitting_stats-233"><a href="#lmfit_fitting_stats-233"><span class="linenos">233</span></a><span class="sd">    Outputs: \n</span>
</span><span id="lmfit_fitting_stats-234"><a href="#lmfit_fitting_stats-234"><span class="linenos">234</span></a><span class="sd">        - chisqr</span>
</span><span id="lmfit_fitting_stats-235"><a href="#lmfit_fitting_stats-235"><span class="linenos">235</span></a>
</span><span id="lmfit_fitting_stats-236"><a href="#lmfit_fitting_stats-236"><span class="linenos">236</span></a><span class="sd">        - redchisqr</span>
</span><span id="lmfit_fitting_stats-237"><a href="#lmfit_fitting_stats-237"><span class="linenos">237</span></a>
</span><span id="lmfit_fitting_stats-238"><a href="#lmfit_fitting_stats-238"><span class="linenos">238</span></a><span class="sd">        - AIC</span>
</span><span id="lmfit_fitting_stats-239"><a href="#lmfit_fitting_stats-239"><span class="linenos">239</span></a>
</span><span id="lmfit_fitting_stats-240"><a href="#lmfit_fitting_stats-240"><span class="linenos">240</span></a><span class="sd">        - BIC</span>
</span><span id="lmfit_fitting_stats-241"><a href="#lmfit_fitting_stats-241"><span class="linenos">241</span></a><span class="sd">        </span>
</span><span id="lmfit_fitting_stats-242"><a href="#lmfit_fitting_stats-242"><span class="linenos">242</span></a><span class="sd">    Usage: \n</span>
</span><span id="lmfit_fitting_stats-243"><a href="#lmfit_fitting_stats-243"><span class="linenos">243</span></a><span class="sd">        residuals, chisqr, redchisqr, aic, bic = lmfit_fitting_stats(f, xdata, ydata, popt)</span>
</span><span id="lmfit_fitting_stats-244"><a href="#lmfit_fitting_stats-244"><span class="linenos">244</span></a><span class="sd">        </span>
</span><span id="lmfit_fitting_stats-245"><a href="#lmfit_fitting_stats-245"><span class="linenos">245</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="lmfit_fitting_stats-246"><a href="#lmfit_fitting_stats-246"><span class="linenos">246</span></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="c1"># residuals</span>
</span><span id="lmfit_fitting_stats-247"><a href="#lmfit_fitting_stats-247"><span class="linenos">247</span></a>    <span class="n">chisqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># sum-squared residuals</span>
</span><span id="lmfit_fitting_stats-248"><a href="#lmfit_fitting_stats-248"><span class="linenos">248</span></a>    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span> <span class="c1"># nb of data points</span>
</span><span id="lmfit_fitting_stats-249"><a href="#lmfit_fitting_stats-249"><span class="linenos">249</span></a>    <span class="n">nvarys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># nb of param in f function</span>
</span><span id="lmfit_fitting_stats-250"><a href="#lmfit_fitting_stats-250"><span class="linenos">250</span></a>    <span class="n">nfree</span> <span class="o">=</span> <span class="n">ndata</span> <span class="o">-</span> <span class="n">nvarys</span> <span class="c1"># degree of freedom: ndata - nparameters in the f function (i.e. nb args - 1 (since 1st arg is time))</span>
</span><span id="lmfit_fitting_stats-251"><a href="#lmfit_fitting_stats-251"><span class="linenos">251</span></a>    <span class="n">redchisqr</span> <span class="o">=</span> <span class="n">chisqr</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfree</span><span class="p">)</span>
</span><span id="lmfit_fitting_stats-252"><a href="#lmfit_fitting_stats-252"><span class="linenos">252</span></a>    <span class="n">chisqr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">chisqr</span><span class="p">,</span> <span class="mf">1.e-250</span><span class="o">*</span><span class="n">ndata</span><span class="p">)</span> <span class="c1"># modify chisqr value, if chisqr is 0, to be safe in the log</span>
</span><span id="lmfit_fitting_stats-253"><a href="#lmfit_fitting_stats-253"><span class="linenos">253</span></a>    <span class="n">_neg2_log_likel</span> <span class="o">=</span> <span class="n">ndata</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">chisqr</span> <span class="o">/</span> <span class="n">ndata</span><span class="p">)</span>
</span><span id="lmfit_fitting_stats-254"><a href="#lmfit_fitting_stats-254"><span class="linenos">254</span></a>    <span class="n">aic</span> <span class="o">=</span> <span class="n">_neg2_log_likel</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nvarys</span> <span class="c1"># AIC</span>
</span><span id="lmfit_fitting_stats-255"><a href="#lmfit_fitting_stats-255"><span class="linenos">255</span></a>    <span class="n">bic</span> <span class="o">=</span> <span class="n">_neg2_log_likel</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span> <span class="o">*</span> <span class="n">nvarys</span> <span class="c1"># BIC</span>
</span><span id="lmfit_fitting_stats-256"><a href="#lmfit_fitting_stats-256"><span class="linenos">256</span></a>    
</span><span id="lmfit_fitting_stats-257"><a href="#lmfit_fitting_stats-257"><span class="linenos">257</span></a>    <span class="k">return</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span>
</span></pre></div>


            <div class="docstring"><p>Computes the fitting statistics (chi-square, reduced chi square, AIC, BIC) for a given fit, as implemented in lmfit 
(source: <a href="https://github.com/lmfit/lmfit-py/blob/master/lmfit/minimizer.py">https://github.com/lmfit/lmfit-py/blob/master/lmfit/minimizer.py</a> line 364)
Input: </p>

<pre><code>- f : model function, callable

- xdata: array

- ydata: array

- popt: returned by curve_fit
</code></pre>

<p>Outputs: </p>

<pre><code>- chisqr

- redchisqr

- AIC

- BIC
</code></pre>

<p>Usage: </p>

<pre><code>residuals, chisqr, redchisqr, aic, bic = lmfit_fitting_stats(f, xdata, ydata, popt)
</code></pre>
</div>


                </section>
                <section id="pretty_covariance">
                            <input id="pretty_covariance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pretty_covariance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="pretty_covariance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pretty_covariance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pretty_covariance-259"><a href="#pretty_covariance-259"><span class="linenos">259</span></a><span class="k">def</span> <span class="nf">pretty_covariance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="pretty_covariance-260"><a href="#pretty_covariance-260"><span class="linenos">260</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="pretty_covariance-261"><a href="#pretty_covariance-261"><span class="linenos">261</span></a><span class="sd">    Save a pretty covariance matrix as a table, with header names, in wide (matrix) and long dataframes</span>
</span><span id="pretty_covariance-262"><a href="#pretty_covariance-262"><span class="linenos">262</span></a>
</span><span id="pretty_covariance-263"><a href="#pretty_covariance-263"><span class="linenos">263</span></a><span class="sd">    Usage:\n</span>
</span><span id="pretty_covariance-264"><a href="#pretty_covariance-264"><span class="linenos">264</span></a><span class="sd">        df_matrix, df_long = pretty_covariance(f, p_cov)</span>
</span><span id="pretty_covariance-265"><a href="#pretty_covariance-265"><span class="linenos">265</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="pretty_covariance-266"><a href="#pretty_covariance-266"><span class="linenos">266</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># list of parameters, popping out first element (time)</span>
</span><span id="pretty_covariance-267"><a href="#pretty_covariance-267"><span class="linenos">267</span></a>    <span class="n">df_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">p_cov</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="pretty_covariance-268"><a href="#pretty_covariance-268"><span class="linenos">268</span></a>    <span class="n">df_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;covariance&#39;</span><span class="p">])</span>
</span><span id="pretty_covariance-269"><a href="#pretty_covariance-269"><span class="linenos">269</span></a>    
</span><span id="pretty_covariance-270"><a href="#pretty_covariance-270"><span class="linenos">270</span></a>    <span class="k">return</span> <span class="n">df_matrix</span><span class="p">,</span> <span class="n">df_long</span>
</span></pre></div>


            <div class="docstring"><p>Save a pretty covariance matrix as a table, with header names, in wide (matrix) and long dataframes</p>

<p>Usage:</p>

<pre><code>df_matrix, df_long = pretty_covariance(f, p_cov)
</code></pre>
</div>


                </section>
                <section id="print_fitting_report">
                            <input id="print_fitting_report-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_fitting_report</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span>, </span><span class="param"><span class="n">xdata</span>, </span><span class="param"><span class="n">ydata</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="print_fitting_report-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#print_fitting_report"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="print_fitting_report-272"><a href="#print_fitting_report-272"><span class="linenos">272</span></a><span class="k">def</span> <span class="nf">print_fitting_report</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="print_fitting_report-273"><a href="#print_fitting_report-273"><span class="linenos">273</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="print_fitting_report-274"><a href="#print_fitting_report-274"><span class="linenos">274</span></a><span class="sd">    Similar to LMFIT report \n</span>
</span><span id="print_fitting_report-275"><a href="#print_fitting_report-275"><span class="linenos">275</span></a><span class="sd">        [[Fit Statistics]]</span>
</span><span id="print_fitting_report-276"><a href="#print_fitting_report-276"><span class="linenos">276</span></a><span class="sd">            # fitting method   = Nelder-Mead</span>
</span><span id="print_fitting_report-277"><a href="#print_fitting_report-277"><span class="linenos">277</span></a><span class="sd">            # function evals   = 491</span>
</span><span id="print_fitting_report-278"><a href="#print_fitting_report-278"><span class="linenos">278</span></a><span class="sd">            # data points      = 44</span>
</span><span id="print_fitting_report-279"><a href="#print_fitting_report-279"><span class="linenos">279</span></a><span class="sd">            # variables        = 4</span>
</span><span id="print_fitting_report-280"><a href="#print_fitting_report-280"><span class="linenos">280</span></a><span class="sd">            chi-square         = 3.87297297 </span>
</span><span id="print_fitting_report-281"><a href="#print_fitting_report-281"><span class="linenos">281</span></a><span class="sd">            reduced chi-square = 0.09682432 </span>
</span><span id="print_fitting_report-282"><a href="#print_fitting_report-282"><span class="linenos">282</span></a><span class="sd">            Akaike info crit   = -98.9273573</span>
</span><span id="print_fitting_report-283"><a href="#print_fitting_report-283"><span class="linenos">283</span></a><span class="sd">            Bayesian info crit = -91.7905988</span>
</span><span id="print_fitting_report-284"><a href="#print_fitting_report-284"><span class="linenos">284</span></a><span class="sd">        [[Variables]]</span>
</span><span id="print_fitting_report-285"><a href="#print_fitting_report-285"><span class="linenos">285</span></a><span class="sd">            k1:  1.1683e-05 +/- 5.1274e-07 (4.39%) (init = 0)</span>
</span><span id="print_fitting_report-286"><a href="#print_fitting_report-286"><span class="linenos">286</span></a><span class="sd">            k2:  4.47275357 +/- 1.84402220 (41.23%) (init = 0)</span>
</span><span id="print_fitting_report-287"><a href="#print_fitting_report-287"><span class="linenos">287</span></a><span class="sd">            c1:  97.6338853 +/- 0.07100370 (0.07%) (init = 0)</span>
</span><span id="print_fitting_report-288"><a href="#print_fitting_report-288"><span class="linenos">288</span></a><span class="sd">            c2:  2.36617997 +/- 0.31931764 (13.50%) (init = 0)</span>
</span><span id="print_fitting_report-289"><a href="#print_fitting_report-289"><span class="linenos">289</span></a><span class="sd">        [[Correlations]] (unreported correlations are &lt; 0.100)</span>
</span><span id="print_fitting_report-290"><a href="#print_fitting_report-290"><span class="linenos">290</span></a><span class="sd">            C(k1, c1) = 0.729</span>
</span><span id="print_fitting_report-291"><a href="#print_fitting_report-291"><span class="linenos">291</span></a><span class="sd">            C(k2, c2) = 0.387</span>
</span><span id="print_fitting_report-292"><a href="#print_fitting_report-292"><span class="linenos">292</span></a><span class="sd">            C(c1, c2) = -0.222</span>
</span><span id="print_fitting_report-293"><a href="#print_fitting_report-293"><span class="linenos">293</span></a><span class="sd">            C(k1, c2) = -0.162</span>
</span><span id="print_fitting_report-294"><a href="#print_fitting_report-294"><span class="linenos">294</span></a><span class="sd">            C(k2, c1) = 0.110</span>
</span><span id="print_fitting_report-295"><a href="#print_fitting_report-295"><span class="linenos">295</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="print_fitting_report-296"><a href="#print_fitting_report-296"><span class="linenos">296</span></a>    <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span> <span class="o">=</span> <span class="n">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="print_fitting_report-297"><a href="#print_fitting_report-297"><span class="linenos">297</span></a>    <span class="n">df_matrix</span><span class="p">,</span> <span class="n">df_long</span> <span class="o">=</span> <span class="n">pretty_covariance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="print_fitting_report-298"><a href="#print_fitting_report-298"><span class="linenos">298</span></a>    
</span><span id="print_fitting_report-299"><a href="#print_fitting_report-299"><span class="linenos">299</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Fit Statistics]]&quot;</span><span class="p">)</span>
</span><span id="print_fitting_report-300"><a href="#print_fitting_report-300"><span class="linenos">300</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    # data points: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
</span><span id="print_fitting_report-301"><a href="#print_fitting_report-301"><span class="linenos">301</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    # variables: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_opt</span><span class="p">))</span>
</span><span id="print_fitting_report-302"><a href="#print_fitting_report-302"><span class="linenos">302</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    chi-square: &quot;</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">)</span>
</span><span id="print_fitting_report-303"><a href="#print_fitting_report-303"><span class="linenos">303</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    reduced chi-square: &quot;</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">)</span>
</span><span id="print_fitting_report-304"><a href="#print_fitting_report-304"><span class="linenos">304</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Akaike info crit: &quot;</span><span class="p">,</span> <span class="n">aic</span><span class="p">)</span>
</span><span id="print_fitting_report-305"><a href="#print_fitting_report-305"><span class="linenos">305</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Bayesian info crit: &quot;</span><span class="p">,</span> <span class="n">bic</span><span class="p">)</span>
</span><span id="print_fitting_report-306"><a href="#print_fitting_report-306"><span class="linenos">306</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Variables]]&quot;</span><span class="p">)</span>
</span><span id="print_fitting_report-307"><a href="#print_fitting_report-307"><span class="linenos">307</span></a>    <span class="c1"># for loop - standard deviations, absolute values</span>
</span><span id="print_fitting_report-308"><a href="#print_fitting_report-308"><span class="linenos">308</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="print_fitting_report-309"><a href="#print_fitting_report-309"><span class="linenos">309</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> +/- </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> %)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span><span class="o">/</span><span class="n">p_opt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> <span class="p">))</span>
</span><span id="print_fitting_report-310"><a href="#print_fitting_report-310"><span class="linenos">310</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[[Correlations]] (unreported correlations are &lt; 0.100)&quot;</span><span class="p">)</span>
</span><span id="print_fitting_report-311"><a href="#print_fitting_report-311"><span class="linenos">311</span></a>    <span class="c1"># for loop - correlations, normalised as in lmfit</span>
</span><span id="print_fitting_report-312"><a href="#print_fitting_report-312"><span class="linenos">312</span></a>    <span class="n">correls</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="print_fitting_report-313"><a href="#print_fitting_report-313"><span class="linenos">313</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="print_fitting_report-314"><a href="#print_fitting_report-314"><span class="linenos">314</span></a>        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="print_fitting_report-315"><a href="#print_fitting_report-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="print_fitting_report-316"><a href="#print_fitting_report-316"><span class="linenos">316</span></a>                <span class="n">corr</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span><span class="n">p2</span><span class="p">])</span> <span class="p">)</span>
</span><span id="print_fitting_report-317"><a href="#print_fitting_report-317"><span class="linenos">317</span></a>                <span class="n">correls</span><span class="p">[</span><span class="n">p1</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="n">p2</span><span class="p">]</span><span class="o">=</span> <span class="n">corr</span>
</span><span id="print_fitting_report-318"><a href="#print_fitting_report-318"><span class="linenos">318</span></a>    <span class="n">sort_correls</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">correls</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="print_fitting_report-319"><a href="#print_fitting_report-319"><span class="linenos">319</span></a>    <span class="n">sort_correls</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="print_fitting_report-320"><a href="#print_fitting_report-320"><span class="linenos">320</span></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">sort_correls</span><span class="p">:</span>
</span><span id="print_fitting_report-321"><a href="#print_fitting_report-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">corr</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">):</span>
</span><span id="print_fitting_report-322"><a href="#print_fitting_report-322"><span class="linenos">322</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    C(</span><span class="si">{}</span><span class="s2">) = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Similar to LMFIT report </p>

<pre><code>[[Fit Statistics]]
    # fitting method   = Nelder-Mead
    # function evals   = 491
    # data points      = 44
    # variables        = 4
    chi-square         = 3.87297297 
    reduced chi-square = 0.09682432 
    Akaike info crit   = -98.9273573
    Bayesian info crit = -91.7905988
[[Variables]]
    k1:  1.1683e-05 +/- 5.1274e-07 (4.39%) (init = 0)
    k2:  4.47275357 +/- 1.84402220 (41.23%) (init = 0)
    c1:  97.6338853 +/- 0.07100370 (0.07%) (init = 0)
    c2:  2.36617997 +/- 0.31931764 (13.50%) (init = 0)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(k1, c1) = 0.729
    C(k2, c2) = 0.387
    C(c1, c2) = -0.222
    C(k1, c2) = -0.162
    C(k2, c1) = 0.110
</code></pre>
</div>


                </section>
                <section id="do_the_fit">
                            <input id="do_the_fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_the_fit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">f_model</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">doubleExp</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>,</span><span class="param">	<span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>,</span><span class="param">	<span class="n">p0</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">method</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">)</span>,</span><span class="param">	<span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">full_output</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">maxfev</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="do_the_fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#do_the_fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="do_the_fit-326"><a href="#do_the_fit-326"><span class="linenos">326</span></a><span class="k">def</span> <span class="nf">do_the_fit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">doubleExp</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="do_the_fit-327"><a href="#do_the_fit-327"><span class="linenos">327</span></a>    <span class="sd">&#39;&#39;&#39; Does the fitting for one observation, and returns the parameters of interest, using scipy.curve_fit</span>
</span><span id="do_the_fit-328"><a href="#do_the_fit-328"><span class="linenos">328</span></a>
</span><span id="do_the_fit-329"><a href="#do_the_fit-329"><span class="linenos">329</span></a><span class="sd">    Inputs: \n</span>
</span><span id="do_the_fit-330"><a href="#do_the_fit-330"><span class="linenos">330</span></a><span class="sd">        - f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel </span>
</span><span id="do_the_fit-331"><a href="#do_the_fit-331"><span class="linenos">331</span></a><span class="sd">        - xdata: timesteps array, in days</span>
</span><span id="do_the_fit-332"><a href="#do_the_fit-332"><span class="linenos">332</span></a><span class="sd">        - ydata: decay array</span>
</span><span id="do_the_fit-333"><a href="#do_the_fit-333"><span class="linenos">333</span></a><span class="sd">        - p0: initial guess for optimal parameters, in curve_vit, otherwise set to 1</span>
</span><span id="do_the_fit-334"><a href="#do_the_fit-334"><span class="linenos">334</span></a><span class="sd">        - method: algorithm for fitting in curve_fit, {lm, trf, dogbox},</span>
</span><span id="do_the_fit-335"><a href="#do_the_fit-335"><span class="linenos">335</span></a><span class="sd">        - bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar</span>
</span><span id="do_the_fit-336"><a href="#do_the_fit-336"><span class="linenos">336</span></a><span class="sd">                Here, parameters are either: doubleExp: 0&lt;k1,k2&lt;c1&lt;100</span>
</span><span id="do_the_fit-337"><a href="#do_the_fit-337"><span class="linenos">337</span></a><span class="sd">                                             singleExp: 0&lt;k&lt;c&lt;100</span>
</span><span id="do_the_fit-338"><a href="#do_the_fit-338"><span class="linenos">338</span></a><span class="sd">                                             linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)</span>
</span><span id="do_the_fit-339"><a href="#do_the_fit-339"><span class="linenos">339</span></a><span class="sd">                TO DO: pass bounds with the function choice?</span>
</span><span id="do_the_fit-340"><a href="#do_the_fit-340"><span class="linenos">340</span></a><span class="sd">        </span>
</span><span id="do_the_fit-341"><a href="#do_the_fit-341"><span class="linenos">341</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="do_the_fit-342"><a href="#do_the_fit-342"><span class="linenos">342</span></a><span class="sd">        - fitted paramters, </span>
</span><span id="do_the_fit-343"><a href="#do_the_fit-343"><span class="linenos">343</span></a><span class="sd">        - standard deviation of parameters, aboslute and relative</span>
</span><span id="do_the_fit-344"><a href="#do_the_fit-344"><span class="linenos">344</span></a><span class="sd">        - covariance matrix of fitted parameters</span>
</span><span id="do_the_fit-345"><a href="#do_the_fit-345"><span class="linenos">345</span></a><span class="sd">        - scaled correlations between parameters</span>
</span><span id="do_the_fit-346"><a href="#do_the_fit-346"><span class="linenos">346</span></a><span class="sd">        - stability estimates as BC100, apparent MRT, half-life </span>
</span><span id="do_the_fit-347"><a href="#do_the_fit-347"><span class="linenos">347</span></a><span class="sd">        - r2 of fit (whether relevant or not)</span>
</span><span id="do_the_fit-348"><a href="#do_the_fit-348"><span class="linenos">348</span></a><span class="sd">        - other statisical indicator, chi, ... </span>
</span><span id="do_the_fit-349"><a href="#do_the_fit-349"><span class="linenos">349</span></a><span class="sd">        - residuals of fit </span>
</span><span id="do_the_fit-350"><a href="#do_the_fit-350"><span class="linenos">350</span></a>
</span><span id="do_the_fit-351"><a href="#do_the_fit-351"><span class="linenos">351</span></a><span class="sd">        - outcome of simple checks (passed failed)</span>
</span><span id="do_the_fit-352"><a href="#do_the_fit-352"><span class="linenos">352</span></a>
</span><span id="do_the_fit-353"><a href="#do_the_fit-353"><span class="linenos">353</span></a><span class="sd">    Usage:  \n</span>
</span><span id="do_the_fit-354"><a href="#do_the_fit-354"><span class="linenos">354</span></a><span class="sd">        p_opt, p_cov, p_std, r2, stab_dict = do_the_fit(f_model=doubleExp, xdata, ydata, p0=None, method=None, bounds=(-1*np.inf, np.inf))</span>
</span><span id="do_the_fit-355"><a href="#do_the_fit-355"><span class="linenos">355</span></a><span class="sd">    </span>
</span><span id="do_the_fit-356"><a href="#do_the_fit-356"><span class="linenos">356</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="do_the_fit-357"><a href="#do_the_fit-357"><span class="linenos">357</span></a>    <span class="c1"># Fitting</span>
</span><span id="do_the_fit-358"><a href="#do_the_fit-358"><span class="linenos">358</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="do_the_fit-359"><a href="#do_the_fit-359"><span class="linenos">359</span></a>        <span class="n">fitting_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="do_the_fit-360"><a href="#do_the_fit-360"><span class="linenos">360</span></a>        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span> <span class="c1"># for testing on single observations</span>
</span><span id="do_the_fit-361"><a href="#do_the_fit-361"><span class="linenos">361</span></a>            <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="do_the_fit-362"><a href="#do_the_fit-362"><span class="linenos">362</span></a>                                 <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="n">full_output</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
</span><span id="do_the_fit-363"><a href="#do_the_fit-363"><span class="linenos">363</span></a>                                 <span class="c1"># sigma=ydata*0.05 ## to add noise/error on ydata</span>
</span><span id="do_the_fit-364"><a href="#do_the_fit-364"><span class="linenos">364</span></a>            <span class="k">return</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span>
</span><span id="do_the_fit-365"><a href="#do_the_fit-365"><span class="linenos">365</span></a>
</span><span id="do_the_fit-366"><a href="#do_the_fit-366"><span class="linenos">366</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="do_the_fit-367"><a href="#do_the_fit-367"><span class="linenos">367</span></a>            <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span>  <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> 
</span><span id="do_the_fit-368"><a href="#do_the_fit-368"><span class="linenos">368</span></a>                                 <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
</span><span id="do_the_fit-369"><a href="#do_the_fit-369"><span class="linenos">369</span></a>                                 <span class="c1"># sigma=ydata*0.05 ## to add noise/error on ydata</span>
</span><span id="do_the_fit-370"><a href="#do_the_fit-370"><span class="linenos">370</span></a>        <span class="n">df_matrix</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pretty_covariance</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="do_the_fit-371"><a href="#do_the_fit-371"><span class="linenos">371</span></a>
</span><span id="do_the_fit-372"><a href="#do_the_fit-372"><span class="linenos">372</span></a>        <span class="n">p_names</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># p_names[0] = time, p_names[1:] = all other parameters, in same order as p_opt</span>
</span><span id="do_the_fit-373"><a href="#do_the_fit-373"><span class="linenos">373</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-374"><a href="#do_the_fit-374"><span class="linenos">374</span></a>            <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-375"><a href="#do_the_fit-375"><span class="linenos">375</span></a>                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%/day&#39;</span>
</span><span id="do_the_fit-376"><a href="#do_the_fit-376"><span class="linenos">376</span></a>            <span class="k">elif</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-377"><a href="#do_the_fit-377"><span class="linenos">377</span></a>                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span>
</span><span id="do_the_fit-378"><a href="#do_the_fit-378"><span class="linenos">378</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="do_the_fit-379"><a href="#do_the_fit-379"><span class="linenos">379</span></a>                <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;na&#39;</span>
</span><span id="do_the_fit-380"><a href="#do_the_fit-380"><span class="linenos">380</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="do_the_fit-381"><a href="#do_the_fit-381"><span class="linenos">381</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span>
</span><span id="do_the_fit-382"><a href="#do_the_fit-382"><span class="linenos">382</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span><span class="o">/</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span> 
</span><span id="do_the_fit-383"><a href="#do_the_fit-383"><span class="linenos">383</span></a>
</span><span id="do_the_fit-384"><a href="#do_the_fit-384"><span class="linenos">384</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
</span><span id="do_the_fit-385"><a href="#do_the_fit-385"><span class="linenos">385</span></a>            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="do_the_fit-386"><a href="#do_the_fit-386"><span class="linenos">386</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="do_the_fit-387"><a href="#do_the_fit-387"><span class="linenos">387</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span>
</span><span id="do_the_fit-388"><a href="#do_the_fit-388"><span class="linenos">388</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="n">p1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p2</span><span class="p">,</span><span class="n">p2</span><span class="p">])</span> <span class="p">)</span>
</span><span id="do_the_fit-389"><a href="#do_the_fit-389"><span class="linenos">389</span></a>                    
</span><span id="do_the_fit-390"><a href="#do_the_fit-390"><span class="linenos">390</span></a>
</span><span id="do_the_fit-391"><a href="#do_the_fit-391"><span class="linenos">391</span></a>        <span class="c1"># Other parameters</span>
</span><span id="do_the_fit-392"><a href="#do_the_fit-392"><span class="linenos">392</span></a>        <span class="n">f_opt</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="c1"># fitted curve</span>
</span><span id="do_the_fit-393"><a href="#do_the_fit-393"><span class="linenos">393</span></a>        <span class="n">p_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">p_cov</span><span class="p">))</span> <span class="c1"># Standard deviation of each parameter  </span>
</span><span id="do_the_fit-394"><a href="#do_the_fit-394"><span class="linenos">394</span></a>        <span class="n">r2</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">rsquare</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="do_the_fit-395"><a href="#do_the_fit-395"><span class="linenos">395</span></a>        <span class="n">residuals</span><span class="p">,</span> <span class="n">chisqr</span><span class="p">,</span> <span class="n">redchisqr</span><span class="p">,</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span> <span class="o">=</span> <span class="n">lmfit_fitting_stats</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-396"><a href="#do_the_fit-396"><span class="linenos">396</span></a>        <span class="n">DW</span> <span class="o">=</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="do_the_fit-397"><a href="#do_the_fit-397"><span class="linenos">397</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r2</span>
</span><span id="do_the_fit-398"><a href="#do_the_fit-398"><span class="linenos">398</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;chisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chisqr</span>
</span><span id="do_the_fit-399"><a href="#do_the_fit-399"><span class="linenos">399</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;redchisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">redchisqr</span>
</span><span id="do_the_fit-400"><a href="#do_the_fit-400"><span class="linenos">400</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;aic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">aic</span>
</span><span id="do_the_fit-401"><a href="#do_the_fit-401"><span class="linenos">401</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bic</span>
</span><span id="do_the_fit-402"><a href="#do_the_fit-402"><span class="linenos">402</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;dw&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DW</span>
</span><span id="do_the_fit-403"><a href="#do_the_fit-403"><span class="linenos">403</span></a>
</span><span id="do_the_fit-404"><a href="#do_the_fit-404"><span class="linenos">404</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">residuals</span> <span class="c1"># vector, likely not to save in an Excel table</span>
</span><span id="do_the_fit-405"><a href="#do_the_fit-405"><span class="linenos">405</span></a>        
</span><span id="do_the_fit-406"><a href="#do_the_fit-406"><span class="linenos">406</span></a>        <span class="c1"># Physical checks</span>
</span><span id="do_the_fit-407"><a href="#do_the_fit-407"><span class="linenos">407</span></a>        <span class="k">def</span> <span class="nf">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_fit-408"><a href="#do_the_fit-408"><span class="linenos">408</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all decay rates have a positive value&#39;&#39;&#39;</span>
</span><span id="do_the_fit-409"><a href="#do_the_fit-409"><span class="linenos">409</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_fit-410"><a href="#do_the_fit-410"><span class="linenos">410</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-411"><a href="#do_the_fit-411"><span class="linenos">411</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-412"><a href="#do_the_fit-412"><span class="linenos">412</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="do_the_fit-413"><a href="#do_the_fit-413"><span class="linenos">413</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_fit-414"><a href="#do_the_fit-414"><span class="linenos">414</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_fit-415"><a href="#do_the_fit-415"><span class="linenos">415</span></a>        <span class="k">def</span> <span class="nf">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_fit-416"><a href="#do_the_fit-416"><span class="linenos">416</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a positive value&#39;&#39;&#39;</span>
</span><span id="do_the_fit-417"><a href="#do_the_fit-417"><span class="linenos">417</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_fit-418"><a href="#do_the_fit-418"><span class="linenos">418</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-419"><a href="#do_the_fit-419"><span class="linenos">419</span></a>                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-420"><a href="#do_the_fit-420"><span class="linenos">420</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="do_the_fit-421"><a href="#do_the_fit-421"><span class="linenos">421</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_fit-422"><a href="#do_the_fit-422"><span class="linenos">422</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_fit-423"><a href="#do_the_fit-423"><span class="linenos">423</span></a>
</span><span id="do_the_fit-424"><a href="#do_the_fit-424"><span class="linenos">424</span></a>        <span class="k">def</span> <span class="nf">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_fit-425"><a href="#do_the_fit-425"><span class="linenos">425</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a value below 100%&#39;&#39;&#39;</span>
</span><span id="do_the_fit-426"><a href="#do_the_fit-426"><span class="linenos">426</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_fit-427"><a href="#do_the_fit-427"><span class="linenos">427</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-428"><a href="#do_the_fit-428"><span class="linenos">428</span></a>                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-429"><a href="#do_the_fit-429"><span class="linenos">429</span></a>                    <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
</span><span id="do_the_fit-430"><a href="#do_the_fit-430"><span class="linenos">430</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_fit-431"><a href="#do_the_fit-431"><span class="linenos">431</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_fit-432"><a href="#do_the_fit-432"><span class="linenos">432</span></a>
</span><span id="do_the_fit-433"><a href="#do_the_fit-433"><span class="linenos">433</span></a>        <span class="k">def</span> <span class="nf">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_fit-434"><a href="#do_the_fit-434"><span class="linenos">434</span></a>            <span class="sd">&#39;&#39;&#39;Calculates the total C at time = 0. Ideally should be as close as possible to 100%&#39;&#39;&#39;</span>
</span><span id="do_the_fit-435"><a href="#do_the_fit-435"><span class="linenos">435</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-436"><a href="#do_the_fit-436"><span class="linenos">436</span></a>
</span><span id="do_the_fit-437"><a href="#do_the_fit-437"><span class="linenos">437</span></a>        <span class="k">def</span> <span class="nf">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">df_matrix</span><span class="p">):</span>
</span><span id="do_the_fit-438"><a href="#do_the_fit-438"><span class="linenos">438</span></a>            <span class="sd">&#39;&#39;&#39;Verifies that all parameters have a abs stdev smaller than absolute value of param</span>
</span><span id="do_the_fit-439"><a href="#do_the_fit-439"><span class="linenos">439</span></a><span class="sd">                i.e. np.abs(stdev) &lt; np.aps(param)</span>
</span><span id="do_the_fit-440"><a href="#do_the_fit-440"><span class="linenos">440</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="do_the_fit-441"><a href="#do_the_fit-441"><span class="linenos">441</span></a>            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_fit-442"><a href="#do_the_fit-442"><span class="linenos">442</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-443"><a href="#do_the_fit-443"><span class="linenos">443</span></a>                    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="p">])</span>
</span><span id="do_the_fit-444"><a href="#do_the_fit-444"><span class="linenos">444</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
</span><span id="do_the_fit-445"><a href="#do_the_fit-445"><span class="linenos">445</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_fit-446"><a href="#do_the_fit-446"><span class="linenos">446</span></a>            <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_fit-447"><a href="#do_the_fit-447"><span class="linenos">447</span></a>        <span class="k">def</span> <span class="nf">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">odm</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="do_the_fit-448"><a href="#do_the_fit-448"><span class="linenos">448</span></a>            <span class="sd">&#39;&#39;&#39;For exponential models only, with multiple pools, verifies that the decay rates have at least n order of magnitude difference when expressed in %/year</span>
</span><span id="do_the_fit-449"><a href="#do_the_fit-449"><span class="linenos">449</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="do_the_fit-450"><a href="#do_the_fit-450"><span class="linenos">450</span></a>            <span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="do_the_fit-451"><a href="#do_the_fit-451"><span class="linenos">451</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_fit-452"><a href="#do_the_fit-452"><span class="linenos">452</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_fit-453"><a href="#do_the_fit-453"><span class="linenos">453</span></a>                    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># conversion to %/year, from %/day</span>
</span><span id="do_the_fit-454"><a href="#do_the_fit-454"><span class="linenos">454</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="do_the_fit-455"><a href="#do_the_fit-455"><span class="linenos">455</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="do_the_fit-456"><a href="#do_the_fit-456"><span class="linenos">456</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="do_the_fit-457"><a href="#do_the_fit-457"><span class="linenos">457</span></a>                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="do_the_fit-458"><a href="#do_the_fit-458"><span class="linenos">458</span></a>                            <span class="k">return</span> <span class="kc">False</span>
</span><span id="do_the_fit-459"><a href="#do_the_fit-459"><span class="linenos">459</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="do_the_fit-460"><a href="#do_the_fit-460"><span class="linenos">460</span></a>
</span><span id="do_the_fit-461"><a href="#do_the_fit-461"><span class="linenos">461</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-462"><a href="#do_the_fit-462"><span class="linenos">462</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-463"><a href="#do_the_fit-463"><span class="linenos">463</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes below100&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-464"><a href="#do_the_fit-464"><span class="linenos">464</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-465"><a href="#do_the_fit-465"><span class="linenos">465</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter constrained&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">df_matrix</span><span class="p">)</span>
</span><span id="do_the_fit-466"><a href="#do_the_fit-466"><span class="linenos">466</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates 1 odm diff&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_fit-467"><a href="#do_the_fit-467"><span class="linenos">467</span></a>
</span><span id="do_the_fit-468"><a href="#do_the_fit-468"><span class="linenos">468</span></a>        <span class="c1"># Stability values</span>
</span><span id="do_the_fit-469"><a href="#do_the_fit-469"><span class="linenos">469</span></a>        <span class="n">t100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">365</span> <span class="c1"># 100 years in days</span>
</span><span id="do_the_fit-470"><a href="#do_the_fit-470"><span class="linenos">470</span></a>        <span class="n">BC100</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># remaning after 100 years</span>
</span><span id="do_the_fit-471"><a href="#do_the_fit-471"><span class="linenos">471</span></a>
</span><span id="do_the_fit-472"><a href="#do_the_fit-472"><span class="linenos">472</span></a>        <span class="k">def</span> <span class="nf">f12</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="do_the_fit-473"><a href="#do_the_fit-473"><span class="linenos">473</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">50.</span>
</span><span id="do_the_fit-474"><a href="#do_the_fit-474"><span class="linenos">474</span></a>        <span class="n">t12</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">f12</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># half-life time, 50% C remaining</span>
</span><span id="do_the_fit-475"><a href="#do_the_fit-475"><span class="linenos">475</span></a>        <span class="n">t12</span> <span class="o">=</span> <span class="n">t12</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="do_the_fit-476"><a href="#do_the_fit-476"><span class="linenos">476</span></a>        
</span><span id="do_the_fit-477"><a href="#do_the_fit-477"><span class="linenos">477</span></a>        <span class="k">def</span> <span class="nf">fMRT</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="do_the_fit-478"><a href="#do_the_fit-478"><span class="linenos">478</span></a>            <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="do_the_fit-479"><a href="#do_the_fit-479"><span class="linenos">479</span></a>        <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">fMRT</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># apparent MRT, np.exp(-1) = 36.8% C remaining</span>
</span><span id="do_the_fit-480"><a href="#do_the_fit-480"><span class="linenos">480</span></a>        <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="do_the_fit-481"><a href="#do_the_fit-481"><span class="linenos">481</span></a>        
</span><span id="do_the_fit-482"><a href="#do_the_fit-482"><span class="linenos">482</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BC100</span>
</span><span id="do_the_fit-483"><a href="#do_the_fit-483"><span class="linenos">483</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;t12&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span>
</span><span id="do_the_fit-484"><a href="#do_the_fit-484"><span class="linenos">484</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;MRTa&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span>
</span><span id="do_the_fit-485"><a href="#do_the_fit-485"><span class="linenos">485</span></a>
</span><span id="do_the_fit-486"><a href="#do_the_fit-486"><span class="linenos">486</span></a>        <span class="n">stab_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BC100&#39;</span><span class="p">:</span> <span class="n">BC100</span><span class="p">,</span> 
</span><span id="do_the_fit-487"><a href="#do_the_fit-487"><span class="linenos">487</span></a>                     <span class="s1">&#39;t12&#39;</span><span class="p">:</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="c1"># in years</span>
</span><span id="do_the_fit-488"><a href="#do_the_fit-488"><span class="linenos">488</span></a>                     <span class="s1">&#39;MRTa&#39;</span><span class="p">:</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span> <span class="c1"># in years</span>
</span><span id="do_the_fit-489"><a href="#do_the_fit-489"><span class="linenos">489</span></a>                    <span class="p">}</span>
</span><span id="do_the_fit-490"><a href="#do_the_fit-490"><span class="linenos">490</span></a>
</span><span id="do_the_fit-491"><a href="#do_the_fit-491"><span class="linenos">491</span></a>        <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
</span><span id="do_the_fit-492"><a href="#do_the_fit-492"><span class="linenos">492</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="do_the_fit-493"><a href="#do_the_fit-493"><span class="linenos">493</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
</span><span id="do_the_fit-494"><a href="#do_the_fit-494"><span class="linenos">494</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="do_the_fit-495"><a href="#do_the_fit-495"><span class="linenos">495</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="do_the_fit-496"><a href="#do_the_fit-496"><span class="linenos">496</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="do_the_fit-497"><a href="#do_the_fit-497"><span class="linenos">497</span></a>
</span><span id="do_the_fit-498"><a href="#do_the_fit-498"><span class="linenos">498</span></a>            <span class="n">print_fitting_report</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="o">=</span><span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="o">=</span><span class="n">p_cov</span><span class="p">)</span>
</span><span id="do_the_fit-499"><a href="#do_the_fit-499"><span class="linenos">499</span></a>
</span><span id="do_the_fit-500"><a href="#do_the_fit-500"><span class="linenos">500</span></a>        <span class="k">return</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">p_std</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">stab_dict</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">fitting_output</span>
</span><span id="do_the_fit-501"><a href="#do_the_fit-501"><span class="linenos">501</span></a>        
</span><span id="do_the_fit-502"><a href="#do_the_fit-502"><span class="linenos">502</span></a>    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="do_the_fit-503"><a href="#do_the_fit-503"><span class="linenos">503</span></a>        <span class="c1"># RuntimeError: Optimal parameters not found: The maximum number of function evaluations is exceeded.</span>
</span><span id="do_the_fit-504"><a href="#do_the_fit-504"><span class="linenos">504</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="do_the_fit-505"><a href="#do_the_fit-505"><span class="linenos">505</span></a>        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{}</span>
</span><span id="do_the_fit-506"><a href="#do_the_fit-506"><span class="linenos">506</span></a>    
</span><span id="do_the_fit-507"><a href="#do_the_fit-507"><span class="linenos">507</span></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="do_the_fit-508"><a href="#do_the_fit-508"><span class="linenos">508</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="do_the_fit-509"><a href="#do_the_fit-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{}</span>   
</span></pre></div>


            <div class="docstring"><p>Does the fitting for one observation, and returns the parameters of interest, using scipy.curve_fit</p>

<p>Inputs: </p>

<pre><code>- f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel 
- xdata: timesteps array, in days
- ydata: decay array
- p0: initial guess for optimal parameters, in curve_vit, otherwise set to 1
- method: algorithm for fitting in curve_fit, {lm, trf, dogbox},
- bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar
        Here, parameters are either: doubleExp: 0&lt;k1,k2&lt;c1&lt;100
                                     singleExp: 0&lt;k&lt;c&lt;100
                                     linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)
        TO DO: pass bounds with the function choice?
</code></pre>

<p>Outputs:  </p>

<pre><code>- fitted paramters, 
- standard deviation of parameters, aboslute and relative
- covariance matrix of fitted parameters
- scaled correlations between parameters
- stability estimates as BC100, apparent MRT, half-life 
- r2 of fit (whether relevant or not)
- other statisical indicator, chi, ... 
- residuals of fit 

- outcome of simple checks (passed failed)
</code></pre>

<p>Usage:  </p>

<pre><code>p_opt, p_cov, p_std, r2, stab_dict = do_the_fit(f_model=doubleExp, xdata, ydata, p0=None, method=None, bounds=(-1*np.inf, np.inf))
</code></pre>
</div>


                </section>
                <section id="do_the_lmfit">
                            <input id="do_the_lmfit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_the_lmfit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">f_model</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">doubleExp_u</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>,</span><span class="param">	<span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>,</span><span class="param">	<span class="n">method</span><span class="o">=</span><span class="s1">&#39;trf&#39;</span>,</span><span class="param">	<span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>,</span><span class="param">	<span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="do_the_lmfit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#do_the_lmfit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="do_the_lmfit-512"><a href="#do_the_lmfit-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">do_the_lmfit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">doubleExp_u</span><span class="p">,</span> 
</span><span id="do_the_lmfit-513"><a href="#do_the_lmfit-513"><span class="linenos">513</span></a>               <span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="do_the_lmfit-514"><a href="#do_the_lmfit-514"><span class="linenos">514</span></a>               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trf&#39;</span><span class="p">,</span>
</span><span id="do_the_lmfit-515"><a href="#do_the_lmfit-515"><span class="linenos">515</span></a>               <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
</span><span id="do_the_lmfit-516"><a href="#do_the_lmfit-516"><span class="linenos">516</span></a>               <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="do_the_lmfit-517"><a href="#do_the_lmfit-517"><span class="linenos">517</span></a>               <span class="p">):</span>
</span><span id="do_the_lmfit-518"><a href="#do_the_lmfit-518"><span class="linenos">518</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-519"><a href="#do_the_lmfit-519"><span class="linenos">519</span></a><span class="sd">    Does the fitting for one observation, and returns the parameters of interest, using lmfit.minimize</span>
</span><span id="do_the_lmfit-520"><a href="#do_the_lmfit-520"><span class="linenos">520</span></a>
</span><span id="do_the_lmfit-521"><a href="#do_the_lmfit-521"><span class="linenos">521</span></a><span class="sd">    Inputs: \n</span>
</span><span id="do_the_lmfit-522"><a href="#do_the_lmfit-522"><span class="linenos">522</span></a><span class="sd">        - f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel </span>
</span><span id="do_the_lmfit-523"><a href="#do_the_lmfit-523"><span class="linenos">523</span></a><span class="sd">        - xdata: timesteps array, in days</span>
</span><span id="do_the_lmfit-524"><a href="#do_the_lmfit-524"><span class="linenos">524</span></a><span class="sd">        - ydata: decay array</span>
</span><span id="do_the_lmfit-525"><a href="#do_the_lmfit-525"><span class="linenos">525</span></a><span class="sd">        - bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar</span>
</span><span id="do_the_lmfit-526"><a href="#do_the_lmfit-526"><span class="linenos">526</span></a><span class="sd">                Here, parameters are either: doubleExp: 0&lt;k1,k2,c1&lt;100</span>
</span><span id="do_the_lmfit-527"><a href="#do_the_lmfit-527"><span class="linenos">527</span></a><span class="sd">                                             singleExp: 0&lt;k&lt;c&lt;100</span>
</span><span id="do_the_lmfit-528"><a href="#do_the_lmfit-528"><span class="linenos">528</span></a><span class="sd">                                             linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)</span>
</span><span id="do_the_lmfit-529"><a href="#do_the_lmfit-529"><span class="linenos">529</span></a><span class="sd">    </span>
</span><span id="do_the_lmfit-530"><a href="#do_the_lmfit-530"><span class="linenos">530</span></a><span class="sd">    TODO: implement use of initial guess, via p0 - list of initial guesses, in params.add(ar, value=, vary=True)</span>
</span><span id="do_the_lmfit-531"><a href="#do_the_lmfit-531"><span class="linenos">531</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-532"><a href="#do_the_lmfit-532"><span class="linenos">532</span></a>    <span class="n">fitting_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="do_the_lmfit-533"><a href="#do_the_lmfit-533"><span class="linenos">533</span></a>    <span class="n">pargs</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># removing the first one, which is always time, list</span>
</span><span id="do_the_lmfit-534"><a href="#do_the_lmfit-534"><span class="linenos">534</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
</span><span id="do_the_lmfit-535"><a href="#do_the_lmfit-535"><span class="linenos">535</span></a>    <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">pargs</span><span class="p">:</span>
</span><span id="do_the_lmfit-536"><a href="#do_the_lmfit-536"><span class="linenos">536</span></a>        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="do_the_lmfit-537"><a href="#do_the_lmfit-537"><span class="linenos">537</span></a>
</span><span id="do_the_lmfit-538"><a href="#do_the_lmfit-538"><span class="linenos">538</span></a>    <span class="k">def</span> <span class="nf">f_model_lmfit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="do_the_lmfit-539"><a href="#do_the_lmfit-539"><span class="linenos">539</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
</span><span id="do_the_lmfit-540"><a href="#do_the_lmfit-540"><span class="linenos">540</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>
</span><span id="do_the_lmfit-541"><a href="#do_the_lmfit-541"><span class="linenos">541</span></a>
</span><span id="do_the_lmfit-542"><a href="#do_the_lmfit-542"><span class="linenos">542</span></a>    <span class="n">fitted_params</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">f_model_lmfit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
</span><span id="do_the_lmfit-543"><a href="#do_the_lmfit-543"><span class="linenos">543</span></a>    <span class="n">p_opt</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">]</span>
</span><span id="do_the_lmfit-544"><a href="#do_the_lmfit-544"><span class="linenos">544</span></a>    <span class="n">r2</span><span class="p">,</span> <span class="n">residuals</span> <span class="o">=</span> <span class="n">rsquare</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-545"><a href="#do_the_lmfit-545"><span class="linenos">545</span></a>    <span class="n">DW</span> <span class="o">=</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="do_the_lmfit-546"><a href="#do_the_lmfit-546"><span class="linenos">546</span></a>
</span><span id="do_the_lmfit-547"><a href="#do_the_lmfit-547"><span class="linenos">547</span></a>    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-548"><a href="#do_the_lmfit-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-549"><a href="#do_the_lmfit-549"><span class="linenos">549</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%/day&#39;</span>
</span><span id="do_the_lmfit-550"><a href="#do_the_lmfit-550"><span class="linenos">550</span></a>        <span class="k">elif</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-551"><a href="#do_the_lmfit-551"><span class="linenos">551</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span>
</span><span id="do_the_lmfit-552"><a href="#do_the_lmfit-552"><span class="linenos">552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="do_the_lmfit-553"><a href="#do_the_lmfit-553"><span class="linenos">553</span></a>            <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;na&#39;</span>
</span><span id="do_the_lmfit-554"><a href="#do_the_lmfit-554"><span class="linenos">554</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</span><span id="do_the_lmfit-555"><a href="#do_the_lmfit-555"><span class="linenos">555</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
</span><span id="do_the_lmfit-556"><a href="#do_the_lmfit-556"><span class="linenos">556</span></a>        <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;stddev_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;std_&#39;</span><span class="o">+</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="o">/</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="do_the_lmfit-557"><a href="#do_the_lmfit-557"><span class="linenos">557</span></a>    
</span><span id="do_the_lmfit-558"><a href="#do_the_lmfit-558"><span class="linenos">558</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">,</span> <span class="s1">&#39;covar&#39;</span><span class="p">):</span>
</span><span id="do_the_lmfit-559"><a href="#do_the_lmfit-559"><span class="linenos">559</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-560"><a href="#do_the_lmfit-560"><span class="linenos">560</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span> <span class="c1"># double for loop, to avoid dupplicates</span>
</span><span id="do_the_lmfit-561"><a href="#do_the_lmfit-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
</span><span id="do_the_lmfit-562"><a href="#do_the_lmfit-562"><span class="linenos">562</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
</span><span id="do_the_lmfit-563"><a href="#do_the_lmfit-563"><span class="linenos">563</span></a>                    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(&#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">covar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="do_the_lmfit-564"><a href="#do_the_lmfit-564"><span class="linenos">564</span></a>
</span><span id="do_the_lmfit-565"><a href="#do_the_lmfit-565"><span class="linenos">565</span></a>    
</span><span id="do_the_lmfit-566"><a href="#do_the_lmfit-566"><span class="linenos">566</span></a>   
</span><span id="do_the_lmfit-567"><a href="#do_the_lmfit-567"><span class="linenos">567</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r2</span>
</span><span id="do_the_lmfit-568"><a href="#do_the_lmfit-568"><span class="linenos">568</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;chisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">chisqr</span>
</span><span id="do_the_lmfit-569"><a href="#do_the_lmfit-569"><span class="linenos">569</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;redchisqr&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">redchi</span>
</span><span id="do_the_lmfit-570"><a href="#do_the_lmfit-570"><span class="linenos">570</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;aic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">aic</span>
</span><span id="do_the_lmfit-571"><a href="#do_the_lmfit-571"><span class="linenos">571</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">bic</span>
</span><span id="do_the_lmfit-572"><a href="#do_the_lmfit-572"><span class="linenos">572</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;dw&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DW</span>
</span><span id="do_the_lmfit-573"><a href="#do_the_lmfit-573"><span class="linenos">573</span></a>
</span><span id="do_the_lmfit-574"><a href="#do_the_lmfit-574"><span class="linenos">574</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;goodness&#39;</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">residuals</span> <span class="c1"># vector, likely not to save in an Excel table</span>
</span><span id="do_the_lmfit-575"><a href="#do_the_lmfit-575"><span class="linenos">575</span></a>    
</span><span id="do_the_lmfit-576"><a href="#do_the_lmfit-576"><span class="linenos">576</span></a>    <span class="c1"># Physical checks</span>
</span><span id="do_the_lmfit-577"><a href="#do_the_lmfit-577"><span class="linenos">577</span></a>    <span class="k">def</span> <span class="nf">check_decay_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_lmfit-578"><a href="#do_the_lmfit-578"><span class="linenos">578</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all decay rates have a positive value&#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-579"><a href="#do_the_lmfit-579"><span class="linenos">579</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_lmfit-580"><a href="#do_the_lmfit-580"><span class="linenos">580</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-581"><a href="#do_the_lmfit-581"><span class="linenos">581</span></a>            <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-582"><a href="#do_the_lmfit-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="do_the_lmfit-583"><a href="#do_the_lmfit-583"><span class="linenos">583</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-584"><a href="#do_the_lmfit-584"><span class="linenos">584</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_lmfit-585"><a href="#do_the_lmfit-585"><span class="linenos">585</span></a>    <span class="k">def</span> <span class="nf">check_pool_positivity</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_lmfit-586"><a href="#do_the_lmfit-586"><span class="linenos">586</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a positive value&#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-587"><a href="#do_the_lmfit-587"><span class="linenos">587</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_lmfit-588"><a href="#do_the_lmfit-588"><span class="linenos">588</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-589"><a href="#do_the_lmfit-589"><span class="linenos">589</span></a>            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-590"><a href="#do_the_lmfit-590"><span class="linenos">590</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="do_the_lmfit-591"><a href="#do_the_lmfit-591"><span class="linenos">591</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-592"><a href="#do_the_lmfit-592"><span class="linenos">592</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_lmfit-593"><a href="#do_the_lmfit-593"><span class="linenos">593</span></a>
</span><span id="do_the_lmfit-594"><a href="#do_the_lmfit-594"><span class="linenos">594</span></a>    <span class="k">def</span> <span class="nf">check_pool_below100</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_lmfit-595"><a href="#do_the_lmfit-595"><span class="linenos">595</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all pool sizes have a value below 100%&#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-596"><a href="#do_the_lmfit-596"><span class="linenos">596</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_lmfit-597"><a href="#do_the_lmfit-597"><span class="linenos">597</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-598"><a href="#do_the_lmfit-598"><span class="linenos">598</span></a>            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-599"><a href="#do_the_lmfit-599"><span class="linenos">599</span></a>                <span class="k">if</span> <span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">100.0</span><span class="p">:</span>
</span><span id="do_the_lmfit-600"><a href="#do_the_lmfit-600"><span class="linenos">600</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-601"><a href="#do_the_lmfit-601"><span class="linenos">601</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_lmfit-602"><a href="#do_the_lmfit-602"><span class="linenos">602</span></a>
</span><span id="do_the_lmfit-603"><a href="#do_the_lmfit-603"><span class="linenos">603</span></a>    <span class="k">def</span> <span class="nf">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">):</span>
</span><span id="do_the_lmfit-604"><a href="#do_the_lmfit-604"><span class="linenos">604</span></a>        <span class="sd">&#39;&#39;&#39;Calculates the total C at time = 0. Ideally should be as close as possible to 100%&#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-605"><a href="#do_the_lmfit-605"><span class="linenos">605</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-606"><a href="#do_the_lmfit-606"><span class="linenos">606</span></a>    
</span><span id="do_the_lmfit-607"><a href="#do_the_lmfit-607"><span class="linenos">607</span></a>    <span class="k">def</span> <span class="nf">check_stdev_constraint</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">):</span>
</span><span id="do_the_lmfit-608"><a href="#do_the_lmfit-608"><span class="linenos">608</span></a>        <span class="sd">&#39;&#39;&#39;Verifies that all parameters have a abs stdev smaller than absolute value of param</span>
</span><span id="do_the_lmfit-609"><a href="#do_the_lmfit-609"><span class="linenos">609</span></a><span class="sd">            i.e. np.abs(stdev) &lt; np.aps(param)</span>
</span><span id="do_the_lmfit-610"><a href="#do_the_lmfit-610"><span class="linenos">610</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-611"><a href="#do_the_lmfit-611"><span class="linenos">611</span></a>        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="do_the_lmfit-612"><a href="#do_the_lmfit-612"><span class="linenos">612</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">):</span>
</span><span id="do_the_lmfit-613"><a href="#do_the_lmfit-613"><span class="linenos">613</span></a>            <span class="n">stdev</span> <span class="o">=</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
</span><span id="do_the_lmfit-614"><a href="#do_the_lmfit-614"><span class="linenos">614</span></a>            <span class="k">if</span> <span class="n">stdev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="do_the_lmfit-615"><a href="#do_the_lmfit-615"><span class="linenos">615</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
</span><span id="do_the_lmfit-616"><a href="#do_the_lmfit-616"><span class="linenos">616</span></a>                        <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-617"><a href="#do_the_lmfit-617"><span class="linenos">617</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="do_the_lmfit-618"><a href="#do_the_lmfit-618"><span class="linenos">618</span></a>                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-619"><a href="#do_the_lmfit-619"><span class="linenos">619</span></a>        <span class="k">return</span> <span class="n">check</span>
</span><span id="do_the_lmfit-620"><a href="#do_the_lmfit-620"><span class="linenos">620</span></a>    
</span><span id="do_the_lmfit-621"><a href="#do_the_lmfit-621"><span class="linenos">621</span></a>    <span class="k">def</span> <span class="nf">check_k_odm_difference</span><span class="p">(</span><span class="n">p_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">odm</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="do_the_lmfit-622"><a href="#do_the_lmfit-622"><span class="linenos">622</span></a>            <span class="sd">&#39;&#39;&#39;For exponential models only, with multiple pools, verifies that the decay rates have at least n order of magnitude difference when expressed in %/year</span>
</span><span id="do_the_lmfit-623"><a href="#do_the_lmfit-623"><span class="linenos">623</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="do_the_lmfit-624"><a href="#do_the_lmfit-624"><span class="linenos">624</span></a>            <span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="do_the_lmfit-625"><a href="#do_the_lmfit-625"><span class="linenos">625</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="do_the_lmfit-626"><a href="#do_the_lmfit-626"><span class="linenos">626</span></a>                <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
</span><span id="do_the_lmfit-627"><a href="#do_the_lmfit-627"><span class="linenos">627</span></a>                    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_opt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># conversion to %/year, from %/day</span>
</span><span id="do_the_lmfit-628"><a href="#do_the_lmfit-628"><span class="linenos">628</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="do_the_lmfit-629"><a href="#do_the_lmfit-629"><span class="linenos">629</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="do_the_lmfit-630"><a href="#do_the_lmfit-630"><span class="linenos">630</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_list</span><span class="p">)):</span>
</span><span id="do_the_lmfit-631"><a href="#do_the_lmfit-631"><span class="linenos">631</span></a>                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="do_the_lmfit-632"><a href="#do_the_lmfit-632"><span class="linenos">632</span></a>                            <span class="k">return</span> <span class="kc">False</span>
</span><span id="do_the_lmfit-633"><a href="#do_the_lmfit-633"><span class="linenos">633</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="do_the_lmfit-634"><a href="#do_the_lmfit-634"><span class="linenos">634</span></a>        
</span><span id="do_the_lmfit-635"><a href="#do_the_lmfit-635"><span class="linenos">635</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_decay_positivity</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-636"><a href="#do_the_lmfit-636"><span class="linenos">636</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes positive&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_positivity</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-637"><a href="#do_the_lmfit-637"><span class="linenos">637</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;pool sizes below100&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_pool_below100</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-638"><a href="#do_the_lmfit-638"><span class="linenos">638</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-639"><a href="#do_the_lmfit-639"><span class="linenos">639</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;initial total carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_initial_carbon</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-640"><a href="#do_the_lmfit-640"><span class="linenos">640</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter constrained&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_stdev_constraint</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">fitted_params</span><span class="p">)</span>
</span><span id="do_the_lmfit-641"><a href="#do_the_lmfit-641"><span class="linenos">641</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;decay rates 1 odm diff&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">check_k_odm_difference</span><span class="p">(</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">)</span>
</span><span id="do_the_lmfit-642"><a href="#do_the_lmfit-642"><span class="linenos">642</span></a>
</span><span id="do_the_lmfit-643"><a href="#do_the_lmfit-643"><span class="linenos">643</span></a>    <span class="c1"># Stability values</span>
</span><span id="do_the_lmfit-644"><a href="#do_the_lmfit-644"><span class="linenos">644</span></a>    <span class="n">t100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">365</span> <span class="c1"># 100 years in days</span>
</span><span id="do_the_lmfit-645"><a href="#do_the_lmfit-645"><span class="linenos">645</span></a>    <span class="n">BC100</span> <span class="o">=</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t100</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># remaning after 100 years</span>
</span><span id="do_the_lmfit-646"><a href="#do_the_lmfit-646"><span class="linenos">646</span></a>
</span><span id="do_the_lmfit-647"><a href="#do_the_lmfit-647"><span class="linenos">647</span></a>    <span class="k">def</span> <span class="nf">f12</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="do_the_lmfit-648"><a href="#do_the_lmfit-648"><span class="linenos">648</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">50.</span>
</span><span id="do_the_lmfit-649"><a href="#do_the_lmfit-649"><span class="linenos">649</span></a>    <span class="n">t12</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">f12</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># half-life time, 50% C remaining</span>
</span><span id="do_the_lmfit-650"><a href="#do_the_lmfit-650"><span class="linenos">650</span></a>    <span class="n">t12</span> <span class="o">=</span> <span class="n">t12</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="do_the_lmfit-651"><a href="#do_the_lmfit-651"><span class="linenos">651</span></a>    
</span><span id="do_the_lmfit-652"><a href="#do_the_lmfit-652"><span class="linenos">652</span></a>    <span class="k">def</span> <span class="nf">fMRT</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="do_the_lmfit-653"><a href="#do_the_lmfit-653"><span class="linenos">653</span></a>        <span class="k">return</span> <span class="n">f_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="do_the_lmfit-654"><a href="#do_the_lmfit-654"><span class="linenos">654</span></a>    <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">fMRT</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span> <span class="c1"># apparent MRT, np.exp(-1) = 36.8% C remaining</span>
</span><span id="do_the_lmfit-655"><a href="#do_the_lmfit-655"><span class="linenos">655</span></a>    <span class="n">MRT_app</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="do_the_lmfit-656"><a href="#do_the_lmfit-656"><span class="linenos">656</span></a>    
</span><span id="do_the_lmfit-657"><a href="#do_the_lmfit-657"><span class="linenos">657</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;BC100&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BC100</span>
</span><span id="do_the_lmfit-658"><a href="#do_the_lmfit-658"><span class="linenos">658</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;t12&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t12</span><span class="o">/</span><span class="mi">365</span>
</span><span id="do_the_lmfit-659"><a href="#do_the_lmfit-659"><span class="linenos">659</span></a>    <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;MRTa&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MRT_app</span><span class="o">/</span><span class="mi">365</span>
</span><span id="do_the_lmfit-660"><a href="#do_the_lmfit-660"><span class="linenos">660</span></a>
</span><span id="do_the_lmfit-661"><a href="#do_the_lmfit-661"><span class="linenos">661</span></a>    <span class="c1"># Pretty printing all the statistical data</span>
</span><span id="do_the_lmfit-662"><a href="#do_the_lmfit-662"><span class="linenos">662</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">fit_report</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">))</span>
</span><span id="do_the_lmfit-663"><a href="#do_the_lmfit-663"><span class="linenos">663</span></a>    
</span><span id="do_the_lmfit-664"><a href="#do_the_lmfit-664"><span class="linenos">664</span></a>    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fitted_params</span><span class="o">.</span><span class="n">params</span><span class="p">]</span> 
</span><span id="do_the_lmfit-665"><a href="#do_the_lmfit-665"><span class="linenos">665</span></a>    <span class="k">if</span> <span class="n">showPlot</span><span class="p">:</span>
</span><span id="do_the_lmfit-666"><a href="#do_the_lmfit-666"><span class="linenos">666</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="do_the_lmfit-667"><a href="#do_the_lmfit-667"><span class="linenos">667</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
</span><span id="do_the_lmfit-668"><a href="#do_the_lmfit-668"><span class="linenos">668</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="do_the_lmfit-669"><a href="#do_the_lmfit-669"><span class="linenos">669</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">f_model</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">*</span><span class="n">L</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="do_the_lmfit-670"><a href="#do_the_lmfit-670"><span class="linenos">670</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="do_the_lmfit-671"><a href="#do_the_lmfit-671"><span class="linenos">671</span></a>
</span><span id="do_the_lmfit-672"><a href="#do_the_lmfit-672"><span class="linenos">672</span></a>    <span class="k">return</span> <span class="n">fitting_output</span>
</span></pre></div>


            <div class="docstring"><p>Does the fitting for one observation, and returns the parameters of interest, using lmfit.minimize</p>

<p>Inputs: </p>

<pre><code>- f_model: choose one of the model functions to fit on, e.g. linear, exponential, singleExp, doubleExp, powerModel 
- xdata: timesteps array, in days
- ydata: decay array
- bounds = upper, and lower limits arrays for fitting parameters, in tuple format (lower_array, upper_array), each array with length of parameters or scalar
        Here, parameters are either: doubleExp: 0&lt;k1,k2,c1&lt;100
                                     singleExp: 0&lt;k&lt;c&lt;100
                                     linear:    0&lt; m &lt; b &lt; 100 (if function defined as -1*m*x + b)
</code></pre>

<p>TODO: implement use of initial guess, via p0 - list of initial guesses, in params.add(ar, value=, vary=True)</p>
</div>


                </section>
                <section id="fit_all_observations">
                            <input id="fit_all_observations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_all_observations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span>,</span><span class="param">	<span class="n">metadata</span>,</span><span class="param">	<span class="n">observations</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">fitting_strategies</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">library</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span>,</span><span class="param">	<span class="n">variable</span><span class="o">=</span><span class="s1">&#39;C_bc_rem_rel&#39;</span>,</span><span class="param">	<span class="n">factor</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">excel</span><span class="o">=</span><span class="s1">&#39;&#39;</span></span>)</span>

                <label class="view-source-button" for="fit_all_observations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fit_all_observations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fit_all_observations-675"><a href="#fit_all_observations-675"><span class="linenos">675</span></a><span class="k">def</span> <span class="nf">fit_all_observations</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">observations</span><span class="o">=</span><span class="p">[],</span> <span class="n">fitting_strategies</span><span class="o">=</span><span class="p">[],</span> <span class="n">library</span><span class="o">=</span><span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;C_bc_rem_rel&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">excel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="fit_all_observations-676"><a href="#fit_all_observations-676"><span class="linenos">676</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="fit_all_observations-677"><a href="#fit_all_observations-677"><span class="linenos">677</span></a><span class="sd">    Applies the fitting_strategies to all passed observations, using the scipy curve_fit function, and returns an extensive report as a list of dictionnary, optionalled saved as an Excel file</span>
</span><span id="fit_all_observations-678"><a href="#fit_all_observations-678"><span class="linenos">678</span></a>
</span><span id="fit_all_observations-679"><a href="#fit_all_observations-679"><span class="linenos">679</span></a><span class="sd">    USAGE: \n </span>
</span><span id="fit_all_observations-680"><a href="#fit_all_observations-680"><span class="linenos">680</span></a><span class="sd">        df_scipy_fits = bs.fit_all_observations(data, metadata, fitting_strategies=fitting_strategies, library=&#39;scipy&#39;, variable=&#39;C_bc_rem_rel&#39;, factor=100, excel=&#39;scipy_allfits.xlsx&#39;) </span>
</span><span id="fit_all_observations-681"><a href="#fit_all_observations-681"><span class="linenos">681</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="fit_all_observations-682"><a href="#fit_all_observations-682"><span class="linenos">682</span></a>    <span class="n">all_fitting_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fit_all_observations-683"><a href="#fit_all_observations-683"><span class="linenos">683</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="fit_all_observations-684"><a href="#fit_all_observations-684"><span class="linenos">684</span></a>        <span class="n">observations</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">index</span>
</span><span id="fit_all_observations-685"><a href="#fit_all_observations-685"><span class="linenos">685</span></a>
</span><span id="fit_all_observations-686"><a href="#fit_all_observations-686"><span class="linenos">686</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
</span><span id="fit_all_observations-687"><a href="#fit_all_observations-687"><span class="linenos">687</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fit_all_observations-688"><a href="#fit_all_observations-688"><span class="linenos">688</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">select_timeseries</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="fit_all_observations-689"><a href="#fit_all_observations-689"><span class="linenos">689</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="fit_all_observations-690"><a href="#fit_all_observations-690"><span class="linenos">690</span></a>            <span class="k">continue</span>
</span><span id="fit_all_observations-691"><a href="#fit_all_observations-691"><span class="linenos">691</span></a>            
</span><span id="fit_all_observations-692"><a href="#fit_all_observations-692"><span class="linenos">692</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fitting_strategies</span><span class="p">):</span>
</span><span id="fit_all_observations-693"><a href="#fit_all_observations-693"><span class="linenos">693</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">f_model</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
</span><span id="fit_all_observations-694"><a href="#fit_all_observations-694"><span class="linenos">694</span></a>            <span class="k">if</span> <span class="n">library</span> <span class="o">==</span> <span class="s1">&#39;scipy&#39;</span><span class="p">:</span>
</span><span id="fit_all_observations-695"><a href="#fit_all_observations-695"><span class="linenos">695</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fitting_output</span> <span class="o">=</span> <span class="n">do_the_fit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="fit_all_observations-696"><a href="#fit_all_observations-696"><span class="linenos">696</span></a>            <span class="k">elif</span> <span class="n">library</span> <span class="o">==</span> <span class="s1">&#39;lmfit&#39;</span><span class="p">:</span>
</span><span id="fit_all_observations-697"><a href="#fit_all_observations-697"><span class="linenos">697</span></a>                <span class="n">fitting_output</span> <span class="o">=</span> <span class="n">do_the_lmfit</span><span class="p">(</span><span class="n">f_model</span><span class="o">=</span><span class="n">f_model</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span> <span class="n">showPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="fit_all_observations-698"><a href="#fit_all_observations-698"><span class="linenos">698</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="fit_all_observations-699"><a href="#fit_all_observations-699"><span class="linenos">699</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Sorry, the fitting library is not know. Use either `scipy` or `lmfit` as keyworkd.&quot;</span><span class="p">)</span>
</span><span id="fit_all_observations-700"><a href="#fit_all_observations-700"><span class="linenos">700</span></a>            
</span><span id="fit_all_observations-701"><a href="#fit_all_observations-701"><span class="linenos">701</span></a>            <span class="c1"># adding fitting_strategy information to the fitting output</span>
</span><span id="fit_all_observations-702"><a href="#fit_all_observations-702"><span class="linenos">702</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">j</span>
</span><span id="fit_all_observations-703"><a href="#fit_all_observations-703"><span class="linenos">703</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="fit_all_observations-704"><a href="#fit_all_observations-704"><span class="linenos">704</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">library</span>
</span><span id="fit_all_observations-705"><a href="#fit_all_observations-705"><span class="linenos">705</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">method</span>
</span><span id="fit_all_observations-706"><a href="#fit_all_observations-706"><span class="linenos">706</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">f_model</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="fit_all_observations-707"><a href="#fit_all_observations-707"><span class="linenos">707</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bounds</span>
</span><span id="fit_all_observations-708"><a href="#fit_all_observations-708"><span class="linenos">708</span></a>            <span class="n">fitting_output</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p0</span>
</span><span id="fit_all_observations-709"><a href="#fit_all_observations-709"><span class="linenos">709</span></a>            
</span><span id="fit_all_observations-710"><a href="#fit_all_observations-710"><span class="linenos">710</span></a>            <span class="n">all_fitting_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitting_output</span><span class="p">)</span>
</span><span id="fit_all_observations-711"><a href="#fit_all_observations-711"><span class="linenos">711</span></a>
</span><span id="fit_all_observations-712"><a href="#fit_all_observations-712"><span class="linenos">712</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_fitting_outputs</span><span class="p">)</span>
</span><span id="fit_all_observations-713"><a href="#fit_all_observations-713"><span class="linenos">713</span></a>    <span class="n">L</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="fit_all_observations-714"><a href="#fit_all_observations-714"><span class="linenos">714</span></a>    <span class="n">new_col_order</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fit_all_observations-715"><a href="#fit_all_observations-715"><span class="linenos">715</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;observation&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-716"><a href="#fit_all_observations-716"><span class="linenos">716</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;strategy&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-717"><a href="#fit_all_observations-717"><span class="linenos">717</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parameter&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-718"><a href="#fit_all_observations-718"><span class="linenos">718</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;estimator&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-719"><a href="#fit_all_observations-719"><span class="linenos">719</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;goodness&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-720"><a href="#fit_all_observations-720"><span class="linenos">720</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;checks&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-721"><a href="#fit_all_observations-721"><span class="linenos">721</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stddev_abs&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-722"><a href="#fit_all_observations-722"><span class="linenos">722</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stddev_rel&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-723"><a href="#fit_all_observations-723"><span class="linenos">723</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-724"><a href="#fit_all_observations-724"><span class="linenos">724</span></a>    <span class="n">new_col_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ll</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">L</span> <span class="k">if</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;covariance&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-725"><a href="#fit_all_observations-725"><span class="linenos">725</span></a>    <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">new_col_order</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">])</span>
</span><span id="fit_all_observations-726"><a href="#fit_all_observations-726"><span class="linenos">726</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span><span id="fit_all_observations-727"><a href="#fit_all_observations-727"><span class="linenos">727</span></a>    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
</span><span id="fit_all_observations-728"><a href="#fit_all_observations-728"><span class="linenos">728</span></a>    <span class="k">if</span> <span class="n">excel</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="fit_all_observations-729"><a href="#fit_all_observations-729"><span class="linenos">729</span></a>        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel</span><span class="p">)</span>
</span><span id="fit_all_observations-730"><a href="#fit_all_observations-730"><span class="linenos">730</span></a>
</span><span id="fit_all_observations-731"><a href="#fit_all_observations-731"><span class="linenos">731</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Applies the fitting_strategies to all passed observations, using the scipy curve_fit function, and returns an extensive report as a list of dictionnary, optionalled saved as an Excel file</p>

<p>USAGE: </p>

<pre><code>df_scipy_fits = bs.fit_all_observations(data, metadata, fitting_strategies=fitting_strategies, library='scipy', variable='C_bc_rem_rel', factor=100, excel='scipy_allfits.xlsx')
</code></pre>
</div>


                </section>
                <section id="load_fitted_observations">
                            <input id="load_fitted_observations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_fitted_observations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fp</span></span>)</span>

                <label class="view-source-button" for="load_fitted_observations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_fitted_observations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_fitted_observations-733"><a href="#load_fitted_observations-733"><span class="linenos">733</span></a><span class="k">def</span> <span class="nf">load_fitted_observations</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
</span><span id="load_fitted_observations-734"><a href="#load_fitted_observations-734"><span class="linenos">734</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="load_fitted_observations-735"><a href="#load_fitted_observations-735"><span class="linenos">735</span></a><span class="sd">    Load as a dataframe, a previously saved set of fitting_outputs saved as an excel file</span>
</span><span id="load_fitted_observations-736"><a href="#load_fitted_observations-736"><span class="linenos">736</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="load_fitted_observations-737"><a href="#load_fitted_observations-737"><span class="linenos">737</span></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Load as a dataframe, a previously saved set of fitting_outputs saved as an excel file</p>
</div>


                </section>
                <section id="applyQ10">
                            <input id="applyQ10-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">applyQ10</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fitdata</span>, </span><span class="param"><span class="n">metadata</span>, </span><span class="param"><span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="applyQ10-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#applyQ10"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="applyQ10-740"><a href="#applyQ10-740"><span class="linenos">740</span></a><span class="k">def</span> <span class="nf">applyQ10</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="applyQ10-741"><a href="#applyQ10-741"><span class="linenos">741</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="applyQ10-742"><a href="#applyQ10-742"><span class="linenos">742</span></a><span class="sd">    Applies the Q10 re-calibration of soil temperature to a calculated BC100 value at a given soil temperature to the </span>
</span><span id="applyQ10-743"><a href="#applyQ10-743"><span class="linenos">743</span></a><span class="sd">    target soil temperature tTs</span>
</span><span id="applyQ10-744"><a href="#applyQ10-744"><span class="linenos">744</span></a><span class="sd">    </span>
</span><span id="applyQ10-745"><a href="#applyQ10-745"><span class="linenos">745</span></a><span class="sd">    Inputs: \n </span>
</span><span id="applyQ10-746"><a href="#applyQ10-746"><span class="linenos">746</span></a><span class="sd">        - tTs: target soil temperature</span>
</span><span id="applyQ10-747"><a href="#applyQ10-747"><span class="linenos">747</span></a><span class="sd">        - metadata: dataframe with incubation meta-data</span>
</span><span id="applyQ10-748"><a href="#applyQ10-748"><span class="linenos">748</span></a><span class="sd">        - fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`</span>
</span><span id="applyQ10-749"><a href="#applyQ10-749"><span class="linenos">749</span></a><span class="sd">    </span>
</span><span id="applyQ10-750"><a href="#applyQ10-750"><span class="linenos">750</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="applyQ10-751"><a href="#applyQ10-751"><span class="linenos">751</span></a><span class="sd">        - a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.  </span>
</span><span id="applyQ10-752"><a href="#applyQ10-752"><span class="linenos">752</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="applyQ10-753"><a href="#applyQ10-753"><span class="linenos">753</span></a>    
</span><span id="applyQ10-754"><a href="#applyQ10-754"><span class="linenos">754</span></a>    <span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="applyQ10-755"><a href="#applyQ10-755"><span class="linenos">755</span></a>        <span class="sd">&#39;&#39;&#39;calculate Q10 factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="applyQ10-756"><a href="#applyQ10-756"><span class="linenos">756</span></a><span class="sd">        TO_DO: alternative: provide Q10 data, and calculate a relationship</span>
</span><span id="applyQ10-757"><a href="#applyQ10-757"><span class="linenos">757</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="applyQ10-758"><a href="#applyQ10-758"><span class="linenos">758</span></a>        <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">tTs</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Ts</span><span class="o">-</span><span class="n">tTs</span><span class="p">)</span> <span class="p">)</span>
</span><span id="applyQ10-759"><a href="#applyQ10-759"><span class="linenos">759</span></a>    
</span><span id="applyQ10-760"><a href="#applyQ10-760"><span class="linenos">760</span></a>    <span class="k">def</span> <span class="nf">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="applyQ10-761"><a href="#applyQ10-761"><span class="linenos">761</span></a>        <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="applyQ10-762"><a href="#applyQ10-762"><span class="linenos">762</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tTs</span><span class="o">-</span><span class="n">Ts</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span><span id="applyQ10-763"><a href="#applyQ10-763"><span class="linenos">763</span></a>    
</span><span id="applyQ10-764"><a href="#applyQ10-764"><span class="linenos">764</span></a>    <span class="n">FIT_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="applyQ10-765"><a href="#applyQ10-765"><span class="linenos">765</span></a>        <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span>
</span><span id="applyQ10-766"><a href="#applyQ10-766"><span class="linenos">766</span></a>        <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">]},</span>
</span><span id="applyQ10-767"><a href="#applyQ10-767"><span class="linenos">767</span></a>        <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span> <span class="c1"># k1, k2, k3, c1, c2</span>
</span><span id="applyQ10-768"><a href="#applyQ10-768"><span class="linenos">768</span></a>        
</span><span id="applyQ10-769"><a href="#applyQ10-769"><span class="linenos">769</span></a>        <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c&#39;</span><span class="p">]},</span>
</span><span id="applyQ10-770"><a href="#applyQ10-770"><span class="linenos">770</span></a>        <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span>
</span><span id="applyQ10-771"><a href="#applyQ10-771"><span class="linenos">771</span></a>        <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]},</span>
</span><span id="applyQ10-772"><a href="#applyQ10-772"><span class="linenos">772</span></a>        
</span><span id="applyQ10-773"><a href="#applyQ10-773"><span class="linenos">773</span></a>        <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Not supported correction factor (t, c0, b, m)&#39;</span>
</span><span id="applyQ10-774"><a href="#applyQ10-774"><span class="linenos">774</span></a>    <span class="p">}</span>
</span><span id="applyQ10-775"><a href="#applyQ10-775"><span class="linenos">775</span></a>    
</span><span id="applyQ10-776"><a href="#applyQ10-776"><span class="linenos">776</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="applyQ10-777"><a href="#applyQ10-777"><span class="linenos">777</span></a>    <span class="n">list_Q10</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyQ10-778"><a href="#applyQ10-778"><span class="linenos">778</span></a>    <span class="n">list_fT</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyQ10-779"><a href="#applyQ10-779"><span class="linenos">779</span></a>    <span class="n">list_newBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyQ10-780"><a href="#applyQ10-780"><span class="linenos">780</span></a>    <span class="n">list_oldBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyQ10-781"><a href="#applyQ10-781"><span class="linenos">781</span></a>    
</span><span id="applyQ10-782"><a href="#applyQ10-782"><span class="linenos">782</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="applyQ10-783"><a href="#applyQ10-783"><span class="linenos">783</span></a>        <span class="n">ID_OBS</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="applyQ10-784"><a href="#applyQ10-784"><span class="linenos">784</span></a>        <span class="c1">#print(i, ID_OBS)</span>
</span><span id="applyQ10-785"><a href="#applyQ10-785"><span class="linenos">785</span></a>        <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span>
</span><span id="applyQ10-786"><a href="#applyQ10-786"><span class="linenos">786</span></a>        <span class="c1">#print(FIT_func)</span>
</span><span id="applyQ10-787"><a href="#applyQ10-787"><span class="linenos">787</span></a>        <span class="n">TS</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ID_OBS</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="applyQ10-788"><a href="#applyQ10-788"><span class="linenos">788</span></a>        <span class="c1">#print(TS)</span>
</span><span id="applyQ10-789"><a href="#applyQ10-789"><span class="linenos">789</span></a>        <span class="n">oldBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span>
</span><span id="applyQ10-790"><a href="#applyQ10-790"><span class="linenos">790</span></a>        
</span><span id="applyQ10-791"><a href="#applyQ10-791"><span class="linenos">791</span></a>        <span class="c1"># find the fitting parameters in fitted_params</span>
</span><span id="applyQ10-792"><a href="#applyQ10-792"><span class="linenos">792</span></a>        <span class="n">fitparams</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="applyQ10-793"><a href="#applyQ10-793"><span class="linenos">793</span></a>        
</span><span id="applyQ10-794"><a href="#applyQ10-794"><span class="linenos">794</span></a>        <span class="c1">#cal Q10 and fT</span>
</span><span id="applyQ10-795"><a href="#applyQ10-795"><span class="linenos">795</span></a>        <span class="n">q10</span> <span class="o">=</span> <span class="n">Q10</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="applyQ10-796"><a href="#applyQ10-796"><span class="linenos">796</span></a>        <span class="n">list_Q10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q10</span><span class="p">)</span>
</span><span id="applyQ10-797"><a href="#applyQ10-797"><span class="linenos">797</span></a>        <span class="n">ft</span> <span class="o">=</span> <span class="n">fT</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="applyQ10-798"><a href="#applyQ10-798"><span class="linenos">798</span></a>        <span class="n">list_fT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="applyQ10-799"><a href="#applyQ10-799"><span class="linenos">799</span></a>        
</span><span id="applyQ10-800"><a href="#applyQ10-800"><span class="linenos">800</span></a>        <span class="c1"># apply correction to decay constants</span>
</span><span id="applyQ10-801"><a href="#applyQ10-801"><span class="linenos">801</span></a>        <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="applyQ10-802"><a href="#applyQ10-802"><span class="linenos">802</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyQ10-803"><a href="#applyQ10-803"><span class="linenos">803</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyQ10-804"><a href="#applyQ10-804"><span class="linenos">804</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>            
</span><span id="applyQ10-805"><a href="#applyQ10-805"><span class="linenos">805</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="applyQ10-806"><a href="#applyQ10-806"><span class="linenos">806</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyQ10-807"><a href="#applyQ10-807"><span class="linenos">807</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyQ10-808"><a href="#applyQ10-808"><span class="linenos">808</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyQ10-809"><a href="#applyQ10-809"><span class="linenos">809</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="applyQ10-810"><a href="#applyQ10-810"><span class="linenos">810</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyQ10-811"><a href="#applyQ10-811"><span class="linenos">811</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyQ10-812"><a href="#applyQ10-812"><span class="linenos">812</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyQ10-813"><a href="#applyQ10-813"><span class="linenos">813</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="applyQ10-814"><a href="#applyQ10-814"><span class="linenos">814</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span id="applyQ10-815"><a href="#applyQ10-815"><span class="linenos">815</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="applyQ10-816"><a href="#applyQ10-816"><span class="linenos">816</span></a>            <span class="c1"># not supported</span>
</span><span id="applyQ10-817"><a href="#applyQ10-817"><span class="linenos">817</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="c1"># copy previous value</span>
</span><span id="applyQ10-818"><a href="#applyQ10-818"><span class="linenos">818</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">ID_OBS</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="applyQ10-819"><a href="#applyQ10-819"><span class="linenos">819</span></a>        <span class="n">list_newBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBC100</span><span class="p">)</span>
</span><span id="applyQ10-820"><a href="#applyQ10-820"><span class="linenos">820</span></a>        <span class="n">list_oldBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oldBC100</span><span class="p">)</span>
</span><span id="applyQ10-821"><a href="#applyQ10-821"><span class="linenos">821</span></a>        <span class="c1">#print(type(fitparams[&#39;k&#39;]))</span>
</span><span id="applyQ10-822"><a href="#applyQ10-822"><span class="linenos">822</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="applyQ10-823"><a href="#applyQ10-823"><span class="linenos">823</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitparams</span><span class="p">),</span> <span class="s1">&#39;Q10: &#39;</span><span class="p">,</span> <span class="n">q10</span><span class="p">,</span> <span class="s1">&#39;fT: &#39;</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">oldBC100</span><span class="p">,</span> <span class="n">newBC100</span><span class="p">)</span>
</span><span id="applyQ10-824"><a href="#applyQ10-824"><span class="linenos">824</span></a>        
</span><span id="applyQ10-825"><a href="#applyQ10-825"><span class="linenos">825</span></a>    
</span><span id="applyQ10-826"><a href="#applyQ10-826"><span class="linenos">826</span></a>        <span class="c1">#if i &gt; 2:</span>
</span><span id="applyQ10-827"><a href="#applyQ10-827"><span class="linenos">827</span></a>        <span class="c1">#    break</span>
</span><span id="applyQ10-828"><a href="#applyQ10-828"><span class="linenos">828</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;Q10&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_Q10</span>
</span><span id="applyQ10-829"><a href="#applyQ10-829"><span class="linenos">829</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;fT&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_fT</span>
</span><span id="applyQ10-830"><a href="#applyQ10-830"><span class="linenos">830</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;BC100c&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_newBC100</span>
</span><span id="applyQ10-831"><a href="#applyQ10-831"><span class="linenos">831</span></a>    <span class="k">return</span> <span class="n">df2</span> <span class="c1">#, list_oldBC100, list_newBC100</span>
</span></pre></div>


            <div class="docstring"><p>Applies the Q10 re-calibration of soil temperature to a calculated BC100 value at a given soil temperature to the 
target soil temperature tTs</p>

<p>Inputs: </p>

<pre><code>- tTs: target soil temperature
- metadata: dataframe with incubation meta-data
- fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`
</code></pre>

<p>Outputs:  </p>

<pre><code>- a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.
</code></pre>
</div>


                </section>
                <section id="fit_Q10_data">
                            <input id="fit_Q10_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_Q10_data</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="fit_Q10_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fit_Q10_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fit_Q10_data-833"><a href="#fit_Q10_data-833"><span class="linenos">833</span></a><span class="k">def</span> <span class="nf">fit_Q10_data</span><span class="p">():</span>
</span><span id="fit_Q10_data-834"><a href="#fit_Q10_data-834"><span class="linenos">834</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="fit_Q10_data-835"><a href="#fit_Q10_data-835"><span class="linenos">835</span></a><span class="sd">    Fits a relationship between Q10 and soil temperature, based on experimental data compiled.</span>
</span><span id="fit_Q10_data-836"><a href="#fit_Q10_data-836"><span class="linenos">836</span></a><span class="sd">    </span>
</span><span id="fit_Q10_data-837"><a href="#fit_Q10_data-837"><span class="linenos">837</span></a><span class="sd">    TODO: load Q10 data from excel, fit exponential model, return model parameters</span>
</span><span id="fit_Q10_data-838"><a href="#fit_Q10_data-838"><span class="linenos">838</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="fit_Q10_data-839"><a href="#fit_Q10_data-839"><span class="linenos">839</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Fits a relationship between Q10 and soil temperature, based on experimental data compiled.</p>

<p>TODO: load Q10 data from excel, fit exponential model, return model parameters</p>
</div>


                </section>
                <section id="Q10">
                            <input id="Q10-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Q10</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">T1</span>, </span><span class="param"><span class="n">T2</span></span>)</span>

                <label class="view-source-button" for="Q10-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Q10"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Q10-844"><a href="#Q10-844"><span class="linenos">844</span></a><span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="Q10-845"><a href="#Q10-845"><span class="linenos">845</span></a>    <span class="sd">&#39;&#39;&#39;calculate Q10 average factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="Q10-846"><a href="#Q10-846"><span class="linenos">846</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="Q10-847"><a href="#Q10-847"><span class="linenos">847</span></a>    <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">T1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">T2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>calculate Q10 average factor, based on relationship given Woolf 2021 ES&amp;T</p>
</div>


                </section>
                <section id="fT_Woolf">
                            <input id="fT_Woolf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fT_Woolf</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">T1</span>, </span><span class="param"><span class="n">T2</span></span>)</span>

                <label class="view-source-button" for="fT_Woolf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fT_Woolf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fT_Woolf-849"><a href="#fT_Woolf-849"><span class="linenos">849</span></a><span class="k">def</span> <span class="nf">fT_Woolf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="fT_Woolf-850"><a href="#fT_Woolf-850"><span class="linenos">850</span></a>    <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on integration presented in Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="fT_Woolf-851"><a href="#fT_Woolf-851"><span class="linenos">851</span></a>    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">T1</span> <span class="o">==</span> <span class="n">T2</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on integration presented in Woolf 2021 ES&amp;T</p>
</div>


                </section>
                <section id="fT_WoolfStepwise">
                            <input id="fT_WoolfStepwise-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fT_WoolfStepwise</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">T1</span>, </span><span class="param"><span class="n">T2</span>, </span><span class="param"><span class="n">s</span><span class="o">=</span><span class="mf">0.001</span></span>)</span>

                <label class="view-source-button" for="fT_WoolfStepwise-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fT_WoolfStepwise"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fT_WoolfStepwise-854"><a href="#fT_WoolfStepwise-854"><span class="linenos">854</span></a><span class="k">def</span> <span class="nf">fT_WoolfStepwise</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="fT_WoolfStepwise-855"><a href="#fT_WoolfStepwise-855"><span class="linenos">855</span></a>    <span class="sd">&#39;&#39;&#39;Calculates the fT with Woolf2021 method and a stepwise approach&#39;&#39;&#39;</span>
</span><span id="fT_WoolfStepwise-856"><a href="#fT_WoolfStepwise-856"><span class="linenos">856</span></a>    <span class="n">f</span><span class="o">=</span><span class="mi">1</span>
</span><span id="fT_WoolfStepwise-857"><a href="#fT_WoolfStepwise-857"><span class="linenos">857</span></a>    <span class="n">sign</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">T1</span><span class="o">&lt;</span><span class="n">T2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="fT_WoolfStepwise-858"><a href="#fT_WoolfStepwise-858"><span class="linenos">858</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">sign</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span id="fT_WoolfStepwise-859"><a href="#fT_WoolfStepwise-859"><span class="linenos">859</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
</span><span id="fT_WoolfStepwise-860"><a href="#fT_WoolfStepwise-860"><span class="linenos">860</span></a>        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">*</span><span class="n">fT_Woolf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">sign</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span id="fT_WoolfStepwise-861"><a href="#fT_WoolfStepwise-861"><span class="linenos">861</span></a>    <span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>Calculates the fT with Woolf2021 method and a stepwise approach</p>
</div>


                </section>
                <section id="fT_DataFit">
                            <input id="fT_DataFit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fT_DataFit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">T1</span>, </span><span class="param"><span class="n">T2</span></span>)</span>

                <label class="view-source-button" for="fT_DataFit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fT_DataFit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fT_DataFit-864"><a href="#fT_DataFit-864"><span class="linenos">864</span></a><span class="k">def</span> <span class="nf">fT_DataFit</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
</span><span id="fT_DataFit-865"><a href="#fT_DataFit-865"><span class="linenos">865</span></a>    <span class="sd">&#39;&#39;&#39;from T1 to T2, using exponential relationship fitted on k_Y2 and Incubation temperature of whole dataset, by eye&#39;&#39;&#39;</span>
</span><span id="fT_DataFit-866"><a href="#fT_DataFit-866"><span class="linenos">866</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.0200</span><span class="o">*</span><span class="n">T2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.0200</span><span class="o">*</span><span class="n">T1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.7</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>from T1 to T2, using exponential relationship fitted on k_Y2 and Incubation temperature of whole dataset, by eye</p>
</div>


                </section>
                <section id="applyTempCorr">
                            <input id="applyTempCorr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">applyTempCorr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fitdata</span>, </span><span class="param"><span class="n">metadata</span>, </span><span class="param"><span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span>, </span><span class="param"><span class="n">TH</span><span class="o">=</span><span class="mi">100</span>, </span><span class="param"><span class="n">method</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">fT_Woolf</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="applyTempCorr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#applyTempCorr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="applyTempCorr-869"><a href="#applyTempCorr-869"><span class="linenos">869</span></a><span class="k">def</span> <span class="nf">applyTempCorr</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="mf">14.9</span><span class="p">,</span> <span class="n">TH</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fT_Woolf</span><span class="p">):</span>
</span><span id="applyTempCorr-870"><a href="#applyTempCorr-870"><span class="linenos">870</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="applyTempCorr-871"><a href="#applyTempCorr-871"><span class="linenos">871</span></a><span class="sd">    Applies the re-calibration of soil temperature to a calculated BC_TH value at a given soil temperature to the </span>
</span><span id="applyTempCorr-872"><a href="#applyTempCorr-872"><span class="linenos">872</span></a><span class="sd">    target soil temperature tTs</span>
</span><span id="applyTempCorr-873"><a href="#applyTempCorr-873"><span class="linenos">873</span></a><span class="sd">    </span>
</span><span id="applyTempCorr-874"><a href="#applyTempCorr-874"><span class="linenos">874</span></a><span class="sd">    Inputs: \n </span>
</span><span id="applyTempCorr-875"><a href="#applyTempCorr-875"><span class="linenos">875</span></a><span class="sd">        - tTs: target soil temperature, in degree C</span>
</span><span id="applyTempCorr-876"><a href="#applyTempCorr-876"><span class="linenos">876</span></a><span class="sd">        - TH: time horizon, in years</span>
</span><span id="applyTempCorr-877"><a href="#applyTempCorr-877"><span class="linenos">877</span></a><span class="sd">        - fT: pass a function used to calculate fT, among the fT availables:</span>
</span><span id="applyTempCorr-878"><a href="#applyTempCorr-878"><span class="linenos">878</span></a><span class="sd">                - fT_Woolf (or bs.fT_Woolf, if library is imported as bs)</span>
</span><span id="applyTempCorr-879"><a href="#applyTempCorr-879"><span class="linenos">879</span></a><span class="sd">                - fT_WoolfStepwise (or bs.)</span>
</span><span id="applyTempCorr-880"><a href="#applyTempCorr-880"><span class="linenos">880</span></a><span class="sd">                - fT_DataFit (or bs.)</span>
</span><span id="applyTempCorr-881"><a href="#applyTempCorr-881"><span class="linenos">881</span></a><span class="sd">        - metadata: dataframe with incubation meta-data</span>
</span><span id="applyTempCorr-882"><a href="#applyTempCorr-882"><span class="linenos">882</span></a><span class="sd">        - fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`</span>
</span><span id="applyTempCorr-883"><a href="#applyTempCorr-883"><span class="linenos">883</span></a><span class="sd">    </span>
</span><span id="applyTempCorr-884"><a href="#applyTempCorr-884"><span class="linenos">884</span></a><span class="sd">    Outputs:  \n</span>
</span><span id="applyTempCorr-885"><a href="#applyTempCorr-885"><span class="linenos">885</span></a><span class="sd">        - a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.  </span>
</span><span id="applyTempCorr-886"><a href="#applyTempCorr-886"><span class="linenos">886</span></a><span class="sd">        - list_oldBC100: old values as list</span>
</span><span id="applyTempCorr-887"><a href="#applyTempCorr-887"><span class="linenos">887</span></a><span class="sd">        - list_newBC100: new values as list</span>
</span><span id="applyTempCorr-888"><a href="#applyTempCorr-888"><span class="linenos">888</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="applyTempCorr-889"><a href="#applyTempCorr-889"><span class="linenos">889</span></a>    
</span><span id="applyTempCorr-890"><a href="#applyTempCorr-890"><span class="linenos">890</span></a>    <span class="n">FIT_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="applyTempCorr-891"><a href="#applyTempCorr-891"><span class="linenos">891</span></a>        <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;&#39;</span><span class="p">]},</span>
</span><span id="applyTempCorr-892"><a href="#applyTempCorr-892"><span class="linenos">892</span></a>        <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">]},</span>
</span><span id="applyTempCorr-893"><a href="#applyTempCorr-893"><span class="linenos">893</span></a>        <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span> <span class="c1"># k1, k2, k3, c1, c2</span>
</span><span id="applyTempCorr-894"><a href="#applyTempCorr-894"><span class="linenos">894</span></a>        
</span><span id="applyTempCorr-895"><a href="#applyTempCorr-895"><span class="linenos">895</span></a>        <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c&#39;</span><span class="p">]},</span>
</span><span id="applyTempCorr-896"><a href="#applyTempCorr-896"><span class="linenos">896</span></a>        <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]},</span>
</span><span id="applyTempCorr-897"><a href="#applyTempCorr-897"><span class="linenos">897</span></a>        <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ki&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="s1">&#39;ci&#39;</span><span class="p">:[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]},</span>
</span><span id="applyTempCorr-898"><a href="#applyTempCorr-898"><span class="linenos">898</span></a>        
</span><span id="applyTempCorr-899"><a href="#applyTempCorr-899"><span class="linenos">899</span></a>        <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Correction supported by separate function, powerModel_q10</span>
</span><span id="applyTempCorr-900"><a href="#applyTempCorr-900"><span class="linenos">900</span></a>    <span class="p">}</span>
</span><span id="applyTempCorr-901"><a href="#applyTempCorr-901"><span class="linenos">901</span></a>    
</span><span id="applyTempCorr-902"><a href="#applyTempCorr-902"><span class="linenos">902</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="applyTempCorr-903"><a href="#applyTempCorr-903"><span class="linenos">903</span></a>    <span class="n">list_fT</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyTempCorr-904"><a href="#applyTempCorr-904"><span class="linenos">904</span></a>    <span class="n">list_newBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyTempCorr-905"><a href="#applyTempCorr-905"><span class="linenos">905</span></a>    <span class="n">list_oldBC100</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="applyTempCorr-906"><a href="#applyTempCorr-906"><span class="linenos">906</span></a>    
</span><span id="applyTempCorr-907"><a href="#applyTempCorr-907"><span class="linenos">907</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="applyTempCorr-908"><a href="#applyTempCorr-908"><span class="linenos">908</span></a>        <span class="n">ID_OBS</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="applyTempCorr-909"><a href="#applyTempCorr-909"><span class="linenos">909</span></a>        <span class="c1">#print(i, ID_OBS)</span>
</span><span id="applyTempCorr-910"><a href="#applyTempCorr-910"><span class="linenos">910</span></a>        <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)]</span>
</span><span id="applyTempCorr-911"><a href="#applyTempCorr-911"><span class="linenos">911</span></a>        <span class="c1">#print(FIT_func)</span>
</span><span id="applyTempCorr-912"><a href="#applyTempCorr-912"><span class="linenos">912</span></a>        <span class="n">TS</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ID_OBS</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="applyTempCorr-913"><a href="#applyTempCorr-913"><span class="linenos">913</span></a>        <span class="c1">#print(TS)</span>
</span><span id="applyTempCorr-914"><a href="#applyTempCorr-914"><span class="linenos">914</span></a>        <span class="n">oldBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span>
</span><span id="applyTempCorr-915"><a href="#applyTempCorr-915"><span class="linenos">915</span></a>        
</span><span id="applyTempCorr-916"><a href="#applyTempCorr-916"><span class="linenos">916</span></a>        <span class="c1"># find the fitting parameters in fitted_params</span>
</span><span id="applyTempCorr-917"><a href="#applyTempCorr-917"><span class="linenos">917</span></a>        <span class="n">fitparams</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="applyTempCorr-918"><a href="#applyTempCorr-918"><span class="linenos">918</span></a>        
</span><span id="applyTempCorr-919"><a href="#applyTempCorr-919"><span class="linenos">919</span></a>        <span class="c1">#calc fT</span>
</span><span id="applyTempCorr-920"><a href="#applyTempCorr-920"><span class="linenos">920</span></a>        <span class="n">ft</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="applyTempCorr-921"><a href="#applyTempCorr-921"><span class="linenos">921</span></a>        <span class="n">list_fT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="applyTempCorr-922"><a href="#applyTempCorr-922"><span class="linenos">922</span></a>        
</span><span id="applyTempCorr-923"><a href="#applyTempCorr-923"><span class="linenos">923</span></a>        <span class="c1"># apply correction to decay constants</span>
</span><span id="applyTempCorr-924"><a href="#applyTempCorr-924"><span class="linenos">924</span></a>        <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-925"><a href="#applyTempCorr-925"><span class="linenos">925</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyTempCorr-926"><a href="#applyTempCorr-926"><span class="linenos">926</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-927"><a href="#applyTempCorr-927"><span class="linenos">927</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>            
</span><span id="applyTempCorr-928"><a href="#applyTempCorr-928"><span class="linenos">928</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-929"><a href="#applyTempCorr-929"><span class="linenos">929</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyTempCorr-930"><a href="#applyTempCorr-930"><span class="linenos">930</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-931"><a href="#applyTempCorr-931"><span class="linenos">931</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyTempCorr-932"><a href="#applyTempCorr-932"><span class="linenos">932</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-933"><a href="#applyTempCorr-933"><span class="linenos">933</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyTempCorr-934"><a href="#applyTempCorr-934"><span class="linenos">934</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-935"><a href="#applyTempCorr-935"><span class="linenos">935</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="applyTempCorr-936"><a href="#applyTempCorr-936"><span class="linenos">936</span></a>        <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="applyTempCorr-937"><a href="#applyTempCorr-937"><span class="linenos">937</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="n">TH</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitparams</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span id="applyTempCorr-938"><a href="#applyTempCorr-938"><span class="linenos">938</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="applyTempCorr-939"><a href="#applyTempCorr-939"><span class="linenos">939</span></a>            <span class="c1"># not supported</span>
</span><span id="applyTempCorr-940"><a href="#applyTempCorr-940"><span class="linenos">940</span></a>            <span class="n">newBC100</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[(</span><span class="s1">&#39;estimator&#39;</span><span class="p">,</span><span class="s1">&#39;BC100&#39;</span><span class="p">,</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="c1"># copy previous value</span>
</span><span id="applyTempCorr-941"><a href="#applyTempCorr-941"><span class="linenos">941</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">ID_OBS</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="applyTempCorr-942"><a href="#applyTempCorr-942"><span class="linenos">942</span></a>        
</span><span id="applyTempCorr-943"><a href="#applyTempCorr-943"><span class="linenos">943</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">newBC100</span><span class="p">)</span>
</span><span id="applyTempCorr-944"><a href="#applyTempCorr-944"><span class="linenos">944</span></a>        <span class="n">list_newBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBC100</span><span class="p">)</span>
</span><span id="applyTempCorr-945"><a href="#applyTempCorr-945"><span class="linenos">945</span></a>        <span class="n">list_oldBC100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oldBC100</span><span class="p">)</span>
</span><span id="applyTempCorr-946"><a href="#applyTempCorr-946"><span class="linenos">946</span></a>
</span><span id="applyTempCorr-947"><a href="#applyTempCorr-947"><span class="linenos">947</span></a>    <span class="c1">#df2[(&#39;q10correction&#39;,&#39;Q10&#39;,&#39;1&#39;)] = list_Q10</span>
</span><span id="applyTempCorr-948"><a href="#applyTempCorr-948"><span class="linenos">948</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;fT&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_fT</span>
</span><span id="applyTempCorr-949"><a href="#applyTempCorr-949"><span class="linenos">949</span></a>    <span class="n">df2</span><span class="p">[(</span><span class="s1">&#39;q10correction&#39;</span><span class="p">,</span><span class="s1">&#39;BC_TH_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TH</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_TS_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tTs</span><span class="p">),</span><span class="s1">&#39;%&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">list_newBC100</span>
</span><span id="applyTempCorr-950"><a href="#applyTempCorr-950"><span class="linenos">950</span></a>    <span class="k">return</span> <span class="n">df2</span> <span class="p">,</span> <span class="n">list_oldBC100</span><span class="p">,</span> <span class="n">list_newBC100</span>
</span></pre></div>


            <div class="docstring"><p>Applies the re-calibration of soil temperature to a calculated BC_TH value at a given soil temperature to the 
target soil temperature tTs</p>

<p>Inputs: </p>

<pre><code>- tTs: target soil temperature, in degree C
- TH: time horizon, in years
- fT: pass a function used to calculate fT, among the fT availables:
        - fT_Woolf (or bs.fT_Woolf, if library is imported as bs)
        - fT_WoolfStepwise (or bs.)
        - fT_DataFit (or bs.)
- metadata: dataframe with incubation meta-data
- fitdata: dataframe containing all the fitting data, usually output of function `fit_all_observations`
</code></pre>

<p>Outputs:  </p>

<pre><code>- a new dataframe based on fitdata, with a new column containing the recalibrated BC100 values.  
- list_oldBC100: old values as list
- list_newBC100: new values as list
</code></pre>
</div>


                </section>
                <section id="select_best_fit">
                            <input id="select_best_fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">select_best_fit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fitdata</span>,</span><span class="param">	<span class="n">model_pool</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">checks</span><span class="o">=</span><span class="p">{}</span>,</span><span class="param">	<span class="n">spec_val</span><span class="o">=</span><span class="p">{}</span>,</span><span class="param">	<span class="n">rank</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>,</span><span class="param">	<span class="n">saveExcel</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="select_best_fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#select_best_fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="select_best_fit-953"><a href="#select_best_fit-953"><span class="linenos"> 953</span></a><span class="k">def</span> <span class="nf">select_best_fit</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">model_pool</span><span class="o">=</span><span class="p">[],</span> <span class="n">checks</span><span class="o">=</span><span class="p">{},</span> <span class="n">spec_val</span><span class="o">=</span><span class="p">{},</span> <span class="n">rank</span><span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bic&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">saveExcel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="select_best_fit-954"><a href="#select_best_fit-954"><span class="linenos"> 954</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="select_best_fit-955"><a href="#select_best_fit-955"><span class="linenos"> 955</span></a><span class="sd">    Based on the passed criteria, selects for all observations available fitted_data a single best fit if it exists. </span>
</span><span id="select_best_fit-956"><a href="#select_best_fit-956"><span class="linenos"> 956</span></a>
</span><span id="select_best_fit-957"><a href="#select_best_fit-957"><span class="linenos"> 957</span></a><span class="sd">    The criterias are:</span>
</span><span id="select_best_fit-958"><a href="#select_best_fit-958"><span class="linenos"> 958</span></a><span class="sd">    1. `model_pool`: a list of model functions names (e.g. `singleExp`, `doubleExp`, `tripleExp`,...) that are considered, for the best fit (e.g. we can decide to exclude powerModel or singleExp)</span>
</span><span id="select_best_fit-959"><a href="#select_best_fit-959"><span class="linenos"> 959</span></a><span class="sd">    2. `checks`: a dict of ohysical checks that must be passed, to be considered a potential best fit, e.g. {&#39;decay rates positive&#39;:TRUE}</span>
</span><span id="select_best_fit-960"><a href="#select_best_fit-960"><span class="linenos"> 960</span></a><span class="sd">    3. `spec_val`: any other key present in the fitdata data, e.g. {&#39;library&#39;:&#39;scipy&#39;} to work only with scipy and exclude lmfit </span>
</span><span id="select_best_fit-961"><a href="#select_best_fit-961"><span class="linenos"> 961</span></a><span class="sd">    4. `rank`: a tuple, among remaining fits, select the one with lowest/highest score in given goodness indicator, e.g. (&#39;bic&#39;, True) means lowest BIC is best</span>
</span><span id="select_best_fit-962"><a href="#select_best_fit-962"><span class="linenos"> 962</span></a><span class="sd">    </span>
</span><span id="select_best_fit-963"><a href="#select_best_fit-963"><span class="linenos"> 963</span></a><span class="sd">    Inputs:</span>
</span><span id="select_best_fit-964"><a href="#select_best_fit-964"><span class="linenos"> 964</span></a><span class="sd">    - fitdata: a dataframe loaded from Excel, created by function `applyQ10` or `fit_all_observations` </span>
</span><span id="select_best_fit-965"><a href="#select_best_fit-965"><span class="linenos"> 965</span></a><span class="sd">    - saveExcel: if False, does not save. Alternatively: give filepath to save to.</span>
</span><span id="select_best_fit-966"><a href="#select_best_fit-966"><span class="linenos"> 966</span></a><span class="sd">    </span>
</span><span id="select_best_fit-967"><a href="#select_best_fit-967"><span class="linenos"> 967</span></a><span class="sd">    Outputs:</span>
</span><span id="select_best_fit-968"><a href="#select_best_fit-968"><span class="linenos"> 968</span></a><span class="sd">    - dataframe, selected best fits for each observations, in same format as fitted_data; the dataframe is also saved as an Excel file (option)</span>
</span><span id="select_best_fit-969"><a href="#select_best_fit-969"><span class="linenos"> 969</span></a><span class="sd">    - a list of ID_obs where no best fit was found</span>
</span><span id="select_best_fit-970"><a href="#select_best_fit-970"><span class="linenos"> 970</span></a><span class="sd">    </span>
</span><span id="select_best_fit-971"><a href="#select_best_fit-971"><span class="linenos"> 971</span></a><span class="sd">    USAGE: \n</span>
</span><span id="select_best_fit-972"><a href="#select_best_fit-972"><span class="linenos"> 972</span></a><span class="sd">        no_best, df_best = select_best_fit(fitdata, model_pool, checks, spec_val)</span>
</span><span id="select_best_fit-973"><a href="#select_best_fit-973"><span class="linenos"> 973</span></a><span class="sd">        </span>
</span><span id="select_best_fit-974"><a href="#select_best_fit-974"><span class="linenos"> 974</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="select_best_fit-975"><a href="#select_best_fit-975"><span class="linenos"> 975</span></a>    <span class="c1"># fitted df - remove the sub-levels of multi-index, for easier access to properties</span>
</span><span id="select_best_fit-976"><a href="#select_best_fit-976"><span class="linenos"> 976</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="select_best_fit-977"><a href="#select_best_fit-977"><span class="linenos"> 977</span></a>    <span class="n">all_obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="select_best_fit-978"><a href="#select_best_fit-978"><span class="linenos"> 978</span></a>    
</span><span id="select_best_fit-979"><a href="#select_best_fit-979"><span class="linenos"> 979</span></a>    <span class="c1"># apply model_pool filter</span>
</span><span id="select_best_fit-980"><a href="#select_best_fit-980"><span class="linenos"> 980</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_pool</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="select_best_fit-981"><a href="#select_best_fit-981"><span class="linenos"> 981</span></a>        <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">model_pool</span><span class="p">)]</span>
</span><span id="select_best_fit-982"><a href="#select_best_fit-982"><span class="linenos"> 982</span></a>
</span><span id="select_best_fit-983"><a href="#select_best_fit-983"><span class="linenos"> 983</span></a>    <span class="c1"># apply checks filter</span>
</span><span id="select_best_fit-984"><a href="#select_best_fit-984"><span class="linenos"> 984</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="select_best_fit-985"><a href="#select_best_fit-985"><span class="linenos"> 985</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="select_best_fit-986"><a href="#select_best_fit-986"><span class="linenos"> 986</span></a>            <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>
</span><span id="select_best_fit-987"><a href="#select_best_fit-987"><span class="linenos"> 987</span></a>    
</span><span id="select_best_fit-988"><a href="#select_best_fit-988"><span class="linenos"> 988</span></a>    <span class="c1"># apply spec_val filter</span>
</span><span id="select_best_fit-989"><a href="#select_best_fit-989"><span class="linenos"> 989</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec_val</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="select_best_fit-990"><a href="#select_best_fit-990"><span class="linenos"> 990</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">spec_val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="select_best_fit-991"><a href="#select_best_fit-991"><span class="linenos"> 991</span></a>            <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>    
</span><span id="select_best_fit-992"><a href="#select_best_fit-992"><span class="linenos"> 992</span></a>    
</span><span id="select_best_fit-993"><a href="#select_best_fit-993"><span class="linenos"> 993</span></a>    <span class="c1"># ranking and best fit selection </span>
</span><span id="select_best_fit-994"><a href="#select_best_fit-994"><span class="linenos"> 994</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">rank</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
</span><span id="select_best_fit-995"><a href="#select_best_fit-995"><span class="linenos"> 995</span></a>    <span class="n">df_best</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">)</span>
</span><span id="select_best_fit-996"><a href="#select_best_fit-996"><span class="linenos"> 996</span></a>    
</span><span id="select_best_fit-997"><a href="#select_best_fit-997"><span class="linenos"> 997</span></a>    <span class="n">rem_obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_best</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="select_best_fit-998"><a href="#select_best_fit-998"><span class="linenos"> 998</span></a>    
</span><span id="select_best_fit-999"><a href="#select_best_fit-999"><span class="linenos"> 999</span></a>    <span class="n">no_best</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_obs</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">rem_obs</span><span class="p">))</span>
</span><span id="select_best_fit-1000"><a href="#select_best_fit-1000"><span class="linenos">1000</span></a>    
</span><span id="select_best_fit-1001"><a href="#select_best_fit-1001"><span class="linenos">1001</span></a>    <span class="k">if</span> <span class="n">saveExcel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="select_best_fit-1002"><a href="#select_best_fit-1002"><span class="linenos">1002</span></a>        <span class="n">df_best</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">saveExcel</span><span class="p">)</span>
</span><span id="select_best_fit-1003"><a href="#select_best_fit-1003"><span class="linenos">1003</span></a>    
</span><span id="select_best_fit-1004"><a href="#select_best_fit-1004"><span class="linenos">1004</span></a>    <span class="k">return</span> <span class="n">no_best</span><span class="p">,</span> <span class="n">df_best</span>
</span></pre></div>


            <div class="docstring"><p>Based on the passed criteria, selects for all observations available fitted_data a single best fit if it exists. </p>

<p>The criterias are:</p>

<ol>
<li><code>model_pool</code>: a list of model functions names (e.g. <code><a href="#singleExp">singleExp</a></code>, <code><a href="#doubleExp">doubleExp</a></code>, <code><a href="#tripleExp">tripleExp</a></code>,...) that are considered, for the best fit (e.g. we can decide to exclude powerModel or singleExp)</li>
<li><code>checks</code>: a dict of ohysical checks that must be passed, to be considered a potential best fit, e.g. {'decay rates positive':TRUE}</li>
<li><code>spec_val</code>: any other key present in the fitdata data, e.g. {'library':'scipy'} to work only with scipy and exclude lmfit </li>
<li><code>rank</code>: a tuple, among remaining fits, select the one with lowest/highest score in given goodness indicator, e.g. ('bic', True) means lowest BIC is best</li>
</ol>

<p>Inputs:</p>

<ul>
<li>fitdata: a dataframe loaded from Excel, created by function <code><a href="#applyQ10">applyQ10</a></code> or <code><a href="#fit_all_observations">fit_all_observations</a></code> </li>
<li>saveExcel: if False, does not save. Alternatively: give filepath to save to.</li>
</ul>

<p>Outputs:</p>

<ul>
<li>dataframe, selected best fits for each observations, in same format as fitted_data; the dataframe is also saved as an Excel file (option)</li>
<li>a list of ID_obs where no best fit was found</li>
</ul>

<p>USAGE: </p>

<pre><code>no_best, df_best = select_best_fit(fitdata, model_pool, checks, spec_val)
</code></pre>
</div>


                </section>
                <section id="std_singleExp">
                            <input id="std_singleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_singleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_singleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_singleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_singleExp-1007"><a href="#std_singleExp-1007"><span class="linenos">1007</span></a><span class="k">def</span> <span class="nf">std_singleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_singleExp-1008"><a href="#std_singleExp-1008"><span class="linenos">1008</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_singleExp-1009"><a href="#std_singleExp-1009"><span class="linenos">1009</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_singleExp-1010"><a href="#std_singleExp-1010"><span class="linenos">1010</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="std_singleExp-1011"><a href="#std_singleExp-1011"><span class="linenos">1011</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_singleExp-1012"><a href="#std_singleExp-1012"><span class="linenos">1012</span></a><span class="sd">        </span>
</span><span id="std_singleExp-1013"><a href="#std_singleExp-1013"><span class="linenos">1013</span></a><span class="sd">    See definition of `singleExp` for order of parameters</span>
</span><span id="std_singleExp-1014"><a href="#std_singleExp-1014"><span class="linenos">1014</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_singleExp-1015"><a href="#std_singleExp-1015"><span class="linenos">1015</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_singleExp-1016"><a href="#std_singleExp-1016"><span class="linenos">1016</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_singleExp-1017"><a href="#std_singleExp-1017"><span class="linenos">1017</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_singleExp-1018"><a href="#std_singleExp-1018"><span class="linenos">1018</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the model function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>

<p>See definition of <code><a href="#singleExp">singleExp</a></code> for order of parameters</p>
</div>


                </section>
                <section id="std_singleExp_u">
                            <input id="std_singleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_singleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_singleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_singleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_singleExp_u-1020"><a href="#std_singleExp_u-1020"><span class="linenos">1020</span></a><span class="k">def</span> <span class="nf">std_singleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_singleExp_u-1021"><a href="#std_singleExp_u-1021"><span class="linenos">1021</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_singleExp_u-1022"><a href="#std_singleExp_u-1022"><span class="linenos">1022</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_singleExp_u-1023"><a href="#std_singleExp_u-1023"><span class="linenos">1023</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="std_singleExp_u-1024"><a href="#std_singleExp_u-1024"><span class="linenos">1024</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_singleExp_u-1025"><a href="#std_singleExp_u-1025"><span class="linenos">1025</span></a>
</span><span id="std_singleExp_u-1026"><a href="#std_singleExp_u-1026"><span class="linenos">1026</span></a><span class="sd">    See definition of `singleExp_u` for order of parameters</span>
</span><span id="std_singleExp_u-1027"><a href="#std_singleExp_u-1027"><span class="linenos">1027</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_singleExp_u-1028"><a href="#std_singleExp_u-1028"><span class="linenos">1028</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_singleExp_u-1029"><a href="#std_singleExp_u-1029"><span class="linenos">1029</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_singleExp_u-1030"><a href="#std_singleExp_u-1030"><span class="linenos">1030</span></a>
</span><span id="std_singleExp_u-1031"><a href="#std_singleExp_u-1031"><span class="linenos">1031</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_singleExp_u-1032"><a href="#std_singleExp_u-1032"><span class="linenos">1032</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_singleExp_u-1033"><a href="#std_singleExp_u-1033"><span class="linenos">1033</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the model function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>

<p>See definition of <code><a href="#singleExp_u">singleExp_u</a></code> for order of parameters</p>
</div>


                </section>
                <section id="std_doubleExp">
                            <input id="std_doubleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_doubleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_doubleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_doubleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_doubleExp-1036"><a href="#std_doubleExp-1036"><span class="linenos">1036</span></a><span class="k">def</span> <span class="nf">std_doubleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_doubleExp-1037"><a href="#std_doubleExp-1037"><span class="linenos">1037</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_doubleExp-1038"><a href="#std_doubleExp-1038"><span class="linenos">1038</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_doubleExp-1039"><a href="#std_doubleExp-1039"><span class="linenos">1039</span></a><span class="sd">    calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order</span>
</span><span id="std_doubleExp-1040"><a href="#std_doubleExp-1040"><span class="linenos">1040</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_doubleExp-1041"><a href="#std_doubleExp-1041"><span class="linenos">1041</span></a>
</span><span id="std_doubleExp-1042"><a href="#std_doubleExp-1042"><span class="linenos">1042</span></a><span class="sd">    See definition of `doubleExp_u` for order of parameters</span>
</span><span id="std_doubleExp-1043"><a href="#std_doubleExp-1043"><span class="linenos">1043</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_doubleExp-1044"><a href="#std_doubleExp-1044"><span class="linenos">1044</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_doubleExp-1045"><a href="#std_doubleExp-1045"><span class="linenos">1045</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_doubleExp-1046"><a href="#std_doubleExp-1046"><span class="linenos">1046</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="std_doubleExp-1047"><a href="#std_doubleExp-1047"><span class="linenos">1047</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_doubleExp-1048"><a href="#std_doubleExp-1048"><span class="linenos">1048</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_doubleExp-1049"><a href="#std_doubleExp-1049"><span class="linenos">1049</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>

<p>See definition of <code><a href="#doubleExp_u">doubleExp_u</a></code> for order of parameters</p>
</div>


                </section>
                <section id="std_doubleExp_u">
                            <input id="std_doubleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_doubleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_doubleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_doubleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_doubleExp_u-1051"><a href="#std_doubleExp_u-1051"><span class="linenos">1051</span></a><span class="k">def</span> <span class="nf">std_doubleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_doubleExp_u-1052"><a href="#std_doubleExp_u-1052"><span class="linenos">1052</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_doubleExp_u-1053"><a href="#std_doubleExp_u-1053"><span class="linenos">1053</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_doubleExp_u-1054"><a href="#std_doubleExp_u-1054"><span class="linenos">1054</span></a><span class="sd">    calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order</span>
</span><span id="std_doubleExp_u-1055"><a href="#std_doubleExp_u-1055"><span class="linenos">1055</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_doubleExp_u-1056"><a href="#std_doubleExp_u-1056"><span class="linenos">1056</span></a><span class="sd">    </span>
</span><span id="std_doubleExp_u-1057"><a href="#std_doubleExp_u-1057"><span class="linenos">1057</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_doubleExp_u-1058"><a href="#std_doubleExp_u-1058"><span class="linenos">1058</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_doubleExp_u-1059"><a href="#std_doubleExp_u-1059"><span class="linenos">1059</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_doubleExp_u-1060"><a href="#std_doubleExp_u-1060"><span class="linenos">1060</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="std_doubleExp_u-1061"><a href="#std_doubleExp_u-1061"><span class="linenos">1061</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="std_doubleExp_u-1062"><a href="#std_doubleExp_u-1062"><span class="linenos">1062</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_doubleExp_u-1063"><a href="#std_doubleExp_u-1063"><span class="linenos">1063</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_doubleExp_u-1064"><a href="#std_doubleExp_u-1064"><span class="linenos">1064</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the double exponential function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>
</div>


                </section>
                <section id="std_tripleExp">
                            <input id="std_tripleExp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_tripleExp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_tripleExp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_tripleExp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_tripleExp-1066"><a href="#std_tripleExp-1066"><span class="linenos">1066</span></a><span class="k">def</span> <span class="nf">std_tripleExp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_tripleExp-1067"><a href="#std_tripleExp-1067"><span class="linenos">1067</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_tripleExp-1068"><a href="#std_tripleExp-1068"><span class="linenos">1068</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_tripleExp-1069"><a href="#std_tripleExp-1069"><span class="linenos">1069</span></a><span class="sd">    calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order</span>
</span><span id="std_tripleExp-1070"><a href="#std_tripleExp-1070"><span class="linenos">1070</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_tripleExp-1071"><a href="#std_tripleExp-1071"><span class="linenos">1071</span></a><span class="sd">    </span>
</span><span id="std_tripleExp-1072"><a href="#std_tripleExp-1072"><span class="linenos">1072</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_tripleExp-1073"><a href="#std_tripleExp-1073"><span class="linenos">1073</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_tripleExp-1074"><a href="#std_tripleExp-1074"><span class="linenos">1074</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_tripleExp-1075"><a href="#std_tripleExp-1075"><span class="linenos">1075</span></a>    <span class="n">k3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="std_tripleExp-1076"><a href="#std_tripleExp-1076"><span class="linenos">1076</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="std_tripleExp-1077"><a href="#std_tripleExp-1077"><span class="linenos">1077</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="std_tripleExp-1078"><a href="#std_tripleExp-1078"><span class="linenos">1078</span></a>
</span><span id="std_tripleExp-1079"><a href="#std_tripleExp-1079"><span class="linenos">1079</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>  <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_tripleExp-1080"><a href="#std_tripleExp-1080"><span class="linenos">1080</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_tripleExp-1081"><a href="#std_tripleExp-1081"><span class="linenos">1081</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>
</div>


                </section>
                <section id="std_tripleExp_u">
                            <input id="std_tripleExp_u-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_tripleExp_u</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_tripleExp_u-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_tripleExp_u"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_tripleExp_u-1083"><a href="#std_tripleExp_u-1083"><span class="linenos">1083</span></a><span class="k">def</span> <span class="nf">std_tripleExp_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_tripleExp_u-1084"><a href="#std_tripleExp_u-1084"><span class="linenos">1084</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_tripleExp_u-1085"><a href="#std_tripleExp_u-1085"><span class="linenos">1085</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_tripleExp_u-1086"><a href="#std_tripleExp_u-1086"><span class="linenos">1086</span></a><span class="sd">    calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order</span>
</span><span id="std_tripleExp_u-1087"><a href="#std_tripleExp_u-1087"><span class="linenos">1087</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_tripleExp_u-1088"><a href="#std_tripleExp_u-1088"><span class="linenos">1088</span></a>
</span><span id="std_tripleExp_u-1089"><a href="#std_tripleExp_u-1089"><span class="linenos">1089</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_tripleExp_u-1090"><a href="#std_tripleExp_u-1090"><span class="linenos">1090</span></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1091"><a href="#std_tripleExp_u-1091"><span class="linenos">1091</span></a>    <span class="n">k2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1092"><a href="#std_tripleExp_u-1092"><span class="linenos">1092</span></a>    <span class="n">k3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1093"><a href="#std_tripleExp_u-1093"><span class="linenos">1093</span></a>    <span class="n">c1</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1094"><a href="#std_tripleExp_u-1094"><span class="linenos">1094</span></a>    <span class="n">c2</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1095"><a href="#std_tripleExp_u-1095"><span class="linenos">1095</span></a>    <span class="n">c3</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="std_tripleExp_u-1096"><a href="#std_tripleExp_u-1096"><span class="linenos">1096</span></a>
</span><span id="std_tripleExp_u-1097"><a href="#std_tripleExp_u-1097"><span class="linenos">1097</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">c3</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k1</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_tripleExp_u-1098"><a href="#std_tripleExp_u-1098"><span class="linenos">1098</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_tripleExp_u-1099"><a href="#std_tripleExp_u-1099"><span class="linenos">1099</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the triple exponential function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>
</div>


                </section>
                <section id="std_powerModel">
                            <input id="std_powerModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_powerModel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span>, </span><span class="param"><span class="n">fT</span><span class="o">=</span><span class="mi">1</span></span>)</span>

                <label class="view-source-button" for="std_powerModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_powerModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_powerModel-1101"><a href="#std_powerModel-1101"><span class="linenos">1101</span></a><span class="k">def</span> <span class="nf">std_powerModel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">fT</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="std_powerModel-1102"><a href="#std_powerModel-1102"><span class="linenos">1102</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_powerModel-1103"><a href="#std_powerModel-1103"><span class="linenos">1103</span></a><span class="sd">    Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),</span>
</span><span id="std_powerModel-1104"><a href="#std_powerModel-1104"><span class="linenos">1104</span></a><span class="sd">    calculate the propagated error through the model function, based on Talor series expansion of 1st order</span>
</span><span id="std_powerModel-1105"><a href="#std_powerModel-1105"><span class="linenos">1105</span></a><span class="sd">    https://en.wikipedia.org/wiki/Propagation_of_uncertainty</span>
</span><span id="std_powerModel-1106"><a href="#std_powerModel-1106"><span class="linenos">1106</span></a><span class="sd">    </span>
</span><span id="std_powerModel-1107"><a href="#std_powerModel-1107"><span class="linenos">1107</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_powerModel-1108"><a href="#std_powerModel-1108"><span class="linenos">1108</span></a>    <span class="n">c0</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_powerModel-1109"><a href="#std_powerModel-1109"><span class="linenos">1109</span></a>    <span class="n">b</span> <span class="o">=</span>  <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_powerModel-1110"><a href="#std_powerModel-1110"><span class="linenos">1110</span></a>    <span class="n">m</span> <span class="o">=</span>  <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="std_powerModel-1111"><a href="#std_powerModel-1111"><span class="linenos">1111</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="std_powerModel-1112"><a href="#std_powerModel-1112"><span class="linenos">1112</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>  <span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_powerModel-1113"><a href="#std_powerModel-1113"><span class="linenos">1113</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="std_powerModel-1114"><a href="#std_powerModel-1114"><span class="linenos">1114</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_powerModel-1115"><a href="#std_powerModel-1115"><span class="linenos">1115</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="std_powerModel-1116"><a href="#std_powerModel-1116"><span class="linenos">1116</span></a>        <span class="c1"># taken same as for m &gt; -1, since same equation but just a constant insert for time = 0 </span>
</span><span id="std_powerModel-1117"><a href="#std_powerModel-1117"><span class="linenos">1117</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">,</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>  <span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">fT</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">])</span> <span class="c1"># gradient of doubleExp_u, for vector X</span>
</span><span id="std_powerModel-1118"><a href="#std_powerModel-1118"><span class="linenos">1118</span></a>    
</span><span id="std_powerModel-1119"><a href="#std_powerModel-1119"><span class="linenos">1119</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_powerModel-1120"><a href="#std_powerModel-1120"><span class="linenos">1120</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Given optimal parameters of a fit (p_opt), the covariance matrix of the fitted parameters (p_cov),
calculate the propagated error through the model function, based on Talor series expansion of 1st order
<a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty">https://en.wikipedia.org/wiki/Propagation_of_uncertainty</a></p>
</div>


                </section>
                <section id="std_fmodel">
                            <input id="std_fmodel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_fmodel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xdata</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span>, </span><span class="param"><span class="n">fmodel</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">doubleExp_u</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="std_fmodel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_fmodel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_fmodel-1122"><a href="#std_fmodel-1122"><span class="linenos">1122</span></a><span class="k">def</span> <span class="nf">std_fmodel</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="n">doubleExp_u</span><span class="p">):</span>
</span><span id="std_fmodel-1123"><a href="#std_fmodel-1123"><span class="linenos">1123</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="std_fmodel-1124"><a href="#std_fmodel-1124"><span class="linenos">1124</span></a><span class="sd">    Returns caculated propagated error for the given model, over the entire time range given (xdata)</span>
</span><span id="std_fmodel-1125"><a href="#std_fmodel-1125"><span class="linenos">1125</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="std_fmodel-1126"><a href="#std_fmodel-1126"><span class="linenos">1126</span></a>    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="std_fmodel-1127"><a href="#std_fmodel-1127"><span class="linenos">1127</span></a>        <span class="n">singleExp</span><span class="p">:</span><span class="n">std_singleExp</span><span class="p">,</span>
</span><span id="std_fmodel-1128"><a href="#std_fmodel-1128"><span class="linenos">1128</span></a>        <span class="n">singleExp_u</span><span class="p">:</span><span class="n">std_singleExp_u</span><span class="p">,</span>
</span><span id="std_fmodel-1129"><a href="#std_fmodel-1129"><span class="linenos">1129</span></a>        <span class="n">doubleExp</span><span class="p">:</span><span class="n">std_doubleExp</span><span class="p">,</span>
</span><span id="std_fmodel-1130"><a href="#std_fmodel-1130"><span class="linenos">1130</span></a>        <span class="n">doubleExp_u</span><span class="p">:</span><span class="n">std_doubleExp_u</span><span class="p">,</span>
</span><span id="std_fmodel-1131"><a href="#std_fmodel-1131"><span class="linenos">1131</span></a>        <span class="n">tripleExp</span><span class="p">:</span><span class="n">std_tripleExp</span><span class="p">,</span>
</span><span id="std_fmodel-1132"><a href="#std_fmodel-1132"><span class="linenos">1132</span></a>        <span class="n">tripleExp_u</span><span class="p">:</span><span class="n">std_tripleExp_u</span><span class="p">,</span>
</span><span id="std_fmodel-1133"><a href="#std_fmodel-1133"><span class="linenos">1133</span></a>        <span class="n">powerModel</span><span class="p">:</span><span class="n">std_powerModel</span><span class="p">,</span>
</span><span id="std_fmodel-1134"><a href="#std_fmodel-1134"><span class="linenos">1134</span></a>        <span class="p">}</span> <span class="c1"># add other functions here, when calculated (by hand)</span>
</span><span id="std_fmodel-1135"><a href="#std_fmodel-1135"><span class="linenos">1135</span></a>    <span class="n">std_func</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">fmodel</span><span class="p">]</span>  
</span><span id="std_fmodel-1136"><a href="#std_fmodel-1136"><span class="linenos">1136</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Returns caculated propagated error for the given model, over the entire time range given (xdata)</p>
</div>


                </section>
                <section id="rebuild_cov2">
                            <input id="rebuild_cov2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rebuild_cov2</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f_model</span>, </span><span class="param"><span class="n">params</span>, </span><span class="param"><span class="n">stdev</span>, </span><span class="param"><span class="n">covar</span></span>)</span>

                <label class="view-source-button" for="rebuild_cov2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rebuild_cov2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rebuild_cov2-1142"><a href="#rebuild_cov2-1142"><span class="linenos">1142</span></a><span class="k">def</span> <span class="nf">rebuild_cov2</span><span class="p">(</span><span class="n">f_model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">covar</span><span class="p">):</span>
</span><span id="rebuild_cov2-1143"><a href="#rebuild_cov2-1143"><span class="linenos">1143</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="rebuild_cov2-1144"><a href="#rebuild_cov2-1144"><span class="linenos">1144</span></a><span class="sd">    Rebuild the covariance matrix, in correct order from data saved as Excel dataframe.</span>
</span><span id="rebuild_cov2-1145"><a href="#rebuild_cov2-1145"><span class="linenos">1145</span></a><span class="sd">    &#39;&#39;&#39;</span>    
</span><span id="rebuild_cov2-1146"><a href="#rebuild_cov2-1146"><span class="linenos">1146</span></a>    <span class="n">f_params</span> <span class="o">=</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">f_model</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># excluding time</span>
</span><span id="rebuild_cov2-1147"><a href="#rebuild_cov2-1147"><span class="linenos">1147</span></a>
</span><span id="rebuild_cov2-1148"><a href="#rebuild_cov2-1148"><span class="linenos">1148</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="rebuild_cov2-1149"><a href="#rebuild_cov2-1149"><span class="linenos">1149</span></a>    <span class="n">param_values</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span>
</span><span id="rebuild_cov2-1150"><a href="#rebuild_cov2-1150"><span class="linenos">1150</span></a>    <span class="n">param_std_values</span> <span class="o">=</span> <span class="n">stdev</span><span class="o">.</span><span class="n">values</span> <span class="c1"># in same order as above</span>
</span><span id="rebuild_cov2-1151"><a href="#rebuild_cov2-1151"><span class="linenos">1151</span></a>    <span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span> <span class="c1">#.droplevel(level=[0,2])</span>
</span><span id="rebuild_cov2-1152"><a href="#rebuild_cov2-1152"><span class="linenos">1152</span></a>    
</span><span id="rebuild_cov2-1153"><a href="#rebuild_cov2-1153"><span class="linenos">1153</span></a>    <span class="k">def</span> <span class="nf">search_param</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span><span id="rebuild_cov2-1154"><a href="#rebuild_cov2-1154"><span class="linenos">1154</span></a>        <span class="sd">&#39;&#39;&#39;Returns an integer, position of search of param in params&#39;&#39;&#39;</span>
</span><span id="rebuild_cov2-1155"><a href="#rebuild_cov2-1155"><span class="linenos">1155</span></a>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
</span><span id="rebuild_cov2-1156"><a href="#rebuild_cov2-1156"><span class="linenos">1156</span></a>            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
</span><span id="rebuild_cov2-1157"><a href="#rebuild_cov2-1157"><span class="linenos">1157</span></a>                <span class="k">return</span> <span class="n">s</span>
</span><span id="rebuild_cov2-1158"><a href="#rebuild_cov2-1158"><span class="linenos">1158</span></a>    
</span><span id="rebuild_cov2-1159"><a href="#rebuild_cov2-1159"><span class="linenos">1159</span></a>    <span class="k">def</span> <span class="nf">search_covar</span><span class="p">(</span><span class="n">covar</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span><span id="rebuild_cov2-1160"><a href="#rebuild_cov2-1160"><span class="linenos">1160</span></a>        <span class="sd">&#39;&#39;&#39;Returns an integer, position of search covariance in matrix&#39;&#39;&#39;</span>
</span><span id="rebuild_cov2-1161"><a href="#rebuild_cov2-1161"><span class="linenos">1161</span></a>        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
</span><span id="rebuild_cov2-1162"><a href="#rebuild_cov2-1162"><span class="linenos">1162</span></a>            <span class="k">if</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">covar</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">s</span><span class="p">]:</span>
</span><span id="rebuild_cov2-1163"><a href="#rebuild_cov2-1163"><span class="linenos">1163</span></a>                <span class="k">return</span> <span class="n">s</span>
</span><span id="rebuild_cov2-1164"><a href="#rebuild_cov2-1164"><span class="linenos">1164</span></a>
</span><span id="rebuild_cov2-1165"><a href="#rebuild_cov2-1165"><span class="linenos">1165</span></a>    <span class="n">dicVal</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">param_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">}</span>
</span><span id="rebuild_cov2-1166"><a href="#rebuild_cov2-1166"><span class="linenos">1166</span></a>    <span class="n">dicStdev</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">param_std_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">}</span>
</span><span id="rebuild_cov2-1167"><a href="#rebuild_cov2-1167"><span class="linenos">1167</span></a>    <span class="c1">#print(param_names, param_values, param_std_values)</span>
</span><span id="rebuild_cov2-1168"><a href="#rebuild_cov2-1168"><span class="linenos">1168</span></a>    <span class="c1">#print(&quot;dicStdev \n&quot;, dicStdev)</span>
</span><span id="rebuild_cov2-1169"><a href="#rebuild_cov2-1169"><span class="linenos">1169</span></a>    
</span><span id="rebuild_cov2-1170"><a href="#rebuild_cov2-1170"><span class="linenos">1170</span></a>    <span class="n">p_opt_values</span> <span class="o">=</span><span class="p">[</span><span class="n">dicVal</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f_params</span><span class="p">]</span>
</span><span id="rebuild_cov2-1171"><a href="#rebuild_cov2-1171"><span class="linenos">1171</span></a>    
</span><span id="rebuild_cov2-1172"><a href="#rebuild_cov2-1172"><span class="linenos">1172</span></a>    <span class="n">p_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)))</span>
</span><span id="rebuild_cov2-1173"><a href="#rebuild_cov2-1173"><span class="linenos">1173</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)):</span>
</span><span id="rebuild_cov2-1174"><a href="#rebuild_cov2-1174"><span class="linenos">1174</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_params</span><span class="p">)):</span>
</span><span id="rebuild_cov2-1175"><a href="#rebuild_cov2-1175"><span class="linenos">1175</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
</span><span id="rebuild_cov2-1176"><a href="#rebuild_cov2-1176"><span class="linenos">1176</span></a>                <span class="n">p_cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dicStdev</span><span class="p">[</span><span class="n">f_params</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="rebuild_cov2-1177"><a href="#rebuild_cov2-1177"><span class="linenos">1177</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="rebuild_cov2-1178"><a href="#rebuild_cov2-1178"><span class="linenos">1178</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">f_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="rebuild_cov2-1179"><a href="#rebuild_cov2-1179"><span class="linenos">1179</span></a>                <span class="n">p2</span> <span class="o">=</span> <span class="n">f_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="rebuild_cov2-1180"><a href="#rebuild_cov2-1180"><span class="linenos">1180</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">search_covar</span><span class="p">(</span><span class="n">covar</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
</span><span id="rebuild_cov2-1181"><a href="#rebuild_cov2-1181"><span class="linenos">1181</span></a>                <span class="n">p_cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covar</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
</span><span id="rebuild_cov2-1182"><a href="#rebuild_cov2-1182"><span class="linenos">1182</span></a>    
</span><span id="rebuild_cov2-1183"><a href="#rebuild_cov2-1183"><span class="linenos">1183</span></a>    <span class="k">return</span> <span class="n">f_params</span><span class="p">,</span> <span class="n">p_opt_values</span><span class="p">,</span> <span class="n">p_cov</span>
</span></pre></div>


            <div class="docstring"><p>Rebuild the covariance matrix, in correct order from data saved as Excel dataframe.</p>
</div>


                </section>
                <section id="apply_Q10_bis">
                            <input id="apply_Q10_bis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_Q10_bis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Th</span>, </span><span class="param"><span class="n">tTs</span>, </span><span class="param"><span class="n">Ts</span>, </span><span class="param"><span class="n">FIT_func</span>, </span><span class="param"><span class="n">params</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="apply_Q10_bis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_Q10_bis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_Q10_bis-1185"><a href="#apply_Q10_bis-1185"><span class="linenos">1185</span></a><span class="k">def</span> <span class="nf">apply_Q10_bis</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">tTs</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="apply_Q10_bis-1186"><a href="#apply_Q10_bis-1186"><span class="linenos">1186</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="apply_Q10_bis-1187"><a href="#apply_Q10_bis-1187"><span class="linenos">1187</span></a><span class="sd">    Given an observation, its model function, its parameters, a given TH and TS, the function:</span>
</span><span id="apply_Q10_bis-1188"><a href="#apply_Q10_bis-1188"><span class="linenos">1188</span></a><span class="sd">    - calculates BC_TH_TS remaining at any given TH and TS</span>
</span><span id="apply_Q10_bis-1189"><a href="#apply_Q10_bis-1189"><span class="linenos">1189</span></a><span class="sd">    - calculates a propagaged error on BC_TH_TS based on fitting uncertainty of fitted params</span>
</span><span id="apply_Q10_bis-1190"><a href="#apply_Q10_bis-1190"><span class="linenos">1190</span></a><span class="sd">    </span>
</span><span id="apply_Q10_bis-1191"><a href="#apply_Q10_bis-1191"><span class="linenos">1191</span></a><span class="sd">    IMPROVEMENT/TODO: at the moment, does not include uncertaity from the Q10 temperature correction (would need uncertainty in fit kT, Q10, as well as new derative calculations)</span>
</span><span id="apply_Q10_bis-1192"><a href="#apply_Q10_bis-1192"><span class="linenos">1192</span></a><span class="sd">    </span>
</span><span id="apply_Q10_bis-1193"><a href="#apply_Q10_bis-1193"><span class="linenos">1193</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="apply_Q10_bis-1194"><a href="#apply_Q10_bis-1194"><span class="linenos">1194</span></a>    
</span><span id="apply_Q10_bis-1195"><a href="#apply_Q10_bis-1195"><span class="linenos">1195</span></a>    <span class="k">def</span> <span class="nf">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="apply_Q10_bis-1196"><a href="#apply_Q10_bis-1196"><span class="linenos">1196</span></a>        <span class="sd">&#39;&#39;&#39;calculate Q10 factor, based on relationship given Woolf 2021 ES&amp;T</span>
</span><span id="apply_Q10_bis-1197"><a href="#apply_Q10_bis-1197"><span class="linenos">1197</span></a><span class="sd">        TO_DO: alternative: provide Q10 data, and calculate a relationship</span>
</span><span id="apply_Q10_bis-1198"><a href="#apply_Q10_bis-1198"><span class="linenos">1198</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="apply_Q10_bis-1199"><a href="#apply_Q10_bis-1199"><span class="linenos">1199</span></a>        <span class="k">return</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">63.1579</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">tTs</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.19</span><span class="o">*</span><span class="n">Ts</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Ts</span><span class="o">-</span><span class="n">tTs</span><span class="p">)</span> <span class="p">)</span>
</span><span id="apply_Q10_bis-1200"><a href="#apply_Q10_bis-1200"><span class="linenos">1200</span></a>    
</span><span id="apply_Q10_bis-1201"><a href="#apply_Q10_bis-1201"><span class="linenos">1201</span></a>    <span class="k">def</span> <span class="nf">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="o">=</span><span class="n">tTs</span><span class="p">):</span>
</span><span id="apply_Q10_bis-1202"><a href="#apply_Q10_bis-1202"><span class="linenos">1202</span></a>        <span class="sd">&#39;&#39;&#39;calculate the fT ratio of the decay rates at exp temperature Ts over target temperature tTs, based on Woolf 2021 ES&amp;T&#39;&#39;&#39;</span>
</span><span id="apply_Q10_bis-1203"><a href="#apply_Q10_bis-1203"><span class="linenos">1203</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Q10</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">tTs</span><span class="o">-</span><span class="n">Ts</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="p">)</span>
</span><span id="apply_Q10_bis-1204"><a href="#apply_Q10_bis-1204"><span class="linenos">1204</span></a>    
</span><span id="apply_Q10_bis-1205"><a href="#apply_Q10_bis-1205"><span class="linenos">1205</span></a>    <span class="n">ft</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">Ts</span> <span class="o">==</span> <span class="n">tTs</span> <span class="k">else</span> <span class="n">fT</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">tTs</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1206"><a href="#apply_Q10_bis-1206"><span class="linenos">1206</span></a>    
</span><span id="apply_Q10_bis-1207"><a href="#apply_Q10_bis-1207"><span class="linenos">1207</span></a>    <span class="c1"># apply correction to decay constants</span>
</span><span id="apply_Q10_bis-1208"><a href="#apply_Q10_bis-1208"><span class="linenos">1208</span></a>    <span class="k">if</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1209"><a href="#apply_Q10_bis-1209"><span class="linenos">1209</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1210"><a href="#apply_Q10_bis-1210"><span class="linenos">1210</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k&#39;]], p_cov, singleExp)</span>
</span><span id="apply_Q10_bis-1211"><a href="#apply_Q10_bis-1211"><span class="linenos">1211</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]],</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">singleExp</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1212"><a href="#apply_Q10_bis-1212"><span class="linenos">1212</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;singleExp_u&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1213"><a href="#apply_Q10_bis-1213"><span class="linenos">1213</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">singleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1214"><a href="#apply_Q10_bis-1214"><span class="linenos">1214</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k&#39;], params[&#39;c&#39;]] , p_cov, singleExp_u)</span>
</span><span id="apply_Q10_bis-1215"><a href="#apply_Q10_bis-1215"><span class="linenos">1215</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">singleExp_u</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1216"><a href="#apply_Q10_bis-1216"><span class="linenos">1216</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1217"><a href="#apply_Q10_bis-1217"><span class="linenos">1217</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1218"><a href="#apply_Q10_bis-1218"><span class="linenos">1218</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], params[&#39;c1&#39;]] , p_cov, doubleExp)</span>
</span><span id="apply_Q10_bis-1219"><a href="#apply_Q10_bis-1219"><span class="linenos">1219</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">doubleExp</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1220"><a href="#apply_Q10_bis-1220"><span class="linenos">1220</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;doubleExp_u&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1221"><a href="#apply_Q10_bis-1221"><span class="linenos">1221</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">doubleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1222"><a href="#apply_Q10_bis-1222"><span class="linenos">1222</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;]] , p_cov, doubleExp_u)</span>
</span><span id="apply_Q10_bis-1223"><a href="#apply_Q10_bis-1223"><span class="linenos">1223</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">doubleExp_u</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1224"><a href="#apply_Q10_bis-1224"><span class="linenos">1224</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1225"><a href="#apply_Q10_bis-1225"><span class="linenos">1225</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1226"><a href="#apply_Q10_bis-1226"><span class="linenos">1226</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], ft*params[&#39;k3&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;]] , p_cov, tripleExp)</span>
</span><span id="apply_Q10_bis-1227"><a href="#apply_Q10_bis-1227"><span class="linenos">1227</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">tripleExp</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1228"><a href="#apply_Q10_bis-1228"><span class="linenos">1228</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;tripleExp_u&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1229"><a href="#apply_Q10_bis-1229"><span class="linenos">1229</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">tripleExp_u</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">ft</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1230"><a href="#apply_Q10_bis-1230"><span class="linenos">1230</span></a>        <span class="c1">#sigmaBC100 = std_fmodel([Th*365*ft], [ft*params[&#39;k1&#39;], ft*params[&#39;k2&#39;], ft*params[&#39;k3&#39;], params[&#39;c1&#39;], params[&#39;c2&#39;], params[&#39;c3&#39;]] , p_cov, tripleExp_u)</span>
</span><span id="apply_Q10_bis-1231"><a href="#apply_Q10_bis-1231"><span class="linenos">1231</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">tripleExp_u</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1232"><a href="#apply_Q10_bis-1232"><span class="linenos">1232</span></a>    <span class="k">elif</span> <span class="n">FIT_func</span> <span class="o">==</span> <span class="s1">&#39;powerModel&#39;</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1233"><a href="#apply_Q10_bis-1233"><span class="linenos">1233</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">powerModel_q10</span><span class="p">(</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
</span><span id="apply_Q10_bis-1234"><a href="#apply_Q10_bis-1234"><span class="linenos">1234</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">std_fmodel</span><span class="p">([</span><span class="n">Th</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="n">ft</span><span class="p">],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">p_cov</span><span class="p">,</span> <span class="n">powerModel</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1235"><a href="#apply_Q10_bis-1235"><span class="linenos">1235</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="apply_Q10_bis-1236"><a href="#apply_Q10_bis-1236"><span class="linenos">1236</span></a>        <span class="c1"># not supported</span>
</span><span id="apply_Q10_bis-1237"><a href="#apply_Q10_bis-1237"><span class="linenos">1237</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: encoutered model function not supported by Q10 recalibration for obs: &quot;</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">)</span>
</span><span id="apply_Q10_bis-1238"><a href="#apply_Q10_bis-1238"><span class="linenos">1238</span></a>        <span class="n">newBC100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="apply_Q10_bis-1239"><a href="#apply_Q10_bis-1239"><span class="linenos">1239</span></a>        <span class="n">sigmaBC100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="apply_Q10_bis-1240"><a href="#apply_Q10_bis-1240"><span class="linenos">1240</span></a>
</span><span id="apply_Q10_bis-1241"><a href="#apply_Q10_bis-1241"><span class="linenos">1241</span></a>    <span class="k">return</span> <span class="n">newBC100</span><span class="p">,</span> <span class="n">sigmaBC100</span>
</span></pre></div>


            <div class="docstring"><p>Given an observation, its model function, its parameters, a given TH and TS, the function:</p>

<ul>
<li>calculates BC_TH_TS remaining at any given TH and TS</li>
<li>calculates a propagaged error on BC_TH_TS based on fitting uncertainty of fitted params</li>
</ul>

<p>IMPROVEMENT/TODO: at the moment, does not include uncertaity from the Q10 temperature correction (would need uncertainty in fit kT, Q10, as well as new derative calculations)</p>
</div>


                </section>
                <section id="correlation_linear">
                            <input id="correlation_linear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">correlation_linear</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fitdata</span>,</span><span class="param">	<span class="n">metadata</span>,</span><span class="param">	<span class="n">x</span>,</span><span class="param">	<span class="n">y</span><span class="o">=</span><span class="s1">&#39;BC_Th_Ts&#39;</span>,</span><span class="param">	<span class="n">Ts</span><span class="o">=</span><span class="mi">15</span>,</span><span class="param">	<span class="n">Th</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">interactive</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">ax</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">outliers</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ifig</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">iobs</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">trendline</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">trenderror</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">wSigma</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">an</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="correlation_linear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#correlation_linear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="correlation_linear-1243"><a href="#correlation_linear-1243"><span class="linenos">1243</span></a><span class="k">def</span> <span class="nf">correlation_linear</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">,</span> <span class="n">Ts</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">Th</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ifig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trendline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trenderror</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wSigma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">an</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">6</span><span class="p">)):</span>
</span><span id="correlation_linear-1244"><a href="#correlation_linear-1244"><span class="linenos">1244</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="correlation_linear-1245"><a href="#correlation_linear-1245"><span class="linenos">1245</span></a><span class="sd">    Performs a linear correlation between the two variables x and y (which must be one column in either fitdata or metadata),</span>
</span><span id="correlation_linear-1246"><a href="#correlation_linear-1246"><span class="linenos">1246</span></a><span class="sd">    for a given soil temperature and a time horizon (if relevant, usually the case, when calculating BC_t). </span>
</span><span id="correlation_linear-1247"><a href="#correlation_linear-1247"><span class="linenos">1247</span></a><span class="sd">    </span>
</span><span id="correlation_linear-1248"><a href="#correlation_linear-1248"><span class="linenos">1248</span></a><span class="sd">    Normal use case:</span>
</span><span id="correlation_linear-1249"><a href="#correlation_linear-1249"><span class="linenos">1249</span></a><span class="sd">    - y=&#39;BC_Th_Ts&#39; will calculate amount of biochar C remaining at Th and Ts passed as argument; while x is usually taken from the metadata columns</span>
</span><span id="correlation_linear-1250"><a href="#correlation_linear-1250"><span class="linenos">1250</span></a><span class="sd">    - x must be from a metadata column, e.g. H/C_org, H/C_tot, HHT, Carbon, Carbon, organic, or another accepted value (currently H/C_all only)</span>
</span><span id="correlation_linear-1251"><a href="#correlation_linear-1251"><span class="linenos">1251</span></a><span class="sd">        - If `x = H/C_all`, then the metadata considered will be: H/C_org whenever available, and H/C_tot to bridge gaps.</span>
</span><span id="correlation_linear-1252"><a href="#correlation_linear-1252"><span class="linenos">1252</span></a>
</span><span id="correlation_linear-1253"><a href="#correlation_linear-1253"><span class="linenos">1253</span></a><span class="sd">    - At time of plotting, the function will return the number of observations dropped due to missing data. </span>
</span><span id="correlation_linear-1254"><a href="#correlation_linear-1254"><span class="linenos">1254</span></a><span class="sd">    - Selected `outliers` can be removed by specifying a list of ID_obs </span>
</span><span id="correlation_linear-1255"><a href="#correlation_linear-1255"><span class="linenos">1255</span></a><span class="sd">    - Plotting can be done in static manner, or interactive mode (with sliders)</span>
</span><span id="correlation_linear-1256"><a href="#correlation_linear-1256"><span class="linenos">1256</span></a><span class="sd">    </span>
</span><span id="correlation_linear-1257"><a href="#correlation_linear-1257"><span class="linenos">1257</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="correlation_linear-1258"><a href="#correlation_linear-1258"><span class="linenos">1258</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="correlation_linear-1259"><a href="#correlation_linear-1259"><span class="linenos">1259</span></a>    <span class="n">obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span><span id="correlation_linear-1260"><a href="#correlation_linear-1260"><span class="linenos">1260</span></a>    <span class="c1"># exclude identified outliers specified in *outliers*</span>
</span><span id="correlation_linear-1261"><a href="#correlation_linear-1261"><span class="linenos">1261</span></a>    <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="correlation_linear-1262"><a href="#correlation_linear-1262"><span class="linenos">1262</span></a>        <span class="n">obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
</span><span id="correlation_linear-1263"><a href="#correlation_linear-1263"><span class="linenos">1263</span></a>
</span><span id="correlation_linear-1264"><a href="#correlation_linear-1264"><span class="linenos">1264</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ID_obs&#39;</span><span class="p">)</span> <span class="c1"># change index to ID_obs, so that series have the same index</span>
</span><span id="correlation_linear-1265"><a href="#correlation_linear-1265"><span class="linenos">1265</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># filter metadata for the observations in the model minus outliers</span>
</span><span id="correlation_linear-1266"><a href="#correlation_linear-1266"><span class="linenos">1266</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs</span><span class="p">)]</span> <span class="c1"># filter metadata for the observations in the model</span>
</span><span id="correlation_linear-1267"><a href="#correlation_linear-1267"><span class="linenos">1267</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;na&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span> <span class="c1"># replaces &#39;na&#39; strings by NaN, for correct handling </span>
</span><span id="correlation_linear-1268"><a href="#correlation_linear-1268"><span class="linenos">1268</span></a>    
</span><span id="correlation_linear-1269"><a href="#correlation_linear-1269"><span class="linenos">1269</span></a>    <span class="c1"># Make sure fitdata and sub_metadata have same index elements &amp; order</span>
</span><span id="correlation_linear-1270"><a href="#correlation_linear-1270"><span class="linenos">1270</span></a>    <span class="n">fitdata</span> <span class="o">=</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="correlation_linear-1271"><a href="#correlation_linear-1271"><span class="linenos">1271</span></a>    <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index, to be sure it matches with metadata</span>
</span><span id="correlation_linear-1272"><a href="#correlation_linear-1272"><span class="linenos">1272</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">sub_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
</span><span id="correlation_linear-1273"><a href="#correlation_linear-1273"><span class="linenos">1273</span></a>        <span class="c1"># True if â€œotherâ€ is an Index and it has the same elements and order as the calling index; False otherwise.</span>
</span><span id="correlation_linear-1274"><a href="#correlation_linear-1274"><span class="linenos">1274</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Warning: the indexes of fitdata &amp; sub_metadata do not have same elments or same order&quot;</span><span class="p">)</span>
</span><span id="correlation_linear-1275"><a href="#correlation_linear-1275"><span class="linenos">1275</span></a>
</span><span id="correlation_linear-1276"><a href="#correlation_linear-1276"><span class="linenos">1276</span></a>    <span class="c1"># Retrieving vX</span>
</span><span id="correlation_linear-1277"><a href="#correlation_linear-1277"><span class="linenos">1277</span></a>    <span class="n">acc_x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">]</span> <span class="c1"># special values of x that are accepted (e.g. H/C_all &gt; using H/C_org if available, but bridging with H/C_tot if not available)</span>
</span><span id="correlation_linear-1278"><a href="#correlation_linear-1278"><span class="linenos">1278</span></a>    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acc_x</span><span class="p">:</span> <span class="c1"># verify x is in metadata.columns</span>
</span><span id="correlation_linear-1279"><a href="#correlation_linear-1279"><span class="linenos">1279</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;x = `</span><span class="si">{}</span><span class="s2">` must be a column in `metadata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="correlation_linear-1280"><a href="#correlation_linear-1280"><span class="linenos">1280</span></a>    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="correlation_linear-1281"><a href="#correlation_linear-1281"><span class="linenos">1281</span></a>        <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span id="correlation_linear-1282"><a href="#correlation_linear-1282"><span class="linenos">1282</span></a>    <span class="k">else</span><span class="p">:</span> <span class="c1"># x is a special value, swith and handle separately</span>
</span><span id="correlation_linear-1283"><a href="#correlation_linear-1283"><span class="linenos">1283</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;H/C_all&#39;</span><span class="p">:</span>
</span><span id="correlation_linear-1284"><a href="#correlation_linear-1284"><span class="linenos">1284</span></a>            <span class="n">vX</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_org&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;H/C_tot&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="correlation_linear-1285"><a href="#correlation_linear-1285"><span class="linenos">1285</span></a>
</span><span id="correlation_linear-1286"><a href="#correlation_linear-1286"><span class="linenos">1286</span></a>    <span class="c1"># Counting NaNs in vX</span>
</span><span id="correlation_linear-1287"><a href="#correlation_linear-1287"><span class="linenos">1287</span></a>    <span class="n">vXnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vX</span><span class="p">[</span><span class="n">vX</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="correlation_linear-1288"><a href="#correlation_linear-1288"><span class="linenos">1288</span></a>
</span><span id="correlation_linear-1289"><a href="#correlation_linear-1289"><span class="linenos">1289</span></a>    <span class="c1"># Retrieving vY</span>
</span><span id="correlation_linear-1290"><a href="#correlation_linear-1290"><span class="linenos">1290</span></a>    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">:</span>
</span><span id="correlation_linear-1291"><a href="#correlation_linear-1291"><span class="linenos">1291</span></a>        <span class="c1"># recalculate BC for given Th and Ts, and save it as vY, based on Q10 and fT saved in fitdata</span>
</span><span id="correlation_linear-1292"><a href="#correlation_linear-1292"><span class="linenos">1292</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="correlation_linear-1293"><a href="#correlation_linear-1293"><span class="linenos">1293</span></a>        <span class="n">sigvY</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="correlation_linear-1294"><a href="#correlation_linear-1294"><span class="linenos">1294</span></a>        <span class="k">for</span> <span class="n">obs</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="correlation_linear-1295"><a href="#correlation_linear-1295"><span class="linenos">1295</span></a>            <span class="n">Ts_ini</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="s1">&#39;IncubationTemperature&#39;</span><span class="p">]</span>
</span><span id="correlation_linear-1296"><a href="#correlation_linear-1296"><span class="linenos">1296</span></a>            <span class="n">FIT_func</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
</span><span id="correlation_linear-1297"><a href="#correlation_linear-1297"><span class="linenos">1297</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">]]</span>
</span><span id="correlation_linear-1298"><a href="#correlation_linear-1298"><span class="linenos">1298</span></a>            <span class="c1"># std is in absolute value (other named .1 =&gt; relative value, in %)</span>
</span><span id="correlation_linear-1299"><a href="#correlation_linear-1299"><span class="linenos">1299</span></a>            <span class="n">params_std</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;std_k&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c&#39;</span><span class="p">,</span><span class="s1">&#39;std_k1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c1&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c2&#39;</span><span class="p">,</span> <span class="s1">&#39;std_k3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c3&#39;</span><span class="p">,</span> <span class="s1">&#39;std_c0&#39;</span><span class="p">,</span> <span class="s1">&#39;std_b&#39;</span><span class="p">,</span> <span class="s1">&#39;std_m&#39;</span><span class="p">]]</span>
</span><span id="correlation_linear-1300"><a href="#correlation_linear-1300"><span class="linenos">1300</span></a>            <span class="n">params_corr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;corr(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, k3)&#39;</span><span class="p">,</span>
</span><span id="correlation_linear-1301"><a href="#correlation_linear-1301"><span class="linenos">1301</span></a>                            <span class="s1">&#39;corr(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(k3, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c2, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;corr(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;corr(b, m)&#39;</span><span class="p">]</span>
</span><span id="correlation_linear-1302"><a href="#correlation_linear-1302"><span class="linenos">1302</span></a>            <span class="n">params_cov</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">&#39;cov(k, c)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c1)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c2)&#39;</span><span class="p">,</span>
</span><span id="correlation_linear-1303"><a href="#correlation_linear-1303"><span class="linenos">1303</span></a>                           <span class="s1">&#39;cov(c1, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, k3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c1)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(k3, c2)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(k3, c3)&#39;</span><span class="p">,</span><span class="s1">&#39;cov(c1, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c2, c3)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, b)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(c0, m)&#39;</span><span class="p">,</span> <span class="s1">&#39;cov(b, m)&#39;</span><span class="p">]]</span>
</span><span id="correlation_linear-1304"><a href="#correlation_linear-1304"><span class="linenos">1304</span></a>            <span class="n">map_model_function</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;singleExp&quot;</span><span class="p">:</span><span class="n">singleExp</span><span class="p">,</span><span class="s2">&quot;singleExp_u&quot;</span><span class="p">:</span><span class="n">singleExp_u</span><span class="p">,</span><span class="s2">&quot;doubleExp&quot;</span><span class="p">:</span><span class="n">doubleExp</span><span class="p">,</span><span class="s2">&quot;doubleExp_u&quot;</span><span class="p">:</span><span class="n">doubleExp_u</span><span class="p">,</span><span class="s2">&quot;tripleExp&quot;</span><span class="p">:</span><span class="n">tripleExp</span><span class="p">,</span><span class="s2">&quot;tripleExp_u&quot;</span><span class="p">:</span><span class="n">tripleExp_u</span><span class="p">,</span><span class="s2">&quot;powerModel&quot;</span><span class="p">:</span><span class="n">powerModel</span><span class="p">,}</span>            
</span><span id="correlation_linear-1305"><a href="#correlation_linear-1305"><span class="linenos">1305</span></a>            
</span><span id="correlation_linear-1306"><a href="#correlation_linear-1306"><span class="linenos">1306</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span> <span class="o">=</span> <span class="n">rebuild_cov2</span><span class="p">(</span><span class="n">map_model_function</span><span class="p">[</span><span class="n">FIT_func</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_std</span><span class="p">,</span> <span class="n">params_cov</span><span class="p">)</span>
</span><span id="correlation_linear-1307"><a href="#correlation_linear-1307"><span class="linenos">1307</span></a>            <span class="n">BC</span><span class="p">,</span> <span class="n">sBC</span> <span class="o">=</span> <span class="n">apply_Q10_bis</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Ts_ini</span><span class="p">,</span> <span class="n">FIT_func</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">)</span>
</span><span id="correlation_linear-1308"><a href="#correlation_linear-1308"><span class="linenos">1308</span></a>            <span class="n">vY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
</span><span id="correlation_linear-1309"><a href="#correlation_linear-1309"><span class="linenos">1309</span></a>            <span class="n">sigvY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sBC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># [0] because functions returns a time series</span>
</span><span id="correlation_linear-1310"><a href="#correlation_linear-1310"><span class="linenos">1310</span></a>            
</span><span id="correlation_linear-1311"><a href="#correlation_linear-1311"><span class="linenos">1311</span></a>            <span class="k">if</span> <span class="n">obs</span> <span class="o">==</span> <span class="n">iobs</span><span class="p">:</span>
</span><span id="correlation_linear-1312"><a href="#correlation_linear-1312"><span class="linenos">1312</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BC_TH_TS&quot;</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span>
</span><span id="correlation_linear-1313"><a href="#correlation_linear-1313"><span class="linenos">1313</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sigma_BC&quot;</span><span class="p">,</span> <span class="n">sBC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="correlation_linear-1314"><a href="#correlation_linear-1314"><span class="linenos">1314</span></a>                
</span><span id="correlation_linear-1315"><a href="#correlation_linear-1315"><span class="linenos">1315</span></a>        <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vY</span>
</span><span id="correlation_linear-1316"><a href="#correlation_linear-1316"><span class="linenos">1316</span></a>        <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;std_BC_Th_Ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigvY</span>
</span><span id="correlation_linear-1317"><a href="#correlation_linear-1317"><span class="linenos">1317</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;BC_Th_Ts&#39;</span><span class="p">]</span>
</span><span id="correlation_linear-1318"><a href="#correlation_linear-1318"><span class="linenos">1318</span></a>        <span class="n">sigvY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="s1">&#39;std_BC_Th_Ts&#39;</span><span class="p">]</span>
</span><span id="correlation_linear-1319"><a href="#correlation_linear-1319"><span class="linenos">1319</span></a>    <span class="k">elif</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">fitdata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="correlation_linear-1320"><a href="#correlation_linear-1320"><span class="linenos">1320</span></a>        <span class="n">vY</span> <span class="o">=</span> <span class="n">fitdata</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
</span><span id="correlation_linear-1321"><a href="#correlation_linear-1321"><span class="linenos">1321</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="correlation_linear-1322"><a href="#correlation_linear-1322"><span class="linenos">1322</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;y = `</span><span class="si">{}</span><span class="s2">` must be a column in `fitdata` or an accepted value (check documentation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span><span id="correlation_linear-1323"><a href="#correlation_linear-1323"><span class="linenos">1323</span></a>
</span><span id="correlation_linear-1324"><a href="#correlation_linear-1324"><span class="linenos">1324</span></a>    <span class="c1"># Counting NaNs in vY</span>
</span><span id="correlation_linear-1325"><a href="#correlation_linear-1325"><span class="linenos">1325</span></a>    <span class="n">vYnan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vY</span><span class="p">[</span><span class="n">vY</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="correlation_linear-1326"><a href="#correlation_linear-1326"><span class="linenos">1326</span></a>
</span><span id="correlation_linear-1327"><a href="#correlation_linear-1327"><span class="linenos">1327</span></a>    <span class="c1"># Remove mutual any observation with nan values</span>
</span><span id="correlation_linear-1328"><a href="#correlation_linear-1328"><span class="linenos">1328</span></a>    <span class="n">vXYnan</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vXnan</span> <span class="o">+</span> <span class="n">vYnan</span><span class="p">)</span>
</span><span id="correlation_linear-1329"><a href="#correlation_linear-1329"><span class="linenos">1329</span></a>    <span class="n">vX</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="correlation_linear-1330"><a href="#correlation_linear-1330"><span class="linenos">1330</span></a>    <span class="n">vY</span> <span class="o">=</span> <span class="n">vY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="correlation_linear-1331"><a href="#correlation_linear-1331"><span class="linenos">1331</span></a>    <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># removing irrelevant observations, as in vX, vY</span>
</span><span id="correlation_linear-1332"><a href="#correlation_linear-1332"><span class="linenos">1332</span></a>    <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remainin nan, where uncertainty could not be calculated for some reason, replaced by 0</span>
</span><span id="correlation_linear-1333"><a href="#correlation_linear-1333"><span class="linenos">1333</span></a>
</span><span id="correlation_linear-1334"><a href="#correlation_linear-1334"><span class="linenos">1334</span></a>    <span class="c1"># Names of Obs, for interactive plot; and colors</span>
</span><span id="correlation_linear-1335"><a href="#correlation_linear-1335"><span class="linenos">1335</span></a>    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Obs &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="correlation_linear-1336"><a href="#correlation_linear-1336"><span class="linenos">1336</span></a>    <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span id="correlation_linear-1337"><a href="#correlation_linear-1337"><span class="linenos">1337</span></a>    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlGn</span>
</span><span id="correlation_linear-1338"><a href="#correlation_linear-1338"><span class="linenos">1338</span></a>
</span><span id="correlation_linear-1339"><a href="#correlation_linear-1339"><span class="linenos">1339</span></a>    <span class="n">vXa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vX</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="correlation_linear-1340"><a href="#correlation_linear-1340"><span class="linenos">1340</span></a>    <span class="n">vYa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vY</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="correlation_linear-1341"><a href="#correlation_linear-1341"><span class="linenos">1341</span></a>    <span class="n">sigvYa</span> <span class="o">=</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sigvY</span><span class="o">.</span><span class="n">values</span> <span class="c1">#np.array([sigvY.values, sigvY.values])</span>
</span><span id="correlation_linear-1342"><a href="#correlation_linear-1342"><span class="linenos">1342</span></a>    <span class="n">xxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)])</span>
</span><span id="correlation_linear-1343"><a href="#correlation_linear-1343"><span class="linenos">1343</span></a>
</span><span id="correlation_linear-1344"><a href="#correlation_linear-1344"><span class="linenos">1344</span></a>    <span class="c1">## WITH SKLEARN</span>
</span><span id="correlation_linear-1345"><a href="#correlation_linear-1345"><span class="linenos">1345</span></a>    <span class="c1"># Linear Curve fitting - without testing/training sets - full descriptive analysis</span>
</span><span id="correlation_linear-1346"><a href="#correlation_linear-1346"><span class="linenos">1346</span></a>    <span class="n">reg_hc</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</span><span id="correlation_linear-1347"><a href="#correlation_linear-1347"><span class="linenos">1347</span></a>    <span class="n">reg_hc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">vXa</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vYa</span> <span class="p">)</span>
</span><span id="correlation_linear-1348"><a href="#correlation_linear-1348"><span class="linenos">1348</span></a>    <span class="n">y_predict_reg_hc</span> <span class="o">=</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">vXa</span> <span class="p">)</span>
</span><span id="correlation_linear-1349"><a href="#correlation_linear-1349"><span class="linenos">1349</span></a>    <span class="n">r2_regHC</span> <span class="o">=</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">vXa</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">vYa</span><span class="p">)</span>
</span><span id="correlation_linear-1350"><a href="#correlation_linear-1350"><span class="linenos">1350</span></a>    <span class="n">rmse_regHC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">vYa</span><span class="p">,</span> <span class="n">y_predict_reg_hc</span><span class="p">))</span>
</span><span id="correlation_linear-1351"><a href="#correlation_linear-1351"><span class="linenos">1351</span></a>    <span class="n">exvar_regHC</span> <span class="o">=</span> <span class="n">explained_variance_score</span><span class="p">(</span><span class="n">vYa</span><span class="p">,</span> <span class="n">y_predict_reg_hc</span><span class="p">)</span>
</span><span id="correlation_linear-1352"><a href="#correlation_linear-1352"><span class="linenos">1352</span></a>    <span class="n">sl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg_hc</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</span><span id="correlation_linear-1353"><a href="#correlation_linear-1353"><span class="linenos">1353</span></a>    <span class="n">it</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg_hc</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
</span><span id="correlation_linear-1354"><a href="#correlation_linear-1354"><span class="linenos">1354</span></a>    
</span><span id="correlation_linear-1355"><a href="#correlation_linear-1355"><span class="linenos">1355</span></a>    <span class="c1">## WITH SCIPY</span>
</span><span id="correlation_linear-1356"><a href="#correlation_linear-1356"><span class="linenos">1356</span></a>    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="correlation_linear-1357"><a href="#correlation_linear-1357"><span class="linenos">1357</span></a>        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span>
</span><span id="correlation_linear-1358"><a href="#correlation_linear-1358"><span class="linenos">1358</span></a>    
</span><span id="correlation_linear-1359"><a href="#correlation_linear-1359"><span class="linenos">1359</span></a>    <span class="k">def</span> <span class="nf">std_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="correlation_linear-1360"><a href="#correlation_linear-1360"><span class="linenos">1360</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="correlation_linear-1361"><a href="#correlation_linear-1361"><span class="linenos">1361</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="correlation_linear-1362"><a href="#correlation_linear-1362"><span class="linenos">1362</span></a>        <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="correlation_linear-1363"><a href="#correlation_linear-1363"><span class="linenos">1363</span></a>        <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="correlation_linear-1364"><a href="#correlation_linear-1364"><span class="linenos">1364</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span><span id="correlation_linear-1365"><a href="#correlation_linear-1365"><span class="linenos">1365</span></a>    
</span><span id="correlation_linear-1366"><a href="#correlation_linear-1366"><span class="linenos">1366</span></a>    <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">vX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">vY</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="correlation_linear-1367"><a href="#correlation_linear-1367"><span class="linenos">1367</span></a>    <span class="n">r2_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span>  <span class="n">rsquare</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="correlation_linear-1368"><a href="#correlation_linear-1368"><span class="linenos">1368</span></a>    <span class="k">if</span> <span class="n">wSigma</span><span class="p">:</span>
</span><span id="correlation_linear-1369"><a href="#correlation_linear-1369"><span class="linenos">1369</span></a>        <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">vX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">vY</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="n">p_opt1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sigvY</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="correlation_linear-1370"><a href="#correlation_linear-1370"><span class="linenos">1370</span></a>        <span class="n">r2_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span>  <span class="n">rsquare</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">)</span> <span class="c1"># R2</span>
</span><span id="correlation_linear-1371"><a href="#correlation_linear-1371"><span class="linenos">1371</span></a>        <span class="c1">## why 1/sigvY suggested by some (as weighing factor) and why not just sigvY (which does not find a solution?)</span>
</span><span id="correlation_linear-1372"><a href="#correlation_linear-1372"><span class="linenos">1372</span></a>
</span><span id="correlation_linear-1373"><a href="#correlation_linear-1373"><span class="linenos">1373</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="correlation_linear-1374"><a href="#correlation_linear-1374"><span class="linenos">1374</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">values</span>
</span><span id="correlation_linear-1375"><a href="#correlation_linear-1375"><span class="linenos">1375</span></a>    <span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">vY</span><span class="o">.</span><span class="n">values</span>
</span><span id="correlation_linear-1376"><a href="#correlation_linear-1376"><span class="linenos">1376</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="correlation_linear-1377"><a href="#correlation_linear-1377"><span class="linenos">1377</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="correlation_linear-1378"><a href="#correlation_linear-1378"><span class="linenos">1378</span></a>
</span><span id="correlation_linear-1379"><a href="#correlation_linear-1379"><span class="linenos">1379</span></a>    <span class="c1"># plotting</span>
</span><span id="correlation_linear-1380"><a href="#correlation_linear-1380"><span class="linenos">1380</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="correlation_linear-1381"><a href="#correlation_linear-1381"><span class="linenos">1381</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vXnan</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="correlation_linear-1382"><a href="#correlation_linear-1382"><span class="linenos">1382</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The parameter x=`</span><span class="si">{}</span><span class="s2">` contains </span><span class="si">{}</span><span class="s2"> NaN values, from observations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vXnan</span><span class="p">),</span> <span class="n">vXnan</span><span class="p">))</span>
</span><span id="correlation_linear-1383"><a href="#correlation_linear-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vYnan</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="correlation_linear-1384"><a href="#correlation_linear-1384"><span class="linenos">1384</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The parameter y=`</span><span class="si">{}</span><span class="s2">` contains </span><span class="si">{}</span><span class="s2"> NaN values, from observations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vYnan</span><span class="p">),</span> <span class="n">vYnan</span><span class="p">))</span>
</span><span id="correlation_linear-1385"><a href="#correlation_linear-1385"><span class="linenos">1385</span></a>        <span class="k">if</span> <span class="n">outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="correlation_linear-1386"><a href="#correlation_linear-1386"><span class="linenos">1386</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specified outliers (</span><span class="si">{}</span><span class="s2">) were removed from regression: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">),</span> <span class="n">outliers</span><span class="p">))</span>
</span><span id="correlation_linear-1387"><a href="#correlation_linear-1387"><span class="linenos">1387</span></a>
</span><span id="correlation_linear-1388"><a href="#correlation_linear-1388"><span class="linenos">1388</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remaining number of observations in the graph:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vXa</span><span class="p">)))</span>
</span><span id="correlation_linear-1389"><a href="#correlation_linear-1389"><span class="linenos">1389</span></a>        <span class="c1"># print(&quot;R2 of H:C ratio regression: &quot;, r2_regHC)</span>
</span><span id="correlation_linear-1390"><a href="#correlation_linear-1390"><span class="linenos">1390</span></a>        <span class="c1"># print(&quot;RMSE of H:C ratio regression: &quot;, rmse_regHC)</span>
</span><span id="correlation_linear-1391"><a href="#correlation_linear-1391"><span class="linenos">1391</span></a>        <span class="c1"># print(&quot;Explained variance: &quot;, exvar_regHC)</span>
</span><span id="correlation_linear-1392"><a href="#correlation_linear-1392"><span class="linenos">1392</span></a>
</span><span id="correlation_linear-1393"><a href="#correlation_linear-1393"><span class="linenos">1393</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Linear regression between: </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="correlation_linear-1394"><a href="#correlation_linear-1394"><span class="linenos">1394</span></a>        <span class="c1">#fig, ax = plt.subplots(nrows=1, ncols=2, sharey=False, figsize=[12,6])</span>
</span><span id="correlation_linear-1395"><a href="#correlation_linear-1395"><span class="linenos">1395</span></a>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
</span><span id="correlation_linear-1396"><a href="#correlation_linear-1396"><span class="linenos">1396</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="correlation_linear-1397"><a href="#correlation_linear-1397"><span class="linenos">1397</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="correlation_linear-1398"><a href="#correlation_linear-1398"><span class="linenos">1398</span></a>        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1"># decay fits</span>
</span><span id="correlation_linear-1399"><a href="#correlation_linear-1399"><span class="linenos">1399</span></a>        <span class="c1">#ax2 = plt.subplot(r,c,(3, 3)) # 100 year extrapo</span>
</span><span id="correlation_linear-1400"><a href="#correlation_linear-1400"><span class="linenos">1400</span></a>        <span class="n">ax2</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="correlation_linear-1401"><a href="#correlation_linear-1401"><span class="linenos">1401</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span>
</span><span id="correlation_linear-1402"><a href="#correlation_linear-1402"><span class="linenos">1402</span></a>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
</span><span id="correlation_linear-1403"><a href="#correlation_linear-1403"><span class="linenos">1403</span></a>
</span><span id="correlation_linear-1404"><a href="#correlation_linear-1404"><span class="linenos">1404</span></a>        <span class="c1">#ax[i].scatter(vXa, vYa, s=20, marker=&quot;o&quot;)</span>
</span><span id="correlation_linear-1405"><a href="#correlation_linear-1405"><span class="linenos">1405</span></a>    
</span><span id="correlation_linear-1406"><a href="#correlation_linear-1406"><span class="linenos">1406</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
</span><span id="correlation_linear-1407"><a href="#correlation_linear-1407"><span class="linenos">1407</span></a>                        <span class="n">style</span><span class="o">=</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
</span><span id="correlation_linear-1408"><a href="#correlation_linear-1408"><span class="linenos">1408</span></a>                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</span><span id="correlation_linear-1409"><a href="#correlation_linear-1409"><span class="linenos">1409</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1410"><a href="#correlation_linear-1410"><span class="linenos">1410</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1411"><a href="#correlation_linear-1411"><span class="linenos">1411</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="correlation_linear-1412"><a href="#correlation_linear-1412"><span class="linenos">1412</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> 
</span><span id="correlation_linear-1413"><a href="#correlation_linear-1413"><span class="linenos">1413</span></a>
</span><span id="correlation_linear-1414"><a href="#correlation_linear-1414"><span class="linenos">1414</span></a>        <span class="c1">#ax[i].errorbar(vXa.flatten(), vYa.flatten(), yerr=sigvYa, fmt=&quot;none&quot;,</span>
</span><span id="correlation_linear-1415"><a href="#correlation_linear-1415"><span class="linenos">1415</span></a>        <span class="c1">#               barsabove=True, elinewidth=0.5, ecolor=&#39;k&#39;, solid_capstyle=&#39;butt&#39;, capthick=0.5, capsize=2)</span>
</span><span id="correlation_linear-1416"><a href="#correlation_linear-1416"><span class="linenos">1416</span></a>
</span><span id="correlation_linear-1417"><a href="#correlation_linear-1417"><span class="linenos">1417</span></a>        <span class="k">if</span> <span class="n">an</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="correlation_linear-1418"><a href="#correlation_linear-1418"><span class="linenos">1418</span></a>            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">vX</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</span><span id="correlation_linear-1419"><a href="#correlation_linear-1419"><span class="linenos">1419</span></a>            <span class="n">xss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vXa</span><span class="p">)</span>
</span><span id="correlation_linear-1420"><a href="#correlation_linear-1420"><span class="linenos">1420</span></a>            <span class="n">yss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vYa</span><span class="p">)</span>
</span><span id="correlation_linear-1421"><a href="#correlation_linear-1421"><span class="linenos">1421</span></a>            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
</span><span id="correlation_linear-1422"><a href="#correlation_linear-1422"><span class="linenos">1422</span></a>                <span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xss</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">yss</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span><span id="correlation_linear-1423"><a href="#correlation_linear-1423"><span class="linenos">1423</span></a>
</span><span id="correlation_linear-1424"><a href="#correlation_linear-1424"><span class="linenos">1424</span></a>        <span class="c1">#ax[i].plot(xxx, reg_hc.predict(X = xxx.reshape(-1, 1) ), color=&#39;red&#39;)</span>
</span><span id="correlation_linear-1425"><a href="#correlation_linear-1425"><span class="linenos">1425</span></a>        <span class="k">if</span> <span class="n">trendline</span><span class="p">:</span>
</span><span id="correlation_linear-1426"><a href="#correlation_linear-1426"><span class="linenos">1426</span></a>            <span class="n">lbl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2"> | R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="p">,</span> <span class="n">p_opt1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2_1</span><span class="p">)</span>
</span><span id="correlation_linear-1427"><a href="#correlation_linear-1427"><span class="linenos">1427</span></a>            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="correlation_linear-1428"><a href="#correlation_linear-1428"><span class="linenos">1428</span></a>            <span class="k">if</span> <span class="n">trenderror</span><span class="p">:</span>
</span><span id="correlation_linear-1429"><a href="#correlation_linear-1429"><span class="linenos">1429</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="correlation_linear-1430"><a href="#correlation_linear-1430"><span class="linenos">1430</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="correlation_linear-1431"><a href="#correlation_linear-1431"><span class="linenos">1431</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear regression: &quot;</span><span class="o">+</span><span class="n">lbl</span><span class="p">)</span>
</span><span id="correlation_linear-1432"><a href="#correlation_linear-1432"><span class="linenos">1432</span></a>            <span class="k">if</span> <span class="n">wSigma</span><span class="p">:</span>
</span><span id="correlation_linear-1433"><a href="#correlation_linear-1433"><span class="linenos">1433</span></a>                <span class="n">lbl</span> <span class="o">=</span> <span class="s2">&quot;WithSigma: </span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2"> | R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="p">,</span> <span class="n">p_opt2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2_2</span><span class="p">)</span>
</span><span id="correlation_linear-1434"><a href="#correlation_linear-1434"><span class="linenos">1434</span></a>                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lbl</span><span class="p">)</span>
</span><span id="correlation_linear-1435"><a href="#correlation_linear-1435"><span class="linenos">1435</span></a>                <span class="k">if</span> <span class="n">trenderror</span><span class="p">:</span>
</span><span id="correlation_linear-1436"><a href="#correlation_linear-1436"><span class="linenos">1436</span></a>                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="correlation_linear-1437"><a href="#correlation_linear-1437"><span class="linenos">1437</span></a>                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt2</span><span class="p">,</span> <span class="n">p_cov2</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="correlation_linear-1438"><a href="#correlation_linear-1438"><span class="linenos">1438</span></a>                
</span><span id="correlation_linear-1439"><a href="#correlation_linear-1439"><span class="linenos">1439</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="correlation_linear-1440"><a href="#correlation_linear-1440"><span class="linenos">1440</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1441"><a href="#correlation_linear-1441"><span class="linenos">1441</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1442"><a href="#correlation_linear-1442"><span class="linenos">1442</span></a>        
</span><span id="correlation_linear-1443"><a href="#correlation_linear-1443"><span class="linenos">1443</span></a>        <span class="c1">#ax[i].annotate(text=&quot;{} = {:.2f} x {} + {:.2f}\nR2 = {:.2f}&quot;.format(y, sl, x ,it, r2_regHC), xy= (0.5, 0.9), xycoords=&#39;axes fraction&#39;, fontsize=10)</span>
</span><span id="correlation_linear-1444"><a href="#correlation_linear-1444"><span class="linenos">1444</span></a>        
</span><span id="correlation_linear-1445"><a href="#correlation_linear-1445"><span class="linenos">1445</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="correlation_linear-1446"><a href="#correlation_linear-1446"><span class="linenos">1446</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="correlation_linear-1447"><a href="#correlation_linear-1447"><span class="linenos">1447</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="correlation_linear-1448"><a href="#correlation_linear-1448"><span class="linenos">1448</span></a>
</span><span id="correlation_linear-1449"><a href="#correlation_linear-1449"><span class="linenos">1449</span></a>        <span class="c1">#tsp = str(datetime.now().strftime(&quot;%Y-%m-%d_%H-%M&quot;))    </span>
</span><span id="correlation_linear-1450"><a href="#correlation_linear-1450"><span class="linenos">1450</span></a>        <span class="c1">#plt.savefig(&#39;data_analysed/img-fid/&#39;+name+&#39;_&#39;+tsp+&#39;.png&#39;,dpi=300)</span>
</span><span id="correlation_linear-1451"><a href="#correlation_linear-1451"><span class="linenos">1451</span></a>        <span class="c1">#plt.show()</span>
</span><span id="correlation_linear-1452"><a href="#correlation_linear-1452"><span class="linenos">1452</span></a>        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> 
</span><span id="correlation_linear-1453"><a href="#correlation_linear-1453"><span class="linenos">1453</span></a>    
</span><span id="correlation_linear-1454"><a href="#correlation_linear-1454"><span class="linenos">1454</span></a>    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
</span><span id="correlation_linear-1455"><a href="#correlation_linear-1455"><span class="linenos">1455</span></a>        <span class="c1">#plt.clf()</span>
</span><span id="correlation_linear-1456"><a href="#correlation_linear-1456"><span class="linenos">1456</span></a>        <span class="c1"># we assume an ax was provided</span>
</span><span id="correlation_linear-1457"><a href="#correlation_linear-1457"><span class="linenos">1457</span></a>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
</span><span id="correlation_linear-1458"><a href="#correlation_linear-1458"><span class="linenos">1458</span></a>        <span class="c1">#[l.remove() for l in ax[i].lines]</span>
</span><span id="correlation_linear-1459"><a href="#correlation_linear-1459"><span class="linenos">1459</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
</span><span id="correlation_linear-1460"><a href="#correlation_linear-1460"><span class="linenos">1460</span></a>
</span><span id="correlation_linear-1461"><a href="#correlation_linear-1461"><span class="linenos">1461</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">vXa</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">vYa</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sigvYa</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="correlation_linear-1462"><a href="#correlation_linear-1462"><span class="linenos">1462</span></a>                          <span class="n">barsabove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;butt&#39;</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="correlation_linear-1463"><a href="#correlation_linear-1463"><span class="linenos">1463</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)]),</span> <span class="n">reg_hc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="correlation_linear-1464"><a href="#correlation_linear-1464"><span class="linenos">1464</span></a>        
</span><span id="correlation_linear-1465"><a href="#correlation_linear-1465"><span class="linenos">1465</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vXa</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vXa</span><span class="p">)]),</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
</span><span id="correlation_linear-1466"><a href="#correlation_linear-1466"><span class="linenos">1466</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="correlation_linear-1467"><a href="#correlation_linear-1467"><span class="linenos">1467</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="o">*</span><span class="n">p_opt1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">std_linear</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xxx</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="correlation_linear-1468"><a href="#correlation_linear-1468"><span class="linenos">1468</span></a>        
</span><span id="correlation_linear-1469"><a href="#correlation_linear-1469"><span class="linenos">1469</span></a>        <span class="c1">#sc = ax[i].scatter(vXa, vYa, s=20, marker=&quot;o&quot;)</span>
</span><span id="correlation_linear-1470"><a href="#correlation_linear-1470"><span class="linenos">1470</span></a>        <span class="n">sc</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
</span><span id="correlation_linear-1471"><a href="#correlation_linear-1471"><span class="linenos">1471</span></a>                        <span class="n">style</span><span class="o">=</span><span class="s1">&#39;PyrolysisClass&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BiomassClass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
</span><span id="correlation_linear-1472"><a href="#correlation_linear-1472"><span class="linenos">1472</span></a>                        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</span><span id="correlation_linear-1473"><a href="#correlation_linear-1473"><span class="linenos">1473</span></a>        
</span><span id="correlation_linear-1474"><a href="#correlation_linear-1474"><span class="linenos">1474</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="correlation_linear-1475"><a href="#correlation_linear-1475"><span class="linenos">1475</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1476"><a href="#correlation_linear-1476"><span class="linenos">1476</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="correlation_linear-1477"><a href="#correlation_linear-1477"><span class="linenos">1477</span></a>        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">R2 = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">x</span> <span class="p">,</span><span class="n">it</span><span class="p">,</span> <span class="n">r2_regHC</span><span class="p">),</span> 
</span><span id="correlation_linear-1478"><a href="#correlation_linear-1478"><span class="linenos">1478</span></a>                       <span class="n">xy</span><span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="correlation_linear-1479"><a href="#correlation_linear-1479"><span class="linenos">1479</span></a>        
</span><span id="correlation_linear-1480"><a href="#correlation_linear-1480"><span class="linenos">1480</span></a>        <span class="c1"># https://towardsdatascience.com/tooltips-with-pythons-matplotlib-dcd8db758846</span>
</span><span id="correlation_linear-1481"><a href="#correlation_linear-1481"><span class="linenos">1481</span></a>        <span class="n">annot</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
</span><span id="correlation_linear-1482"><a href="#correlation_linear-1482"><span class="linenos">1482</span></a>                            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">),</span>
</span><span id="correlation_linear-1483"><a href="#correlation_linear-1483"><span class="linenos">1483</span></a>                            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">))</span>
</span><span id="correlation_linear-1484"><a href="#correlation_linear-1484"><span class="linenos">1484</span></a>        <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="correlation_linear-1485"><a href="#correlation_linear-1485"><span class="linenos">1485</span></a>
</span><span id="correlation_linear-1486"><a href="#correlation_linear-1486"><span class="linenos">1486</span></a>        <span class="k">def</span> <span class="nf">update_annot</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
</span><span id="correlation_linear-1487"><a href="#correlation_linear-1487"><span class="linenos">1487</span></a>
</span><span id="correlation_linear-1488"><a href="#correlation_linear-1488"><span class="linenos">1488</span></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_offsets</span><span class="p">()[</span><span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="correlation_linear-1489"><a href="#correlation_linear-1489"><span class="linenos">1489</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="correlation_linear-1490"><a href="#correlation_linear-1490"><span class="linenos">1490</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">]]))</span>
</span><span id="correlation_linear-1491"><a href="#correlation_linear-1491"><span class="linenos">1491</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="correlation_linear-1492"><a href="#correlation_linear-1492"><span class="linenos">1492</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ind&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]])))</span>
</span><span id="correlation_linear-1493"><a href="#correlation_linear-1493"><span class="linenos">1493</span></a>            <span class="n">annot</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span><span id="correlation_linear-1494"><a href="#correlation_linear-1494"><span class="linenos">1494</span></a>
</span><span id="correlation_linear-1495"><a href="#correlation_linear-1495"><span class="linenos">1495</span></a>
</span><span id="correlation_linear-1496"><a href="#correlation_linear-1496"><span class="linenos">1496</span></a>        <span class="k">def</span> <span class="nf">hover</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="correlation_linear-1497"><a href="#correlation_linear-1497"><span class="linenos">1497</span></a>            <span class="n">vis</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
</span><span id="correlation_linear-1498"><a href="#correlation_linear-1498"><span class="linenos">1498</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="correlation_linear-1499"><a href="#correlation_linear-1499"><span class="linenos">1499</span></a>                <span class="n">cont</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="correlation_linear-1500"><a href="#correlation_linear-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
</span><span id="correlation_linear-1501"><a href="#correlation_linear-1501"><span class="linenos">1501</span></a>                    <span class="n">update_annot</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
</span><span id="correlation_linear-1502"><a href="#correlation_linear-1502"><span class="linenos">1502</span></a>                    <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="correlation_linear-1503"><a href="#correlation_linear-1503"><span class="linenos">1503</span></a>                    <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="correlation_linear-1504"><a href="#correlation_linear-1504"><span class="linenos">1504</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="correlation_linear-1505"><a href="#correlation_linear-1505"><span class="linenos">1505</span></a>                    <span class="k">if</span> <span class="n">vis</span><span class="p">:</span>
</span><span id="correlation_linear-1506"><a href="#correlation_linear-1506"><span class="linenos">1506</span></a>                        <span class="n">annot</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="correlation_linear-1507"><a href="#correlation_linear-1507"><span class="linenos">1507</span></a>                        <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
</span><span id="correlation_linear-1508"><a href="#correlation_linear-1508"><span class="linenos">1508</span></a>
</span><span id="correlation_linear-1509"><a href="#correlation_linear-1509"><span class="linenos">1509</span></a>        <span class="n">ifig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">&quot;button_press_event&quot;</span><span class="p">,</span> <span class="n">hover</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs a linear correlation between the two variables x and y (which must be one column in either fitdata or metadata),
for a given soil temperature and a time horizon (if relevant, usually the case, when calculating BC_t). </p>

<p>Normal use case:</p>

<ul>
<li>y='BC_Th_Ts' will calculate amount of biochar C remaining at Th and Ts passed as argument; while x is usually taken from the metadata columns</li>
<li>x must be from a metadata column, e.g. H/C_org, H/C_tot, HHT, Carbon, Carbon, organic, or another accepted value (currently H/C_all only)
<ul>
<li>If <code>x = H/C_all</code>, then the metadata considered will be: H/C_org whenever available, and H/C_tot to bridge gaps.</li>
</ul></li>
</ul>

<ul>
<li>At time of plotting, the function will return the number of observations dropped due to missing data. </li>
<li>Selected <code>outliers</code> can be removed by specifying a list of ID_obs </li>
<li>Plotting can be done in static manner, or interactive mode (with sliders)</li>
</ul>
</div>


                </section>
                <section id="linear">
                            <input id="linear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">linear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">a</span>, </span><span class="param"><span class="n">b</span></span>)</span>

                <label class="view-source-button" for="linear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#linear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="linear-1608"><a href="#linear-1608"><span class="linenos">1608</span></a><span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="linear-1609"><a href="#linear-1609"><span class="linenos">1609</span></a>    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span>
</span></pre></div>


    

                </section>
                <section id="std_linear">
                            <input id="std_linear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">std_linear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">p_opt</span>, </span><span class="param"><span class="n">p_cov</span></span>)</span>

                <label class="view-source-button" for="std_linear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#std_linear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="std_linear-1611"><a href="#std_linear-1611"><span class="linenos">1611</span></a><span class="k">def</span> <span class="nf">std_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_opt</span><span class="p">,</span> <span class="n">p_cov</span><span class="p">):</span>
</span><span id="std_linear-1612"><a href="#std_linear-1612"><span class="linenos">1612</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="std_linear-1613"><a href="#std_linear-1613"><span class="linenos">1613</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="std_linear-1614"><a href="#std_linear-1614"><span class="linenos">1614</span></a>    <span class="n">gX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="std_linear-1615"><a href="#std_linear-1615"><span class="linenos">1615</span></a>    <span class="n">std_f2</span> <span class="o">=</span> <span class="n">gX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">p_cov</span> <span class="o">@</span> <span class="n">gX</span>
</span><span id="std_linear-1616"><a href="#std_linear-1616"><span class="linenos">1616</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_f2</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="calc_correlation_timeseries">
                            <input id="calc_correlation_timeseries-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calc_correlation_timeseries</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fitdata</span>,</span><span class="param">	<span class="n">metadata</span>,</span><span class="param">	<span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">outliers</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Ts</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>,</span><span class="param">	<span class="n">Th</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="calc_correlation_timeseries-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calc_correlation_timeseries"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calc_correlation_timeseries-1618"><a href="#calc_correlation_timeseries-1618"><span class="linenos">1618</span></a><span class="k">def</span> <span class="nf">calc_correlation_timeseries</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
</span><span id="calc_correlation_timeseries-1619"><a href="#calc_correlation_timeseries-1619"><span class="linenos">1619</span></a>                                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H/C_all&#39;</span><span class="p">],</span>
</span><span id="calc_correlation_timeseries-1620"><a href="#calc_correlation_timeseries-1620"><span class="linenos">1620</span></a>                                <span class="n">outliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="calc_correlation_timeseries-1621"><a href="#calc_correlation_timeseries-1621"><span class="linenos">1621</span></a>                                <span class="n">Ts</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
</span><span id="calc_correlation_timeseries-1622"><a href="#calc_correlation_timeseries-1622"><span class="linenos">1622</span></a>                                <span class="n">Th</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
</span><span id="calc_correlation_timeseries-1623"><a href="#calc_correlation_timeseries-1623"><span class="linenos">1623</span></a>                               <span class="p">):</span>
</span><span id="calc_correlation_timeseries-1624"><a href="#calc_correlation_timeseries-1624"><span class="linenos">1624</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="calc_correlation_timeseries-1625"><a href="#calc_correlation_timeseries-1625"><span class="linenos">1625</span></a><span class="sd">    Function can be used to calculate timesesries of BC_TH_TS, based on a linear fit between BC_TH_TS and H/C_all, for any TH and TS. </span>
</span><span id="calc_correlation_timeseries-1626"><a href="#calc_correlation_timeseries-1626"><span class="linenos">1626</span></a>
</span><span id="calc_correlation_timeseries-1627"><a href="#calc_correlation_timeseries-1627"><span class="linenos">1627</span></a><span class="sd">    Inputs:</span>
</span><span id="calc_correlation_timeseries-1628"><a href="#calc_correlation_timeseries-1628"><span class="linenos">1628</span></a><span class="sd">    - Ts: a list of values, or a single value provided as a list- soil temperatures to consider</span>
</span><span id="calc_correlation_timeseries-1629"><a href="#calc_correlation_timeseries-1629"><span class="linenos">1629</span></a><span class="sd">    - Th: a list of values, or a single value provided as a list- time points to calculate</span>
</span><span id="calc_correlation_timeseries-1630"><a href="#calc_correlation_timeseries-1630"><span class="linenos">1630</span></a><span class="sd">    - x : a list of values, or a single value provided as a list - variable in metadata to use for correlation (single variable or multiple variable)</span>
</span><span id="calc_correlation_timeseries-1631"><a href="#calc_correlation_timeseries-1631"><span class="linenos">1631</span></a><span class="sd">    - outliers: a list of ID_obs to exclude from analysis</span>
</span><span id="calc_correlation_timeseries-1632"><a href="#calc_correlation_timeseries-1632"><span class="linenos">1632</span></a>
</span><span id="calc_correlation_timeseries-1633"><a href="#calc_correlation_timeseries-1633"><span class="linenos">1633</span></a><span class="sd">    Outputs:</span>
</span><span id="calc_correlation_timeseries-1634"><a href="#calc_correlation_timeseries-1634"><span class="linenos">1634</span></a><span class="sd">    - vX: vector of X variable, for selected observations where data available</span>
</span><span id="calc_correlation_timeseries-1635"><a href="#calc_correlation_timeseries-1635"><span class="linenos">1635</span></a><span class="sd">    - vXnan: list of ID_obs where X variable is NaN</span>
</span><span id="calc_correlation_timeseries-1636"><a href="#calc_correlation_timeseries-1636"><span class="linenos">1636</span></a><span class="sd">    - megaY: dictionnary of calculated Y (BC_TH_TS), where keys are (TS, TH) tuples, and values are the corresponding BC_TH_TS for each observations</span>
</span><span id="calc_correlation_timeseries-1637"><a href="#calc_correlation_timeseries-1637"><span class="linenos">1637</span></a><span class="sd">    - megaYnan: list of ID_obs where Y variable is NaN</span>
</span><span id="calc_correlation_timeseries-1638"><a href="#calc_correlation_timeseries-1638"><span class="linenos">1638</span></a><span class="sd">    - megaCoeffs: for each (TS, TH), coefficients from the linear regression (slope, intercept)</span>
</span><span id="calc_correlation_timeseries-1639"><a href="#calc_correlation_timeseries-1639"><span class="linenos">1639</span></a><span class="sd">    - megaSCoeffs: for each (TS, TH), covariance matrix from the linear regression</span>
</span><span id="calc_correlation_timeseries-1640"><a href="#calc_correlation_timeseries-1640"><span class="linenos">1640</span></a>
</span><span id="calc_correlation_timeseries-1641"><a href="#calc_correlation_timeseries-1641"><span class="linenos">1641</span></a><span class="sd">    Usage: \n</span>
</span><span id="calc_correlation_timeseries-1642"><a href="#calc_correlation_timeseries-1642"><span class="linenos">1642</span></a><span class="sd">        vX, vXnan, megaY, megaYnan, megaCoeffs, megaSCoeffs = calc_correlation_timeseries(fitdata, metadata,</span>
</span><span id="calc_correlation_timeseries-1643"><a href="#calc_correlation_timeseries-1643"><span class="linenos">1643</span></a><span class="sd">                                x = [&#39;H/C_all&#39;], outliers=None, Ts=[10, 15, 20],</span>
</span><span id="calc_correlation_timeseries-1644"><a href="#calc_correlation_timeseries-1644"><span class="linenos">1644</span></a><span class="sd">                                Th=[0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 140, 160, 180, 200],</span>
</span><span id="calc_correlation_timeseries-1645"><a href="#calc_correlation_timeseries-1645"><span class="linenos">1645</span></a><span class="sd">                               )</span>
</span><span id="calc_correlation_timeseries-1646"><a href="#calc_correlation_timeseries-1646"><span class="linenos">1646</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="calc_correlation_timeseries-1647"><a href="#calc_correlation_timeseries-1647"><span class="linenos">1647</span></a>    
</span><span id="calc_correlation_timeseries-1648"><a href="#calc_correlation_timeseries-1648"><span class="linenos">1648</span></a>    <span class="c1"># data preparation</span>
</span><span id="calc_correlation_timeseries-1649"><a href="#calc_correlation_timeseries-1649"><span class="linenos">1649</span></a>    <span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">_align_dataframes</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">outliers</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1650"><a href="#calc_correlation_timeseries-1650"><span class="linenos">1650</span></a>    <span class="c1"># get X columns</span>
</span><span id="calc_correlation_timeseries-1651"><a href="#calc_correlation_timeseries-1651"><span class="linenos">1651</span></a>    <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span> <span class="o">=</span> <span class="n">_retrieveX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1652"><a href="#calc_correlation_timeseries-1652"><span class="linenos">1652</span></a>    
</span><span id="calc_correlation_timeseries-1653"><a href="#calc_correlation_timeseries-1653"><span class="linenos">1653</span></a>    <span class="c1"># calculate Y columns: i.e. calculate BC_Th_Ts &amp; sigmaBC_Th_Ts, and save for range of Ts and Th </span>
</span><span id="calc_correlation_timeseries-1654"><a href="#calc_correlation_timeseries-1654"><span class="linenos">1654</span></a>    <span class="n">megaY</span> <span class="o">=</span> <span class="p">{}</span> 
</span><span id="calc_correlation_timeseries-1655"><a href="#calc_correlation_timeseries-1655"><span class="linenos">1655</span></a>    <span class="n">megaSY</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="calc_correlation_timeseries-1656"><a href="#calc_correlation_timeseries-1656"><span class="linenos">1656</span></a>    <span class="n">megaYnan</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="calc_correlation_timeseries-1657"><a href="#calc_correlation_timeseries-1657"><span class="linenos">1657</span></a>    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="calc_correlation_timeseries-1658"><a href="#calc_correlation_timeseries-1658"><span class="linenos">1658</span></a>        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">Th</span><span class="p">:</span>
</span><span id="calc_correlation_timeseries-1659"><a href="#calc_correlation_timeseries-1659"><span class="linenos">1659</span></a>            <span class="n">megaY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)],</span> <span class="n">megaSY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)],</span> <span class="n">megaYnan</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_calculateY</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">sub_metadata</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1660"><a href="#calc_correlation_timeseries-1660"><span class="linenos">1660</span></a>            
</span><span id="calc_correlation_timeseries-1661"><a href="#calc_correlation_timeseries-1661"><span class="linenos">1661</span></a>    <span class="c1"># perform correlation, for each Ts and Th; and save coefficients &amp; their sigma</span>
</span><span id="calc_correlation_timeseries-1662"><a href="#calc_correlation_timeseries-1662"><span class="linenos">1662</span></a>    <span class="n">megaCoeffs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="calc_correlation_timeseries-1663"><a href="#calc_correlation_timeseries-1663"><span class="linenos">1663</span></a>    <span class="n">megaSCoeffs</span> <span class="o">=</span> <span class="p">{}</span>        
</span><span id="calc_correlation_timeseries-1664"><a href="#calc_correlation_timeseries-1664"><span class="linenos">1664</span></a>    <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="calc_correlation_timeseries-1665"><a href="#calc_correlation_timeseries-1665"><span class="linenos">1665</span></a>        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">Th</span><span class="p">:</span>
</span><span id="calc_correlation_timeseries-1666"><a href="#calc_correlation_timeseries-1666"><span class="linenos">1666</span></a>            <span class="c1"># Remove any mutual observation with nan values</span>
</span><span id="calc_correlation_timeseries-1667"><a href="#calc_correlation_timeseries-1667"><span class="linenos">1667</span></a>            <span class="n">vXYnan</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vXnan</span> <span class="o">+</span> <span class="n">megaYnan</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)])</span>
</span><span id="calc_correlation_timeseries-1668"><a href="#calc_correlation_timeseries-1668"><span class="linenos">1668</span></a>            <span class="n">cvX</span> <span class="o">=</span> <span class="n">vX</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1669"><a href="#calc_correlation_timeseries-1669"><span class="linenos">1669</span></a>            <span class="n">cvY</span> <span class="o">=</span> <span class="n">megaY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1670"><a href="#calc_correlation_timeseries-1670"><span class="linenos">1670</span></a>            <span class="n">sigvY</span> <span class="o">=</span> <span class="n">megaSY</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">vXYnan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># removing irrelevant observations, as in vX, vY</span>
</span><span id="calc_correlation_timeseries-1671"><a href="#calc_correlation_timeseries-1671"><span class="linenos">1671</span></a>            <span class="n">sigvY</span> <span class="o">=</span> <span class="n">sigvY</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remainin nan, where uncertainty could not be calculated for some reason, replaced by 0</span>
</span><span id="calc_correlation_timeseries-1672"><a href="#calc_correlation_timeseries-1672"><span class="linenos">1672</span></a>            <span class="c1"># Do the fit</span>
</span><span id="calc_correlation_timeseries-1673"><a href="#calc_correlation_timeseries-1673"><span class="linenos">1673</span></a>            <span class="n">p_opt1</span><span class="p">,</span> <span class="n">p_cov1</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">cvX</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">cvY</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="calc_correlation_timeseries-1674"><a href="#calc_correlation_timeseries-1674"><span class="linenos">1674</span></a>            <span class="c1"># Save the fit</span>
</span><span id="calc_correlation_timeseries-1675"><a href="#calc_correlation_timeseries-1675"><span class="linenos">1675</span></a>            <span class="n">megaCoeffs</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_opt1</span>
</span><span id="calc_correlation_timeseries-1676"><a href="#calc_correlation_timeseries-1676"><span class="linenos">1676</span></a>            <span class="n">megaSCoeffs</span><span class="p">[(</span><span class="n">ts</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p_cov1</span>
</span><span id="calc_correlation_timeseries-1677"><a href="#calc_correlation_timeseries-1677"><span class="linenos">1677</span></a>            
</span><span id="calc_correlation_timeseries-1678"><a href="#calc_correlation_timeseries-1678"><span class="linenos">1678</span></a>    <span class="c1"># return array of BC_Th_Ts, sigmaBC_Th_Ts, coefficients &amp; sigma, for each Ts &amp; Th</span>
</span><span id="calc_correlation_timeseries-1679"><a href="#calc_correlation_timeseries-1679"><span class="linenos">1679</span></a>    <span class="c1"># second function: plot all the lines. </span>
</span><span id="calc_correlation_timeseries-1680"><a href="#calc_correlation_timeseries-1680"><span class="linenos">1680</span></a>    <span class="k">return</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span><span class="p">,</span> <span class="n">megaY</span><span class="p">,</span> <span class="n">megaYnan</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">,</span> <span class="n">megaSCoeffs</span>
</span></pre></div>


            <div class="docstring"><p>Function can be used to calculate timesesries of BC_TH_TS, based on a linear fit between BC_TH_TS and H/C_all, for any TH and TS. </p>

<p>Inputs:</p>

<ul>
<li>Ts: a list of values, or a single value provided as a list- soil temperatures to consider</li>
<li>Th: a list of values, or a single value provided as a list- time points to calculate</li>
<li>x : a list of values, or a single value provided as a list - variable in metadata to use for correlation (single variable or multiple variable)</li>
<li>outliers: a list of ID_obs to exclude from analysis</li>
</ul>

<p>Outputs:</p>

<ul>
<li>vX: vector of X variable, for selected observations where data available</li>
<li>vXnan: list of ID_obs where X variable is NaN</li>
<li>megaY: dictionnary of calculated Y (BC_TH_TS), where keys are (TS, TH) tuples, and values are the corresponding BC_TH_TS for each observations</li>
<li>megaYnan: list of ID_obs where Y variable is NaN</li>
<li>megaCoeffs: for each (TS, TH), coefficients from the linear regression (slope, intercept)</li>
<li>megaSCoeffs: for each (TS, TH), covariance matrix from the linear regression</li>
</ul>

<p>Usage: </p>

<pre><code>vX, vXnan, megaY, megaYnan, megaCoeffs, megaSCoeffs = calc_correlation_timeseries(fitdata, metadata,
                        x = ['H/C_all'], outliers=None, Ts=[10, 15, 20],
                        Th=[0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 140, 160, 180, 200],
                       )
</code></pre>
</div>


                </section>
                <section id="plot_correlation_timeseries">
                            <input id="plot_correlation_timeseries-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_correlation_timeseries</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">fitdata</span>,</span><span class="param">	<span class="n">metadata</span>,</span><span class="param">	<span class="n">x</span>,</span><span class="param">	<span class="n">Ts</span>,</span><span class="param">	<span class="n">Th</span>,</span><span class="param">	<span class="n">vX</span>,</span><span class="param">	<span class="n">vXnan</span>,</span><span class="param">	<span class="n">megaY</span>,</span><span class="param">	<span class="n">megaYnan</span>,</span><span class="param">	<span class="n">megaCoeffs</span>,</span><span class="param">	<span class="n">megaSCoeffs</span>,</span><span class="param">	<span class="n">fig</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ax</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">TH_lim</span><span class="o">=</span><span class="mi">1000</span></span>)</span>

                <label class="view-source-button" for="plot_correlation_timeseries-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_correlation_timeseries"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_correlation_timeseries-1690"><a href="#plot_correlation_timeseries-1690"><span class="linenos">1690</span></a><span class="k">def</span> <span class="nf">plot_correlation_timeseries</span><span class="p">(</span><span class="n">fitdata</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span>
</span><span id="plot_correlation_timeseries-1691"><a href="#plot_correlation_timeseries-1691"><span class="linenos">1691</span></a>                                <span class="n">vX</span><span class="p">,</span> <span class="n">vXnan</span><span class="p">,</span> <span class="n">megaY</span><span class="p">,</span> <span class="n">megaYnan</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">,</span> <span class="n">megaSCoeffs</span><span class="p">,</span>
</span><span id="plot_correlation_timeseries-1692"><a href="#plot_correlation_timeseries-1692"><span class="linenos">1692</span></a>                                <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">TH_lim</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="plot_correlation_timeseries-1693"><a href="#plot_correlation_timeseries-1693"><span class="linenos">1693</span></a>                               <span class="p">):</span>
</span><span id="plot_correlation_timeseries-1694"><a href="#plot_correlation_timeseries-1694"><span class="linenos">1694</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="plot_correlation_timeseries-1695"><a href="#plot_correlation_timeseries-1695"><span class="linenos">1695</span></a><span class="sd">    Plot the results computed via `calc_correlation_timeseries`.</span>
</span><span id="plot_correlation_timeseries-1696"><a href="#plot_correlation_timeseries-1696"><span class="linenos">1696</span></a><span class="sd">    </span>
</span><span id="plot_correlation_timeseries-1697"><a href="#plot_correlation_timeseries-1697"><span class="linenos">1697</span></a><span class="sd">    Inputs:</span>
</span><span id="plot_correlation_timeseries-1698"><a href="#plot_correlation_timeseries-1698"><span class="linenos">1698</span></a><span class="sd">    - x = values of X that need to be plotted, as a list // if multiple variables; should be a dictionnary of key:[values]</span>
</span><span id="plot_correlation_timeseries-1699"><a href="#plot_correlation_timeseries-1699"><span class="linenos">1699</span></a>
</span><span id="plot_correlation_timeseries-1700"><a href="#plot_correlation_timeseries-1700"><span class="linenos">1700</span></a><span class="sd">    Outputs:</span>
</span><span id="plot_correlation_timeseries-1701"><a href="#plot_correlation_timeseries-1701"><span class="linenos">1701</span></a><span class="sd">    - fig, ax</span>
</span><span id="plot_correlation_timeseries-1702"><a href="#plot_correlation_timeseries-1702"><span class="linenos">1702</span></a>
</span><span id="plot_correlation_timeseries-1703"><a href="#plot_correlation_timeseries-1703"><span class="linenos">1703</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="plot_correlation_timeseries-1704"><a href="#plot_correlation_timeseries-1704"><span class="linenos">1704</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="plot_correlation_timeseries-1705"><a href="#plot_correlation_timeseries-1705"><span class="linenos">1705</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span><span id="plot_correlation_timeseries-1706"><a href="#plot_correlation_timeseries-1706"><span class="linenos">1706</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
</span><span id="plot_correlation_timeseries-1707"><a href="#plot_correlation_timeseries-1707"><span class="linenos">1707</span></a>    <span class="c1"># reconstruct the lines, for each H/C_all values, at given Ts</span>
</span><span id="plot_correlation_timeseries-1708"><a href="#plot_correlation_timeseries-1708"><span class="linenos">1708</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span> 
</span><span id="plot_correlation_timeseries-1709"><a href="#plot_correlation_timeseries-1709"><span class="linenos">1709</span></a>        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">Ts</span><span class="p">:</span>
</span><span id="plot_correlation_timeseries-1710"><a href="#plot_correlation_timeseries-1710"><span class="linenos">1710</span></a>            <span class="n">BC</span> <span class="o">=</span> <span class="n">_rebuild_timeseries</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Th</span><span class="p">,</span> <span class="n">megaCoeffs</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1711"><a href="#plot_correlation_timeseries-1711"><span class="linenos">1711</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Th</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;H/C: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
</span><span id="plot_correlation_timeseries-1712"><a href="#plot_correlation_timeseries-1712"><span class="linenos">1712</span></a>    <span class="c1">#ax.plot(Th, Th)</span>
</span><span id="plot_correlation_timeseries-1713"><a href="#plot_correlation_timeseries-1713"><span class="linenos">1713</span></a>    
</span><span id="plot_correlation_timeseries-1714"><a href="#plot_correlation_timeseries-1714"><span class="linenos">1714</span></a>    <span class="c1"># styling    </span>
</span><span id="plot_correlation_timeseries-1715"><a href="#plot_correlation_timeseries-1715"><span class="linenos">1715</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">100</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
</span><span id="plot_correlation_timeseries-1716"><a href="#plot_correlation_timeseries-1716"><span class="linenos">1716</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Biochar C remaining (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1717"><a href="#plot_correlation_timeseries-1717"><span class="linenos">1717</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">TH_lim</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
</span><span id="plot_correlation_timeseries-1718"><a href="#plot_correlation_timeseries-1718"><span class="linenos">1718</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (years)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1719"><a href="#plot_correlation_timeseries-1719"><span class="linenos">1719</span></a>    
</span><span id="plot_correlation_timeseries-1720"><a href="#plot_correlation_timeseries-1720"><span class="linenos">1720</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1721"><a href="#plot_correlation_timeseries-1721"><span class="linenos">1721</span></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Modelled timeseries as a function of H/C ratio and soil temperature&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1722"><a href="#plot_correlation_timeseries-1722"><span class="linenos">1722</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="plot_correlation_timeseries-1723"><a href="#plot_correlation_timeseries-1723"><span class="linenos">1723</span></a>
</span><span id="plot_correlation_timeseries-1724"><a href="#plot_correlation_timeseries-1724"><span class="linenos">1724</span></a>    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</span></pre></div>


            <div class="docstring"><p>Plot the results computed via <code><a href="#calc_correlation_timeseries">calc_correlation_timeseries</a></code>.</p>

<p>Inputs:</p>

<ul>
<li>x = values of X that need to be plotted, as a list // if multiple variables; should be a dictionnary of key:[values]</li>
</ul>

<p>Outputs:</p>

<ul>
<li>fig, ax</li>
</ul>
</div>


                </section>
                <section id="pick_model">
                            <input id="pick_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pick_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">k</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">sets</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">Y</span></span>)</span>

                <label class="view-source-button" for="pick_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pick_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pick_model-1726"><a href="#pick_model-1726"><span class="linenos">1726</span></a><span class="k">def</span> <span class="nf">pick_model</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">sets</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span id="pick_model-1727"><a href="#pick_model-1727"><span class="linenos">1727</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="pick_model-1728"><a href="#pick_model-1728"><span class="linenos">1728</span></a><span class="sd">    Pick the a random forest model `k` from `df` and re-trains it with its optimal parameters, on the data set (X,Y).</span>
</span><span id="pick_model-1729"><a href="#pick_model-1729"><span class="linenos">1729</span></a>
</span><span id="pick_model-1730"><a href="#pick_model-1730"><span class="linenos">1730</span></a><span class="sd">    - k: row index of the model in the dataframe df, corresponding also to set index in dictionary sets</span>
</span><span id="pick_model-1731"><a href="#pick_model-1731"><span class="linenos">1731</span></a><span class="sd">    - df: df containing the model optimal parameters, as well as r2, r2a, features</span>
</span><span id="pick_model-1732"><a href="#pick_model-1732"><span class="linenos">1732</span></a><span class="sd">    - sets: dictionnary of sets </span>
</span><span id="pick_model-1733"><a href="#pick_model-1733"><span class="linenos">1733</span></a><span class="sd">    - X, Y: the training data/target</span>
</span><span id="pick_model-1734"><a href="#pick_model-1734"><span class="linenos">1734</span></a>
</span><span id="pick_model-1735"><a href="#pick_model-1735"><span class="linenos">1735</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="pick_model-1736"><a href="#pick_model-1736"><span class="linenos">1736</span></a>    <span class="n">mp</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;randomforestregressor__&quot;</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,:][</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="pick_model-1737"><a href="#pick_model-1737"><span class="linenos">1737</span></a>
</span><span id="pick_model-1738"><a href="#pick_model-1738"><span class="linenos">1738</span></a>    <span class="c1"># feature selection, normalisation, one-hot encoding</span>
</span><span id="pick_model-1739"><a href="#pick_model-1739"><span class="linenos">1739</span></a>    <span class="n">fX</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
</span><span id="pick_model-1740"><a href="#pick_model-1740"><span class="linenos">1740</span></a>    <span class="n">fY</span> <span class="o">=</span> <span class="n">Y</span>
</span><span id="pick_model-1741"><a href="#pick_model-1741"><span class="linenos">1741</span></a>
</span><span id="pick_model-1742"><a href="#pick_model-1742"><span class="linenos">1742</span></a>    <span class="n">numerical_columns_selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">(</span><span class="n">dtype_exclude</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="pick_model-1743"><a href="#pick_model-1743"><span class="linenos">1743</span></a>    <span class="n">categorical_columns_selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="pick_model-1744"><a href="#pick_model-1744"><span class="linenos">1744</span></a>    <span class="n">numerical_columns</span> <span class="o">=</span> <span class="n">numerical_columns_selector</span><span class="p">(</span><span class="n">fX</span><span class="p">)</span>
</span><span id="pick_model-1745"><a href="#pick_model-1745"><span class="linenos">1745</span></a>    <span class="n">categorical_columns</span> <span class="o">=</span> <span class="n">categorical_columns_selector</span><span class="p">(</span><span class="n">fX</span><span class="p">)</span>
</span><span id="pick_model-1746"><a href="#pick_model-1746"><span class="linenos">1746</span></a>    <span class="n">categorical_preprocessor</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="c1"># Here, could do a LabelEncoder() as well</span>
</span><span id="pick_model-1747"><a href="#pick_model-1747"><span class="linenos">1747</span></a>    <span class="n">numerical_preprocessor</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span> <span class="c1">#StandardScaler() # RobustScaler() can also do robustscaler, dealing with outliers differently</span>
</span><span id="pick_model-1748"><a href="#pick_model-1748"><span class="linenos">1748</span></a>    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">([</span>
</span><span id="pick_model-1749"><a href="#pick_model-1749"><span class="linenos">1749</span></a>        <span class="p">(</span><span class="s1">&#39;one-hot-encoder&#39;</span><span class="p">,</span> <span class="n">categorical_preprocessor</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">),</span>
</span><span id="pick_model-1750"><a href="#pick_model-1750"><span class="linenos">1750</span></a>        <span class="p">(</span><span class="s1">&#39;standard_scaler&#39;</span><span class="p">,</span> <span class="n">numerical_preprocessor</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">)])</span>
</span><span id="pick_model-1751"><a href="#pick_model-1751"><span class="linenos">1751</span></a>
</span><span id="pick_model-1752"><a href="#pick_model-1752"><span class="linenos">1752</span></a>    <span class="n">pipeRF</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">mp</span><span class="p">))</span>
</span><span id="pick_model-1753"><a href="#pick_model-1753"><span class="linenos">1753</span></a>    <span class="n">pipeRF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fX</span><span class="p">,</span> <span class="n">fY</span><span class="p">)</span>
</span><span id="pick_model-1754"><a href="#pick_model-1754"><span class="linenos">1754</span></a>    <span class="k">return</span> <span class="n">pipeRF</span>
</span></pre></div>


            <div class="docstring"><p>Pick the a random forest model <code>k</code> from <code>df</code> and re-trains it with its optimal parameters, on the data set (X,Y).</p>

<ul>
<li>k: row index of the model in the dataframe df, corresponding also to set index in dictionary sets</li>
<li>df: df containing the model optimal parameters, as well as r2, r2a, features</li>
<li>sets: dictionnary of sets </li>
<li>X, Y: the training data/target</li>
</ul>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>